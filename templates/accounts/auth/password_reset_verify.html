{% extends "layouts/base.html" %}
{% block content %}

<section style="max-width:480px;margin:20px auto;">
  <div class="card-surface" style="padding:20px;">

    <h1 class="title is-4">Set New Password</h1>

    {% if error %}
      <div class="notification is-danger">
        {{ error }}
      </div>
    {% endif %}

    {% if expires_in is not None %}
      <p id="otp-timer" class="has-text-grey mb-3">
        OTP expires in <strong></strong>
      </p>
    {% endif %}

    <form method="post" id="reset-form">
      {% csrf_token %}

      <!-- OTP -->
      <input
        class="input mb-2"
        name="otp"
        id="otp-input"
        placeholder="Enter 6-digit OTP"
        required
        inputmode="numeric"
        pattern="[0-9]{6}"
        maxlength="6"
        autofocus
      >

      <!-- New Password -->
      <input
        class="input mb-2"
        type="password"
        name="password"
        placeholder="New password"
        required
      >

      <!-- Confirm Password -->
      <input
        class="input"
        type="password"
        name="confirm_password"
        placeholder="Confirm password"
        required
      >

      <button
        class="button is-primary mt-3"
        type="submit"
        id="reset-btn"
      >
        Reset Password
      </button>
    </form>

    <p id="otp-expired-msg"
       class="has-text-danger mt-3 is-hidden">
      OTP has expired.
      <a href="{% url 'accounts:password-reset-request' %}">
        Request a new password reset.
      </a>
    </p>

  </div>
</section>

{% if expires_in is not None %}
<script>
(function () {
  let remaining = {{ expires_in }};
  const timerEl = document.querySelector("#otp-timer strong");
  const expiredMsg = document.getElementById("otp-expired-msg");
  const otpInput = document.getElementById("otp-input");
  const resetBtn = document.getElementById("reset-btn");

  function formatTime(s) {
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return `${m}:${sec.toString().padStart(2, "0")}`;
  }

  function expire() {
    timerEl.textContent = "00:00";
    expiredMsg.classList.remove("is-hidden");
    otpInput.disabled = true;
    resetBtn.disabled = true;
    resetBtn.classList.add("is-light");
  }

  function tick() {
    if (remaining <= 0) {
      expire();
      return;
    }
    timerEl.textContent = formatTime(remaining);
    remaining--;
    setTimeout(tick, 1000);
  }

  tick();
})();
</script>
{% endif %}

{% endblock %}
