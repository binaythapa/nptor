{% extends "layouts/student/base.html" %}
{% block content %}

<section style="max-width:420px;margin:20px auto;">
  <div class="card-surface" style="padding:20px;">

    <h1 class="title is-4">Verify Email</h1>

    {% if error %}
      <div class="notification is-danger">
        {{ error }}
      </div>
    {% endif %}

    {% if expires_in is not None %}
      <p id="otp-timer" class="has-text-grey mb-3">
        OTP expires in <strong></strong>
      </p>
    {% endif %}

    <form method="post" id="otp-form">
      {% csrf_token %}

      <input
        class="input"
        name="otp"
        id="otp-input"
        placeholder="Enter 6-digit OTP"
        required
        autofocus
        inputmode="numeric"
        pattern="[0-9]{6}"
        maxlength="6"
      >

      <button
        class="button is-primary mt-3"
        type="submit"
        id="verify-btn"
      >
        Verify
      </button>
    </form>

    <p id="otp-expired-msg"
       class="has-text-danger mt-3 is-hidden">
      OTP has expired.
      <a href="{% url 'accounts:register' %}">
        Please register again.
      </a>
    </p>

  </div>
</section>

{% if expires_in is not None %}
<script>
(function () {
  let remaining = {{ expires_in }};
  const timerEl = document.querySelector("#otp-timer strong");
  const expiredMsg = document.getElementById("otp-expired-msg");
  const otpInput = document.getElementById("otp-input");
  const verifyBtn = document.getElementById("verify-btn");

  function formatTime(s) {
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return `${m}:${sec.toString().padStart(2, "0")}`;
  }

  function expire() {
    timerEl.textContent = "00:00";
    expiredMsg.classList.remove("is-hidden");
    otpInput.disabled = true;
    verifyBtn.disabled = true;
    verifyBtn.classList.add("is-light");
  }

  function tick() {
    if (remaining <= 0) {
      expire();
      return;
    }
    timerEl.textContent = formatTime(remaining);
    remaining--;
    setTimeout(tick, 1000);
  }

  tick();
})();
</script>
{% endif %}

{% endblock %}
