{% extends "quiz/base.html" %}
{% block title %}Practice{% endblock %}

{% block head_extra %}
<style>
.practice-wrapper {
  width: 100%;
  display: flex;
  justify-content: center;
  padding: 24px 16px;
}
.practice-card {
  width: 100%;
  max-width: 440px;
}
.practice-option {
  display: block;
  padding: 10px 12px;
  border-radius: 6px;
  margin-bottom: 8px;
  border: 1px solid #e5e7eb;
  cursor: pointer;
}
.practice-option:hover { background: #f9fafb; }
.practice-option.correct {
  background: #ecfdf5;
  border-color: #34d399;
}
.practice-option.wrong {
  background: #fef2f2;
  border-color: #f87171;
}
</style>
{% endblock %}

{% block content %}
<div class="practice-wrapper">
<div class="practice-card box">

<!-- ================= HEADER ================= -->
<div class="is-flex is-align-items-center is-justify-content-space-between mb-3">
  <h1 class="title is-4 mb-0">Practice Question</h1>
  <div>
    <a href="{% url 'quiz:practice_express' %}">Express</a>
    <span class="mx-1">|</span>
    <a href="{% url 'quiz:exam_list' %}">Pro</a>
  </div>
</div>

<!-- ================= PROGRESS ================= -->
<div class="mb-3">
  <progress class="progress is-small is-primary"
            value="{{ progress_done }}"
            max="{{ progress_total }}"></progress>
  <p class="has-text-grey is-size-7">
    Progress: {{ progress_done }} / {{ progress_total }}
  </p>
</div>

<!-- ================= FILTERS ================= -->
<form method="get" class="mb-4">
  <div class="columns is-mobile is-multiline">
    <div class="column is-one-third">
      <div class="select is-small is-fullwidth">
        <select name="domain" onchange="this.form.submit()">
          <option value="">All domains</option>
          {% for d in domains %}
            <option value="{{ d.id }}"
              {% if d.id|stringformat:"s" == domain_id %}selected{% endif %}>
              {{ d.name }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="column is-one-third">
      <div class="select is-small is-fullwidth">
        <select name="category" onchange="this.form.submit()"
                {% if not domain_id %}disabled{% endif %}>
          <option value="">All categories</option>
          {% for cat in categories %}
            {% if not cat.parent %}
              <option value="{{ cat.id }}"
                {% if cat.id|stringformat:"s" == category_id %}selected{% endif %}>
                {{ cat.name }}
              </option>
              {% for child in cat.children.all %}
                <option value="{{ child.id }}"
                  {% if child.id|stringformat:"s" == category_id %}selected{% endif %}>
                  &nbsp;&nbsp;‚Ü≥ {{ child.name }}
                </option>
              {% endfor %}
            {% endif %}
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="column is-one-third">
      <div class="select is-small is-fullwidth">
        <select name="difficulty" onchange="this.form.submit()">
          <option value="">All difficulties</option>
          {% for value, label in difficulty_choices %}
            <option value="{{ value }}"
              {% if value == difficulty %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
</form>

<!-- ================= QUESTION ================= -->
{% if question %}
<form method="post">
{% csrf_token %}

{% if domain_id %}<input type="hidden" name="domain" value="{{ domain_id }}">{% endif %}
{% if category_id %}<input type="hidden" name="category" value="{{ category_id }}">{% endif %}
{% if difficulty %}<input type="hidden" name="difficulty" value="{{ difficulty }}">{% endif %}

<p class="mb-4"><strong>{{ question.text }}</strong></p>

{% if question.question_type != "multi" %}
  {% for c in choices %}
  <label class="practice-option
    {% if result and c.is_correct %}correct{% endif %}
    {% if result == 'wrong' and c.id|stringformat:'s' == selected_choice_id %}wrong{% endif %}">
    <input type="radio" name="choice" value="{{ c.id }}"
           {% if c.id|stringformat:'s' == selected_choice_id %}checked{% endif %}
           {% if show_next %}disabled{% endif %} required>
    {{ c.text }}
  </label>
  {% endfor %}
{% endif %}

{% if question.question_type == "multi" %}
  {% for c in choices %}
  <label class="practice-option
    {% if result and c.is_correct %}correct{% endif %}
    {% if result == 'wrong' and c.id in selected_multi_ids %}wrong{% endif %}">
    <input type="checkbox" name="choice_multi" value="{{ c.id }}"
           {% if c.id in selected_multi_ids %}checked{% endif %}
           {% if show_next %}disabled{% endif %}>
    {{ c.text }}
  </label>
  {% endfor %}
{% endif %}

{% if result == "correct" %}
<div class="notification is-success mt-3">‚úÖ Correct!</div>
{% elif result == "wrong" %}
<div class="notification is-danger mt-3">‚ùå Incorrect</div>

{% if explanation %}
<button type="button" class="button is-small is-info mt-2"
        onclick="toggleExplanation()" id="explanationToggleBtn">
  üìò Show Explanation
</button>

<div id="explanationBox" class="notification is-info mt-3"
     style="display:none;">
  {{ explanation|linebreaks }}
</div>
{% endif %}
{% endif %}

<div class="mt-4 is-flex is-justify-content-space-between">
  {% if show_next %}
    <button class="button is-link" name="next" value="1">Next ‚Üí</button>
  {% else %}
    <button class="button is-primary">Submit</button>
  {% endif %}
  <a href="{% url 'quiz:practice' %}?reset=1" class="button is-light">üîÑ Reset</a>
</div>

</form>

<!-- ================= USER FEEDBACK (AJAX) ================= -->
{% if user.is_authenticated %}
<hr class="my-4">

<div id="feedbackBox" class="box is-light">
{% if feedback_submitted %}
  <div class="notification is-success is-light">
    ‚úÖ Feedback already submitted. Thanks!
  </div>
{% else %}
  <p class="has-text-weight-semibold mb-2">üó£Ô∏è Feedback</p>

  <button type="button" id="flagBtn"
          class="button is-small"
          onclick="toggleFlag()">‚ö†Ô∏è Incorrect / Confusing</button>

  <input type="hidden" id="answerIncorrect">

  <div class="field mt-2">
    <textarea id="studentComment"
              class="textarea is-small"
              rows="2"
              placeholder="Optional comment..."></textarea>
  </div>

  <button class="button is-small is-link mt-2"
          onclick="submitFeedback()">Submit Feedback</button>
{% endif %}
</div>
{% endif %}

{% endif %}
</div>
</div>

<script>
function toggleExplanation() {
  const box = document.getElementById("explanationBox");
  const btn = document.getElementById("explanationToggleBtn");
  if (!box || !btn) return;
  box.style.display = box.style.display === "none" ? "block" : "none";
  btn.innerText = box.style.display === "block"
    ? "üìò Hide Explanation"
    : "üìò Show Explanation";
}

let flagged = false;
function toggleFlag() {
  flagged = !flagged;
  document.getElementById("flagBtn")
    .classList.toggle("is-warning", flagged);
  document.getElementById("answerIncorrect").value = flagged ? "1" : "";
}

function submitFeedback() {
  const data = new FormData();
  data.append("feedback_submit", "1");
  data.append("student_comment",
              document.getElementById("studentComment").value);
  if (flagged) data.append("answer_incorrect", "1");
  data.append("csrfmiddlewaretoken", "{{ csrf_token }}");

  fetch(window.location.href, { method: "POST", body: data })
    .then(() => {
      document.getElementById("feedbackBox").innerHTML =
        `<div class="notification is-success is-light">
          ‚úÖ Feedback already submitted. Thanks!
        </div>`;
    });
}
</script>

{% endblock %}
