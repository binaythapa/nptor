{% extends "quiz/base.html" %}
{% load static %}

{% block title %}Practice Express{% endblock %}

{% block content %}
<div class="box">

  <div class="is-flex is-align-items-center is-justify-content-space-between mb-3">
  <h1 class="title is-4 mb-0">
    Practice Question
  </h1>

  <div class="practice-modes">
    <a href="{% url 'quiz:practice' %}" class="practice-link">
      Basics
    </a>
    <span class="mx-1 has-text-grey">|</span>
    <a href="{% url 'quiz:exam_list' %}" class="practice-link">
      Pro
    </a>
  </div>
</div>


  {% if not user.is_authenticated %}
    <div class="notification is-info is-light">
      Login to save accuracy, stats, and streaks.
    </div>
  {% endif %}

  <!-- Filters -->
  <div class="columns mb-4">
    <div class="column is-6">
      <div class="select is-fullwidth">
        <select id="difficultySelect">
          <option value="">All difficulties</option>
          {% for k,l in difficulty_choices %}
            <option value="{{ k }}">{{ l }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="column is-6">
      <div class="select is-fullwidth">
        <select id="categorySelect">
          <option value="">All categories</option>
          {% for c in categories %}
            <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <!-- Stats + Timer -->
  <div class="level">
    <div class="level-left">
      <div>
        <p><strong>Matched:</strong> <span id="matched">0</span> / <span id="total">0</span></p>
        <p><strong>Accuracy:</strong> <span id="accuracy">0%</span></p>
      </div>
    </div>

    <div class="level-right">
      <span id="timerBadge" class="tag is-warning is-light">
        ⏱ <span id="timer">30</span>s
      </span>
    </div>
  </div>

</div>

<!-- Question Card -->
<div class="box">

  <p id="qText" class="mb-4 has-text-weight-semibold">Loading…</p>

  <form onsubmit="submitAnswer(); return false;">
    <div id="choices" class="mb-4"></div>

    <button type="submit" class="button is-success">
      Submit (Enter)
    </button>
  </form>

  <div id="feedback" class="notification is-hidden mt-4"></div>

  <div id="explain" class="mt-3" style="display:none;">
    <details>
      <summary>Explanation</summary>
      <div id="explainText" class="content mt-2"></div>
    </details>
  </div>

</div>

<script>
let qid = null;
let correctChoice = null;
let matched = 0;
let total = 0;

/* ==========================
   TIMER
========================== */
let timer = null;
let timeLeft = 30;
let autoSubmitted = false;

function startTimer(){
  clearInterval(timer);
  timeLeft = 30;
  autoSubmitted = false;
  document.getElementById("timer").innerText = timeLeft;

  timer = setInterval(() => {
    timeLeft--;
    document.getElementById("timer").innerText = timeLeft;

    if(timeLeft <= 0){
      clearInterval(timer);
      autoSubmit();
    }
  }, 1000);
}

function autoSubmit(){
  if(autoSubmitted) return;
  autoSubmitted = true;

  const selected =
    document.querySelector('input[name="ans"]:checked');

  total++;
  document.getElementById("total").innerText = total;

  if(!selected){
    document.getElementById("feedback").className =
      "notification is-danger mt-4";
    document.getElementById("feedback").innerText =
      "⏰ Time up! Correct answer highlighted.";

    const correctRadio =
      document.querySelector(`input[value="${correctChoice}"]`);
    if(correctRadio){
      correctRadio.closest("label").classList.add("has-text-success");
    }

    document.getElementById("accuracy").innerText =
      matched === 0 ? "0%" : Math.round((matched/total)*100) + "%";

    setTimeout(loadQuestion, 1200);
    return;
  }

  submitAnswer();
}

/* ==========================
   LOAD QUESTION
========================== */
function loadQuestion(){
  clearInterval(timer);

  const params = new URLSearchParams();
  if(categorySelect.value) params.append("category", categorySelect.value);
  if(difficultySelect.value) params.append("difficulty", difficultySelect.value);

  fetch("{% url 'quiz:practice_express_next' %}?" + params.toString())
    .then(r => r.json())
    .then(d => {
      if(d.empty){
        qText.innerText = "No questions available.";
        choices.innerHTML = "";
        return;
      }

      qid = d.id;
      correctChoice = d.correct_choice;

      qText.innerText = d.text;
      choices.innerHTML = "";
      feedback.classList.add("is-hidden");
      explain.style.display = "none";
      explainText.innerHTML = d.explanation || "";

      d.choices.forEach(c => {
        choices.insertAdjacentHTML("beforeend", `
          <label class="radio block mb-2">
            <input type="radio" name="ans" value="${c.id}">
            ${c.text}
          </label>
        `);
      });

      startTimer();
    });
}

/* ==========================
   SUBMIT ANSWER
========================== */
function submitAnswer(){
  clearInterval(timer);

  const sel = document.querySelector('input[name="ans"]:checked');
  if(!sel){
    alert("Please select an option");
    return;
  }

  total++;
  document.getElementById("total").innerText = total;

  const isCorrect =
    parseInt(sel.value, 10) === parseInt(correctChoice, 10);

  // Save stats (logged-in users)
  fetch("{% url 'quiz:practice_express_save' %}",{
    method:"POST",
    headers:{
      "X-CSRFToken":"{{ csrf_token }}",
      "Content-Type":"application/x-www-form-urlencoded"
    },
    body:new URLSearchParams({
      question_id: qid,
      is_correct: isCorrect
    })
  });

  const fb = document.getElementById("feedback");
  fb.classList.remove("is-hidden","is-success","is-danger");

  if(isCorrect){
    matched++;
    fb.classList.add("is-success");
    fb.innerText = "✅ Correct!";
  } else {
    fb.classList.add("is-danger");
    fb.innerText = "❌ Incorrect. Correct answer highlighted.";

    const correctRadio =
      document.querySelector(`input[value="${correctChoice}"]`);
    if(correctRadio){
      correctRadio.closest("label").classList.add("has-text-success");
    }
  }

  document.getElementById("matched").innerText = matched;
  document.getElementById("accuracy").innerText =
    Math.round((matched/total)*100) + "%";

  explain.style.display = "block";

  setTimeout(loadQuestion, 1200);
}

/* ==========================
   EVENTS
========================== */
categorySelect.onchange = loadQuestion;
difficultySelect.onchange = loadQuestion;

document.addEventListener("keydown", e => {
  if(e.key === "Enter"){
    submitAnswer();
  }
});

/* ==========================
   INIT
========================== */
loadQuestion();
</script>

{% endblock %}
