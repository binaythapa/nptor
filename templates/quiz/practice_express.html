{% extends "quiz/base.html" %}
{% load static %}

{% block title %}Practice Express{% endblock %}

{% block content %}

<div class="box">

  <!-- HEADER -->
  <div class="is-flex is-align-items-center is-justify-content-space-between mb-3">
    <h1 class="title is-4 mb-0">Practice Express</h1>

    <div class="practice-modes">
      <a href="{% url 'quiz:practice' %}" class="practice-link">Basics</a>
      <span class="mx-1 has-text-grey">|</span>
      <a href="{% url 'quiz:exam_list' %}" class="practice-link">Pro</a>
    </div>
  </div>

  {% if not user.is_authenticated %}
    <div class="notification is-info is-light">
      Free users have limited questions. Login to unlock unlimited access.
    </div>
  {% endif %}

  <!-- FILTERS -->
  <div class="columns mb-4">

    <!-- DOMAIN -->
    <div class="column is-4">
      <div class="select is-fullwidth">
        <select id="domainSelect">
          <option value="">All domains</option>
          {% for d in domains %}
            <option value="{{ d.id }}">{{ d.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- CATEGORY -->
    <div class="column is-4">
      <div class="select is-fullwidth">
        <select id="categorySelect" disabled>
          <option value="">All categories</option>
        </select>
      </div>
    </div>

    <!-- DIFFICULTY -->
    <div class="column is-4">
      <div class="select is-fullwidth">
        <select id="difficultySelect">
          <option value="">All difficulties</option>
          {% for k,l in difficulty_choices %}
            <option value="{{ k }}">{{ l }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

  </div>

  <!-- STATS -->
  <div class="level">
    <div class="level-left">
      <div>
        <p>
          <strong>Matched:</strong>
          <span id="matched">0</span> /
          <span id="total">0</span>
        </p>

        <p><strong>Accuracy:</strong> <span id="accuracy">0%</span></p>

        <p class="is-size-7 has-text-grey">
          Progress:
          <span id="pDone">0</span> /
          <span id="pTotal">0</span>
        </p>

        <progress id="pBar"
                  class="progress is-small is-link"
                  value="0"
                  max="0"></progress>
      </div>
    </div>

    <div class="level-right is-flex is-align-items-center">
      <span class="tag is-warning is-light mr-3">
        ‚è± <span id="timer">30</span>s
      </span>
      <button id="resetBtn" class="button is-small is-light">
        üîÑ Restart
      </button>
    </div>
  </div>

</div>

<!-- QUESTION CARD -->
<div class="box">
  <p id="qText" class="mb-4 has-text-weight-semibold">Loading‚Ä¶</p>

  <form onsubmit="submitAnswer(); return false;">
    <div id="choices" class="mb-4"></div>
    <button type="submit" class="button is-success">
      Submit
    </button>
  </form>

  <div id="feedback" class="notification is-hidden mt-4"></div>
</div>

<!-- END / LIMIT MESSAGE -->
<div id="endMessage" class="notification is-info is-light is-hidden mt-4"></div>

<script>
/* ===============================
   STATE
================================ */
let correctChoice = null;
let matched = 0;
let total = 0;

/* ===============================
   TIMER
================================ */
let timerInterval = null;
let timeLeft = 30;

function startTimer(){
  clearInterval(timerInterval);
  timeLeft = 30;
  timer.innerText = timeLeft;

  timerInterval = setInterval(() => {
    timeLeft--;
    timer.innerText = timeLeft;
    if(timeLeft <= 0){
      clearInterval(timerInterval);
      submitTimeout();
    }
  }, 1000);
}

function submitTimeout(){
  total++;
  totalSpan.innerText = total;
  showFeedback(false, true);
  setTimeout(loadQuestion, 1200);
}

/* ===============================
   LOAD QUESTION
================================ */
function loadQuestion(){
  clearInterval(timerInterval);

  const params = new URLSearchParams();
  if(domainSelect.value) params.append("domain", domainSelect.value);
  if(categorySelect.value) params.append("category", categorySelect.value);
  if(difficultySelect.value) params.append("difficulty", difficultySelect.value);

  fetch("{% url 'quiz:practice_express_next' %}?" + params.toString())
    .then(r => r.json())
    .then(d => {

      /* üîí LIMIT REACHED */
      if(d.limit_reached){
        endMessage.classList.remove("is-hidden");
        endMessage.innerHTML = `
          <p class="has-text-weight-semibold">üîí Free limit reached</p>
          <p class="mt-2">${d.message}</p>
          <div class="buttons mt-3">
            <a href="{% url 'quiz:login' %}" class="button is-primary">Login</a>
            <a href="{% url 'quiz:practice' %}" class="button is-light">Try Basics</a>
          </div>
        `;
        updateProgress(d.progress_done, d.progress_total);
        return;
      }

      /* ‚úÖ COMPLETED */
      if(d.completed){
        endMessage.classList.remove("is-hidden");
        endMessage.innerHTML = `
          <p class="has-text-weight-semibold">üéâ Practice completed!</p>
          <p class="mt-2">Unlock exams & analytics in Pro mode.</p>
          <div class="buttons mt-3">
            <a href="{% url 'quiz:exam_list' %}" class="button is-link">üöÄ Go Pro</a>
            <a href="{% url 'quiz:practice' %}" class="button is-light">Try Basics</a>
          </div>
        `;
        updateProgress(d.progress_done, d.progress_total);
        return;
      }

      /* NORMAL QUESTION */
      correctChoice = d.correct_choice;
      qText.innerText = d.text;
      choices.innerHTML = "";
      feedback.classList.add("is-hidden");

      d.choices.forEach(c => {
        choices.insertAdjacentHTML("beforeend", `
          <label class="radio block mb-2">
            <input type="radio" name="ans" value="${c.id}">
            ${c.text}
          </label>
        `);
      });

      updateProgress(d.progress_done, d.progress_total);
      startTimer();
    });
}

/* ===============================
   SUBMIT ANSWER
================================ */
function submitAnswer(){
  clearInterval(timerInterval);
  const sel = document.querySelector('input[name="ans"]:checked');
  if(!sel){ alert("Select an option"); return; }

  total++;
  totalSpan.innerText = total;

  const isCorrect = Number(sel.value) === Number(correctChoice);
  if(isCorrect) matched++;

  matchedSpan.innerText = matched;
  updateAccuracy();
  showFeedback(isCorrect, false);

  setTimeout(loadQuestion, 1200);
}

/* ===============================
   HELPERS
================================ */
function updateProgress(done, total){
  pDone.innerText = done;
  pTotal.innerText = total;
  pBar.max = total;
  pBar.value = done;
}

function updateAccuracy(){
  accuracy.innerText =
    total === 0 ? "0%" : Math.round((matched / total) * 100) + "%";
}

function showFeedback(isCorrect, timeout){
  feedback.classList.remove("is-hidden","is-success","is-danger");
  feedback.classList.add(isCorrect ? "is-success" : "is-danger");
  feedback.innerText = isCorrect
    ? "‚úÖ Correct!"
    : (timeout ? "‚è∞ Time up!" : "‚ùå Incorrect");
}

/* ===============================
   RESET
================================ */
function resetPractice(){
  clearInterval(timerInterval);
  matched = total = 0;
  matchedSpan.innerText = totalSpan.innerText = "0";
  accuracy.innerText = "0%";
  pDone.innerText = pTotal.innerText = "0";
  pBar.value = pBar.max = 0;
  endMessage.classList.add("is-hidden");
  loadQuestion();
}

/* ===============================
   DOMAIN ‚Üí CATEGORY (AJAX)
================================ */
domainSelect.onchange = () => {
  resetPractice();
  categorySelect.innerHTML = '<option value="">All categories</option>';
  categorySelect.disabled = true;

  if(!domainSelect.value) return;

  fetch("{% url 'quiz:ajax_categories_by_domain' %}?domain=" + domainSelect.value)
    .then(r => r.json())
    .then(d => {
      d.categories.forEach(c => {
        categorySelect.insertAdjacentHTML(
          "beforeend",
          `<option value="${c.id}">${c.parent_id ? "‚Ü≥ " : ""}${c.name}</option>`
        );
      });
      categorySelect.disabled = false;
    });
};

categorySelect.onchange = resetPractice;
difficultySelect.onchange = resetPractice;
resetBtn.onclick = resetPractice;

/* ===============================
   INIT
================================ */
const matchedSpan = document.getElementById("matched");
const totalSpan = document.getElementById("total");
loadQuestion();
</script>

{% endblock %}
