{% extends 'layouts/base.html' %}
{% block title %}Student Dashboard{% endblock %}

{% block content %}
<style>
/* =====================================================
   GLOBAL LAYOUT FIXES
   ===================================================== */
.track-box {
  border: 1px solid #eaeaea;
  border-radius: 14px;
  padding: 18px;
  margin-bottom: 24px;
  background: #ffffff;
}

.track-header {
  display: grid;
  grid-template-columns: 1fr auto;
  align-items: center;
  min-height: 56px;          /* üîë FIXED HEIGHT */
  margin-bottom: 12px;
  gap: 16px;
}

.track-title {
  font-size: 1.1rem;
  font-weight: 600;
  white-space: nowrap;       /* üîë prevents wrapping */
  overflow: hidden;
  text-overflow: ellipsis;
}

.track-meta {
  display: flex;
  align-items: center;
  gap: 10px;
  white-space: nowrap;
}

.track-progress {
  margin-bottom: 12px;
}

.track-tags {
  margin-bottom: 14px;
}

.track-tags .tag {
  margin-right: 6px;
}

/* =====================================================
   EXAM ROWS
   ===================================================== */
.exam-row-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

/* Mobile cards */
.exam-card {
  border: 1px solid #eee;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
  background: #fafafa;
}

.exam-card-title {
  font-weight: 600;
  margin-bottom: 6px;
}

/* Desktop-only */
@media(min-width: 769px) {
  .exam-card { display: none; }
}

/* Mobile-only */
@media(max-width: 768px) {
  table.desktop-only { display: none; }
}

/* Prevent table jump */
table td {
  vertical-align: middle !important;
}
</style>

<h1 class="title is-3 mb-4">üéì Student Dashboard</h1>

<!-- ================= ACTIVE EXAM ================= -->
{% if active_attempt %}
<div class="notification is-warning is-light mb-4">
  <strong>Active Exam:</strong> {{ active_attempt.exam.title }}
  <a class="button is-small is-link ml-2"
     href="{% url 'quiz:exam_take' active_attempt.id %}">
    ‚èØ Resume
  </a>
</div>
{% endif %}

<!-- ================= GLOBAL STATS ================= -->
<div class="columns is-multiline mb-5">
  <div class="column is-4">
    <div class="box has-text-centered">
      <p class="heading">Accuracy</p>
      <p class="title is-4">{{ overall_accuracy }}%</p>
    </div>
  </div>
  <div class="column is-4">
    <div class="box has-text-centered">
      <p class="heading">Current Streak</p>
      <p class="title is-4">üî• {{ current_streak }}</p>
    </div>
  </div>
  <div class="column is-4">
    <div class="box has-text-centered">
      <p class="heading">Completed Exams</p>
      <p class="title is-4">{{ completed_count }}</p>
    </div>
  </div>
</div>

<!-- ================= TRACK GROUPS ================= -->
{% for t in tracks %}
<div class="track-box">

  <!-- ===== TRACK HEADER (NO LAYOUT SHIFT) ===== -->
  <div class="track-header">
    <div class="track-title" title="{{ t.track }}">
      üìò {{ t.track }}
    </div>

    <div class="track-meta">
      {% if t.progress.certificate %}
        <span class="tag is-success is-light">üèÖ Certificate</span>
      {% else %}
        <span class="tag is-info is-light">
          {{ t.progress.passed }}/{{ t.progress.total }} Levels
        </span>
      {% endif %}
    </div>
  </div>

  <!-- ===== PROGRESS BAR ===== -->
  <div class="track-progress">
    <progress class="progress is-primary"
              value="{{ t.progress.passed }}"
              max="{{ t.progress.total }}">
    </progress>
  </div>

  <!-- ===== STATS ===== -->
  <div class="track-tags">
    <span class="tag is-light">Accuracy {{ t.accuracy }}%</span>
    <span class="tag is-light">üî• Streak {{ t.streak }}</span>

    {% if t.progress.certificate %}
      <a href="/quiz/certificate/{{ t.track_slug }}/"
         class="button is-success is-small ml-2">
        ‚¨á Certificate
      </a>
    {% endif %}
  </div>

  <!-- ================= DESKTOP TABLE ================= -->
  <table class="table is-fullwidth is-striped desktop-only">
    <thead>
      <tr>
        <th style="width:55%">Exam</th>
        <th style="width:15%">Level</th>
        <th style="width:30%">Action</th>
      </tr>
    </thead>
    <tbody>
    {% for item in t.exams %}
      <tr>
        <td><strong>{{ item.exam.title }}</strong></td>
        <td><span class="tag is-info is-light">L{{ item.exam.level }}</span></td>
        <td>
          <div class="exam-row-actions">
            {% include "quiz/_exam_actions.html" %}
          </div>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>

  <!-- ================= MOBILE CARDS ================= -->
  {% for item in t.exams %}
  <div class="exam-card">
    <div class="exam-card-title">{{ item.exam.title }}</div>
    <span class="tag is-info is-light mb-2">Level {{ item.exam.level }}</span>

    <div class="exam-row-actions mt-2">
      {% include "quiz/_exam_actions.html" %}
    </div>
  </div>
  {% endfor %}

</div>
{% endfor %}

{% endblock %}
