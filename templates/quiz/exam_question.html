{% extends 'quiz/base.html' %}
{% load dict_extras %}

{% block content %}

<h2 class="subtitle">{{ user_exam.exam.title }}</h2>

<!-- TIMER -->
<div class="notification is-info">
  Time remaining:
  <strong><span id="timer">{{ remaining }}</span></strong> seconds
</div>

<!-- PROGRESS -->
<progress class="progress is-primary" value="{{ progress }}" max="100">
  {{ progress }}%
</progress>

<form id="qform" method="post" action="{% url 'quiz:exam_submit' user_exam.id %}">
  {% csrf_token %}

  <div class="box">
    <p class="mb-3">
      <strong>Q{{ index|add:1 }}.</strong> {{ question.text }}
    </p>

    <!-- SINGLE / DROPDOWN / TRUE-FALSE -->
    <!-- SINGLE / DROPDOWN -->
{% if question.question_type == 'single' or question.question_type == 'dropdown' %}
  {% for c in choices %}
    <label class="radio is-block mb-2">
      <input
        type="radio"
        name="question_{{ question.id }}"
        value="{{ c.id }}"
        {% if ua.choice and ua.choice.id == c.id %}checked{% endif %}
      >
      {{ c.text }}
    </label>
  {% endfor %}

<!-- TRUE / FALSE (FIXED, AUTOSAVE-SAFE) -->
{% elif question.question_type == 'tf' %}

  <!-- hidden mirror (this is what backend reads) -->
  <input
    type="hidden"
    name="question_{{ question.id }}"
    id="tf_hidden_{{ question.id }}"
    value="{% if ua.choice %}{{ ua.choice.id }}{% endif %}"
  >

  {% for c in choices %}
    <label class="radio is-block mb-2">
      <input
        type="radio"
        name="tf_radio_{{ question.id }}"
        value="{{ c.id }}"
        {% if ua.choice and ua.choice.id == c.id %}checked{% endif %}
        onchange="document.getElementById('tf_hidden_{{ question.id }}').value=this.value"
      >
      {{ c.text }}
    </label>
  {% endfor %}



    <!-- MULTI -->
    {% elif question.question_type == 'multi' %}
      {% for c in choices %}
        <label class="checkbox is-block mb-2">
          <input
            type="checkbox"
            name="question_{{ question.id }}"
            value="{{ c.id }}"
            {% if ua.selections and c.id|stringformat:"s" in ua.selections|join:"," %}
              checked
            {% endif %}
          >
          {{ c.text }}
        </label>
      {% endfor %}

    <!-- FILL -->
    {% elif question.question_type == 'fill' %}
      <input class="input"
             type="text"
             name="question_{{ question.id }}"
             value="{{ ua.raw_answer|default_if_none:'' }}">

    <!-- NUMERIC -->
    {% elif question.question_type == 'numeric' %}
      <input class="input"
             type="text"
             name="question_{{ question.id }}"
             value="{{ ua.raw_answer|default_if_none:'' }}">
      <p class="help">Tolerance Â± {{ question.numeric_tolerance }}</p>

    <!-- MATCH -->
    {% elif question.question_type == 'match' %}
      {% for pair in question.matching_pairs %}
        {% with li=forloop.counter0 %}
        <div class="mb-3">
          <strong>{{ pair.left }}</strong>
          <select class="select is-fullwidth"
                  name="match_{{ question.id }}_{{ li }}">
            <option value="">-- pick --</option>
            {% for opt in question.matching_pairs %}
              <option value="{{ opt.right }}"
                {% if ua.selections and ua.selections|dict_get:li|stringformat:"s" == opt.right|stringformat:"s" %}
                  selected
                {% endif %}
              >
                {{ opt.right }}
              </option>
            {% endfor %}
          </select>
        </div>
        {% endwith %}
      {% endfor %}

    <!-- ORDER -->
    {% elif question.question_type == 'order' %}
      <input class="input"
             name="question_{{ question.id }}"
             value="{{ ua.raw_answer|default_if_none:'' }}">
      <p class="help">
        Canonical: {{ question.ordering_items|join:", " }}
      </p>

    {% else %}
      <p class="has-text-danger">
        Unsupported question type
      </p>
    {% endif %}
  </div>

  <!-- NAVIGATION -->
  <div class="buttons mt-4">
    {% if index > 0 %}
      <a class="button"
         href="{% url 'quiz:exam_question' user_exam.id index|add:-1 %}">
        Previous
      </a>
    {% endif %}

    {% if index < total|add:-1 %}
      <a class="button is-primary"
         href="{% url 'quiz:exam_question' user_exam.id index|add:1 %}">
        Next
      </a>
    {% else %}
      <button type="submit" class="button is-success" id="submitBtn">
        Submit Exam
      </button>
    {% endif %}
  </div>
</form>

<!-- =========================
     TIMER + AUTOSAVE (FIXED)
========================= -->
<script>
/* Countdown timer */
let remaining = parseInt(document.getElementById('timer').innerText || '0', 10);
const timerEl = document.getElementById('timer');
let submitted = false;

const interval = setInterval(() => {
  remaining--;
  timerEl.innerText = remaining;

  if (remaining <= 0 && !submitted) {
    submitted = true;
    clearInterval(interval);
    window.location.href = "{% url 'quiz:exam_expired' user_exam.id %}";
  }
}, 1000);

/* ðŸ”’ AUTOSAVE â€” DISABLED AFTER SUBMIT */
const form = document.getElementById('qform');
const submitBtn = document.getElementById('submitBtn');

if (submitBtn) {
  submitBtn.addEventListener('click', function () {
    submitted = true;
  });
}

form.addEventListener('change', function () {
  if (submitted) return;   // ðŸ”¥ THIS LINE FIXES TF ISSUE

  const data = new FormData(form);

  fetch("{% url 'quiz:exam_autosave' user_exam.id %}", {
    method: "POST",
    credentials: "same-origin",
    headers: { "X-Requested-With": "XMLHttpRequest" },
    body: data
  }).catch(() => {});
});
</script>

{% endblock %}
