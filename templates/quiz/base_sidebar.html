{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ title|default:"Objective Exam" }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="{% static 'css/theme.css' %}">
  <style> /* minor override for Bulma spacing */ .navbar, .hero { box-shadow: none; }</style>
</head>
<body>
  <div class="app-shell" id="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar" role="navigation" aria-label="Main">
      <div class="logo">
        <a href="{% url 'quiz:exam_list' %}">
          <img src="{% static 'images/logo.png' %}" alt="logo">
        </a>
        <div>
          <div style="font-weight:600">{{ site_name|default:"Objective Exam" }}</div>
          <div class="small-muted">Learning Platform</div>
        </div>
      </div>

      <nav class="nav">
        <a class="{% if request.resolver_match.url_name == 'exam_list' %}active{% endif %}" href="{% url 'quiz:exam_list' %}"><i class="fa fa-home"></i> Exams</a>
        <a class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" href="{% url 'quiz:dashboard' %}"><i class="fa fa-tachometer-alt"></i> Dashboard</a>
        <a href="{% url 'quiz:exam_list' %}"><i class="fa fa-list"></i> My Exams</a>
        {% if user.is_staff %}
          <a href="/admin/"><i class="fa fa-cog"></i> Admin</a>
        {% endif %}
        <hr style="margin:12px 0">
        <a href="{% url 'quiz:profile' %}"><i class="fa fa-user"></i> Profile</a>
      </nav>
      <div style="margin-top:18px;font-size:0.9rem;color:var(--muted)">Version 1.0</div>
    </aside>

    <!-- MAIN -->
    <div style="flex:1; display:flex; flex-direction:column;">
      <header class="topbar">
        <div class="topbar-left">
          <div class="breadcrumbs">
            {% include 'quiz/_breadcrumbs.html' %}
          </div>
        </div>

        <div class="topbar-actions">
          <!-- notifications -->
          <div class="icon-badge" id="notif-root" style="position:relative;">
            <button id="notif-btn" class="button is-white" style="border-radius:8px;">
              <i class="fa fa-bell"></i>
            </button>

            {# Safely render unread_count: use default 0 then compare #}
            {% if unread_count|default:0|add:"0" > 0 %}
              <span class="badge">{{ unread_count }}</span>
            {% endif %}

            <div id="notif-panel" style="display:none; position:absolute; right:16px; top:56px; width:320px; z-index:50;">
              {% include 'quiz/_notifications_panel.html' %}
            </div>
          </div>

          <!-- dark mode toggle -->
          <div class="switch" id="theme-toggle" title="Dark / Light" style="margin-left:12px; cursor:pointer;">
            <i class="fa fa-moon"></i>
            <div class="dot" id="theme-dot"></div>
          </div>

          <!-- user dropdown -->
          <div class="has-dropdown" style="margin-left:8px;">
            <div class="button is-white" id="user-btn"><i class="fa fa-user-circle"></i>&nbsp; {{ user.username }}</div>
          </div>
        </div>
      </header>

      <main class="container">
        {% block content %}{% endblock %}
      </main>

    </div>
  </div>

<script>
  // Dark mode toggle with localStorage persistence
  (function(){
    const key = 'site-theme';
    const elToggle = document.getElementById('theme-toggle');
    function applyTheme(t){
      if(t === 'dark') document.documentElement.setAttribute('data-theme','dark');
      else document.documentElement.removeAttribute('data-theme');
    }
    try {
      const current = localStorage.getItem(key) || 'light';
      applyTheme(current);
      if(elToggle){
        elToggle.addEventListener('click', ()=>{
          const now = (localStorage.getItem(key)||'light') === 'dark' ? 'light' : 'dark';
          localStorage.setItem(key, now);
          applyTheme(now);
        });
      }
    } catch(e){ console.warn('theme toggle error', e); }
  })();

  // Notification panel toggle (robust: checks for missing DOM nodes)
  (function(){
    const btn = document.getElementById('notif-btn');
    const panel = document.getElementById('notif-panel');
    if(!btn) return;
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      if(!panel) return;
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    });
    // close when clicking outside
    document.addEventListener('click', ()=>{ if(panel) panel.style.display='none'; });
    // stop click inside
    if(panel) panel.addEventListener('click', (e)=> e.stopPropagation());
  })();
</script>

</body>
</html>
