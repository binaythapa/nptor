{% extends "quiz/base.html" %}
{% block content %}

<style>
/* ================= STICKY BACK BAR ================= */
.sticky-nav {
  position: sticky;
  top: 0;
  z-index: 30;
  background: #ffffff;
  padding: 12px 0;
  border-bottom: 1px solid #eee;
}

/* Subtle shadow while scrolling */
.sticky-nav.scrolled {
  box-shadow: 0 4px 12px rgba(0,0,0,.08);
}
</style>

<!-- ================= STICKY NAV BAR ================= -->
<div id="stickyNav" class="sticky-nav mb-4">

  <!-- BREADCRUMBS -->
  <nav class="breadcrumb" aria-label="breadcrumbs">
    <ul>
      <li><a href="{% url 'quiz:admin_dashboard' %}">Admin</a></li>
      <li><a href="{% url 'quiz:subscription_admin_panel' %}">Subscriptions</a></li>
      <li class="is-active">
        <a href="#" aria-current="page">Mock Attempt History</a>
      </li>
    </ul>
  </nav>

  <!-- BACK BUTTON -->
  <a href="{% url 'quiz:admin_dashboard' %}"
     class="button is-light is-small">
    ‚Üê Back to Dashboard
  </a>

</div>

<!-- ================= PAGE HEADER ================= -->
<div class="mb-5">
  <h2 class="title is-4">üß™ Mock Attempt History</h2>
  <p class="has-text-grey">
    View, filter and audit mock exam attempts.  
    <strong>Esc</strong> key returns to dashboard.
  </p>
</div>

<!-- ================= FILTERS ================= -->
<form method="get" class="box mb-5">

  <div class="columns is-multiline">

    <!-- USER -->
    <div class="column is-4">
      <label class="label">User</label>
      <div class="select is-fullwidth">
        <select name="user">
          <option value="">All Users</option>
          {% for u in users %}
            <option value="{{ u.id }}"
              {% if request.GET.user == u.id|stringformat:"s" %}selected{% endif %}>
              {{ u.username }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- EXAM -->
    <div class="column is-4">
      <label class="label">Exam</label>
      <div class="select is-fullwidth">
        <select name="exam">
          <option value="">All Exams</option>
          {% for e in exams %}
            <option value="{{ e.id }}"
              {% if request.GET.exam == e.id|stringformat:"s" %}selected{% endif %}>
              {{ e.title }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- DATE -->
    <div class="column is-4">
      <label class="label">From Date</label>
      <input type="date"
             name="date"
             class="input"
             value="{{ request.GET.date }}">
    </div>

  </div>

  <div class="mt-4">
    <button class="button is-link is-small">
      üîç Apply Filters
    </button>

    <a href="{% url 'quiz:admin_mock_attempt_history' %}"
       class="button is-light is-small ml-2">
      Reset
    </a>
  </div>

</form>

<!-- ================= TABLE ================= -->
<div class="table-container">
<table class="table is-fullwidth is-striped is-hoverable">

  <thead>
    <tr>
      <th>User</th>
      <th>Exam</th>
      <th>Status</th>
      <th>Score</th>
      <th>Started</th>
      <th>Submitted</th>
    </tr>
  </thead>

  <tbody>
    {% for ue in attempts %}
    <tr>
      <td>{{ ue.user.username }}</td>
      <td>{{ ue.exam.title }}</td>
      <td>
        {% if ue.status == "submitted" %}
          <span class="tag is-success">Submitted</span>
        {% elif ue.status == "expired" %}
          <span class="tag is-danger">Expired</span>
        {% else %}
          <span class="tag is-warning">Started</span>
        {% endif %}
      </td>
      <td>
        {% if ue.score %}{{ ue.score }}%{% else %}‚Äî{% endif %}
      </td>
      <td>{{ ue.started_at|date:"Y-m-d H:i" }}</td>
      <td>
        {% if ue.submitted_at %}
          {{ ue.submitted_at|date:"Y-m-d H:i" }}
        {% else %}
          ‚Äî
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="6" class="has-text-centered has-text-grey">
        No mock attempts found
      </td>
    </tr>
    {% endfor %}
  </tbody>

</table>
</div>

<!-- ================= PAGINATION ================= -->
{% if attempts.has_other_pages %}
<nav class="pagination is-centered mt-5">

  {% if attempts.has_previous %}
    <a class="pagination-previous"
       href="?page={{ attempts.previous_page_number }}&{{ request.GET.urlencode }}">
      Previous
    </a>
  {% else %}
    <a class="pagination-previous" disabled>Previous</a>
  {% endif %}

  {% if attempts.has_next %}
    <a class="pagination-next"
       href="?page={{ attempts.next_page_number }}&{{ request.GET.urlencode }}">
      Next
    </a>
  {% else %}
    <a class="pagination-next" disabled>Next</a>
  {% endif %}

</nav>
{% endif %}

<!-- ================= JS ENHANCEMENTS ================= -->
<script>
// Sticky shadow on scroll
window.addEventListener("scroll", () => {
  const nav = document.getElementById("stickyNav");
  if (window.scrollY > 10) {
    nav.classList.add("scrolled");
  } else {
    nav.classList.remove("scrolled");
  }
});

// ESC = Back
document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    window.location.href = "{% url 'quiz:admin_dashboard' %}";
  }
});
</script>

{% endblock %}
