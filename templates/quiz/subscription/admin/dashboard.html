{% extends "layouts/base.html" %}
{% block content %}

<h2 class="title is-4">ðŸŽ› Subscription Control Panel</h2>
<p class="has-text-grey mb-5">
  Manage pricing models, subscriptions & coupons from one place
</p>

{% csrf_token %}

<!-- ================= TOAST ================= -->
<div id="toast"
     class="notification is-success is-light"
     style="display:none; position:fixed; top:20px; right:20px; z-index:9999;">
</div>

<script>
function showToast(msg, type="is-success") {
  const t = document.getElementById("toast");
  t.className = "notification " + type;
  t.innerText = msg;
  t.style.display = "block";
  setTimeout(() => t.style.display = "none", 2500);
}
</script>

<!-- ================= ADMIN USER CONTROL ================= -->
<h3 class="title is-5">ðŸ‘¤ User Subscriptions (Admin)</h3>

<div class="columns">

  <div class="column is-6">
    <div class="box">
      <h4 class="title is-6">ðŸ“˜ Exam</h4>

      <div class="select is-fullwidth mb-2">
        <select id="exam_user">
          {% for u in users %}
          <option value="{{ u.id }}">{{ u.username }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="select is-fullwidth mb-3">
        <select id="exam_id">
          {% for e in exams %}
          <option value="{{ e.id }}">{{ e.title }}</option>
          {% endfor %}
        </select>
      </div>

      <button class="button is-success is-small" onclick="adminSubscribeExam()">Subscribe</button>
      <button class="button is-danger is-small" onclick="adminRevokeExam()">Revoke</button>
    </div>
  </div>

  <div class="column is-6">
    <div class="box">
      <h4 class="title is-6">ðŸ“š Track</h4>

      <div class="select is-fullwidth mb-2">
        <select id="track_user">
          {% for u in users %}
          <option value="{{ u.id }}">{{ u.username }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="select is-fullwidth mb-3">
        <select id="track_id">
          {% for t in tracks %}
          <option value="{{ t.id }}">{{ t.title }}</option>
          {% endfor %}
        </select>
      </div>

      <button class="button is-success is-small" onclick="adminSubscribeTrack()">Subscribe</button>
      <button class="button is-danger is-small" onclick="adminRevokeTrack()">Revoke</button>
    </div>
  </div>

</div>

<hr>

<!-- ================= ACTIVE SUBSCRIPTIONS ================= -->
<h3 class="title is-5">ðŸŸ¢ Active Subscriptions</h3>

<div class="table-container">
<table class="table is-fullwidth is-striped is-hoverable is-small">
<thead>
<tr>
  <th>User</th>
  <th>Item</th>
  <th>Type</th>
  <th>Status</th>
  <th>Granted By</th>
  <th>Expiry</th>
  <th>Remaining</th>
  <th>Extend</th>
  <th>Action</th>
</tr>
</thead>
<tbody>

<!-- ===== ACTIVE EXAMS ===== -->
{% for s in exam_subs %}
  {% if s.is_active %}
    {% if not s.expires_at or s.expires_at > now %}
<tr>
  <td>{{ s.user.username }}</td>
  <td>{{ s.exam.title }}</td>
  <td>Exam</td>
  <td><span class="tag is-success">Active</span></td>
  <td>
    {% if s.subscribed_by_admin %}
      <span class="tag is-info">Admin</span>
    {% else %}
      <span class="tag is-light">User</span>
    {% endif %}
  </td>
  <td>
    <input type="datetime-local" class="input is-small"
      value="{% if s.expires_at %}{{ s.expires_at|date:'Y-m-d\\TH:i' }}{% endif %}"
      onchange="updateExamExpiry('{{ s.user.id }}','{{ s.exam.id }}', this.value)">
  </td>
  <td>
    {% if s.expires_at %}
      <span class="tag is-warning">{{ s.expires_at|timeuntil }}</span>
    {% else %}
      <span class="tag is-success">âˆž</span>
    {% endif %}
  </td>
  <td>
    <button class="button is-small" onclick="quickAddDays('exam','{{ s.user.id }}','{{ s.exam.id }}',7)">+7</button>
    <button class="button is-small" onclick="quickAddDays('exam','{{ s.user.id }}','{{ s.exam.id }}',30)">+30</button>
  </td>
  <td>
    <button class="button is-danger is-small"
            onclick="revokeExamRow('{{ s.user.id }}','{{ s.exam.id }}', this)">
      Revoke
    </button>
  </td>
</tr>
    {% endif %}
  {% endif %}
{% endfor %}

<!-- ===== ACTIVE TRACKS ===== -->
{% for s in track_subs %}
  {% if s.is_active %}
    {% if not s.expires_at or s.expires_at > now %}
<tr>
  <td>{{ s.user.username }}</td>
  <td>{{ s.track.title }}</td>
  <td>Track</td>
  <td><span class="tag is-success">Active</span></td>
  <td>
    {% if s.subscribed_by_admin %}
      <span class="tag is-info">Admin</span>
    {% else %}
      <span class="tag is-light">User</span>
    {% endif %}
  </td>
  <td>
    <input type="datetime-local" class="input is-small"
      value="{% if s.expires_at %}{{ s.expires_at|date:'Y-m-d\\TH:i' }}{% endif %}"
      onchange="updateTrackExpiry('{{ s.user.id }}','{{ s.track.id }}', this.value)">
  </td>
  <td>
    {% if s.expires_at %}
      <span class="tag is-warning">{{ s.expires_at|timeuntil }}</span>
    {% else %}
      <span class="tag is-success">âˆž</span>
    {% endif %}
  </td>
  <td>
    <button class="button is-small" onclick="quickAddDays('track','{{ s.user.id }}','{{ s.track.id }}',7)">+7</button>
    <button class="button is-small" onclick="quickAddDays('track','{{ s.user.id }}','{{ s.track.id }}',30)">+30</button>
  </td>
  <td>
    <button class="button is-danger is-small"
            onclick="revokeTrackRow('{{ s.user.id }}','{{ s.track.id }}', this)">
      Revoke
    </button>
  </td>
</tr>
    {% endif %}
  {% endif %}
{% endfor %}

</tbody>
</table>
</div>

<hr>

<!-- ================= REVOKED / EXPIRED ================= -->
<h3 class="title is-5">ðŸ”´ Revoked / Expired Subscriptions</h3>

<div class="table-container">
<table class="table is-fullwidth is-striped is-hoverable is-small">
<thead>
<tr>
  <th>User</th>
  <th>Item</th>
  <th>Type</th>
  <th>Status</th>
</tr>
</thead>
<tbody>

{% for s in exam_subs %}
  {% if not s.is_active %}
<tr class="expired-row">
  <td>{{ s.user.username }}</td>
  <td>{{ s.exam.title }}</td>
  <td>Exam</td>
  <td><span class="tag is-danger">Revoked / Expired</span></td>
</tr>
  {% endif %}
{% endfor %}

{% for s in track_subs %}
  {% if not s.is_active %}
<tr class="expired-row">
  <td>{{ s.user.username }}</td>
  <td>{{ s.track.title }}</td>
  <td>Track</td>
  <td><span class="tag is-danger">Revoked / Expired</span></td>
</tr>
  {% endif %}
{% endfor %}

</tbody>
</table>
</div>

<style>
.expired-row { background:#fff5f5 !important; }
</style>

<script>
function csrf(){return document.querySelector('[name=csrfmiddlewaretoken]').value;}

function adminSubscribeExam(){
  fetch("{% url 'quiz:admin_subscribe_exam' %}",{
    method:"POST",
    headers:{ "X-CSRFToken":csrf(),"Content-Type":"application/x-www-form-urlencoded" },
    body:new URLSearchParams({ user_id:exam_user.value, exam_id:exam_id.value })
  }).then(()=>showToast("Exam subscribed"));
}

function adminRevokeExam(){
  fetch("{% url 'quiz:admin_revoke_exam' %}",{
    method:"POST",
    headers:{ "X-CSRFToken":csrf(),"Content-Type":"application/x-www-form-urlencoded" },
    body:new URLSearchParams({ user_id:exam_user.value, exam_id:exam_id.value })
  }).then(()=>showToast("Exam revoked","is-danger"));
}

function adminSubscribeTrack(){
  fetch("{% url 'quiz:admin_subscribe_track' %}",{
    method:"POST",
    headers:{ "X-CSRFToken":csrf(),"Content-Type":"application/x-www-form-urlencoded" },
    body:new URLSearchParams({ user_id:track_user.value, track_id:track_id.value })
  }).then(()=>showToast("Track subscribed"));
}

function adminRevokeTrack(){
  fetch("{% url 'quiz:admin_revoke_track' %}",{
    method:"POST",
    headers:{ "X-CSRFToken":csrf(),"Content-Type":"application/x-www-form-urlencoded" },
    body:new URLSearchParams({ user_id:track_user.value, track_id:track_id.value })
  }).then(()=>showToast("Track revoked","is-danger"));
}

function revokeExamRow(u,e,btn){
  fetch("{% url 'quiz:admin_revoke_exam' %}",{
    method:"POST",
    headers:{ "X-CSRFToken":csrf(),"Content-Type":"application/x-www-form-urlencoded" },
    body:new URLSearchParams({ user_id:u, exam_id:e })
  }).then(()=>{ btn.closest("tr").remove(); showToast("Exam revoked","is-danger"); });
}

function revokeTrackRow(u,t,btn){
  fetch("{% url 'quiz:admin_revoke_track' %}",{
    method:"POST",
    headers:{ "X-CSRFToken":csrf(),"Content-Type":"application/x-www-form-urlencoded" },
    body:new URLSearchParams({ user_id:u, track_id:t })
  }).then(()=>{ btn.closest("tr").remove(); showToast("Track revoked","is-danger"); });
}

function updateExamExpiry(u,e,v){
  fetch("{% url 'quiz:admin_update_exam_expiry' %}",{
    method:"POST",
    headers:{ "X-CSRFToken":csrf(),"Content-Type":"application/x-www-form-urlencoded" },
    body:new URLSearchParams({ user_id:u, exam_id:e, expires_at:v })
  }).then(()=>showToast("Expiry updated"));
}

function updateTrackExpiry(u,t,v){
  fetch("{% url 'quiz:admin_update_track_expiry' %}",{
    method:"POST",
    headers:{ "X-CSRFToken":csrf(),"Content-Type":"application/x-www-form-urlencoded" },
    body:new URLSearchParams({ user_id:u, track_id:t, expires_at:v })
  }).then(()=>showToast("Expiry updated"));
}

function quickAddDays(type,u,id,days){
  fetch(type==="exam"
    ? "{% url 'quiz:admin_add_exam_days' %}"
    : "{% url 'quiz:admin_add_track_days' %}",{
    method:"POST",
    headers:{ "X-CSRFToken":csrf(),"Content-Type":"application/x-www-form-urlencoded" },
    body:new URLSearchParams({ user_id:u, item_id:id, days:days })
  }).then(()=>showToast(`Extended by ${days} days`));
}
</script>

{% endblock %}
