{% extends "layouts/admin/base_admin.html" %}
{% block title %}Question Dashboard{% endblock %}

{% block content %}
<style>

/* ================= DASHBOARD HEADER ================= */

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

@media (max-width: 768px) {
  .dashboard-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .dashboard-actions {
    width: 100%;
  }

  .dashboard-actions .button {
    width: 100%;
    justify-content: center;
  }
}

/* ================= TABLE IMPROVEMENTS ================= */

.table {
  table-layout: fixed;
  width: 100%;
}

.table td {
  vertical-align: middle;
}

.question-cell {
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 0;
}

.question-text {
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  overflow: hidden;
  white-space: normal;
  word-break: break-word;
}

.question-text.expanded {
  -webkit-line-clamp: unset;
}

.expand-toggle {
  font-size: 0.75rem;
  color: #2563eb;
  cursor: pointer;
  display: none;
}

.question-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
}

.question-row {
  cursor: pointer;
}

.question-row:hover {
  background: #f9fafb;
}

.action-buttons .button {
  padding: 4px 6px;
}

.duplicate-tag {
  font-size: 0.7rem;
}

</style>

<section class="section">
<div class="container">

<!-- ================= HEADER ================= -->
<div class="dashboard-header">
  <div>
    <h1 class="title is-4">ğŸ§  Question Dashboard</h1>
    <p class="has-text-grey is-size-7">
      Review question quality, flags, duplicates & discussions
    </p>
  </div>

  <div class="dashboard-actions">
    <a href="{% url 'quiz:admin_dashboard' %}"
       class="button is-light is-small">
      â† Back to Dashboard
    </a>

    <a href="{% url 'quiz:add_question' %}"
       class="button is-light is-small">
      â• Add Question
    </a>
  </div>
</div>

<!-- ================= KPI BLOCKS ================= -->
<div class="columns is-multiline mb-4">

  <div class="column is-3">
    <div class="box has-text-centered">
      <p class="heading">ğŸ“˜ Total</p>
      <p class="title">{{ total_questions }}</p>
    </div>
  </div>

  <div class="column is-3">
    <div class="box has-text-centered has-text-success">
      <p class="heading">âœ… Active</p>
      <p class="title">{{ active_questions }}</p>
    </div>
  </div>

  <div class="column is-3">
    <div class="box has-text-centered has-text-warning">
      <p class="heading">ğŸš© Flagged</p>
      <p class="title">{{ flagged_questions }}</p>
    </div>
  </div>

  <div class="column is-3">
    <div class="box has-text-centered has-text-danger">
      <p class="heading">ğŸš« Disabled</p>
      <p class="title">{{ disabled_questions }}</p>
    </div>
  </div>

  <!-- ğŸ” NEW DUPLICATE KPI -->
  <div class="column is-3">
    <div class="box has-text-centered has-text-danger">
      <p class="heading">ğŸ” Duplicates</p>
      <p class="title">{{ duplicate_questions_count }}</p>
    </div>
  </div>

</div>

<!-- ================= TABS ================= -->
<div class="tabs is-toggle is-small mb-4">
  <ul>
    <li class="{% if tab == 'all' %}is-active{% endif %}">
      <a href="?tab=all">ğŸ“˜ All Questions</a>
    </li>

    <li class="{% if tab == 'review' %}is-active{% endif %}">
      <a href="?tab=review">
        ğŸš© Needs Review
        {% if needs_review_count %}
          <span class="tag is-danger ml-1">{{ needs_review_count }}</span>
        {% endif %}
      </a>
    </li>

    <!-- ğŸ” DUPLICATES TAB -->
    <li class="{% if tab == 'duplicates' %}is-active{% endif %}">
      <a href="?tab=duplicates">
        ğŸ” Duplicates
        {% if duplicate_questions_count %}
          <span class="tag is-danger ml-1">
            {{ duplicate_questions_count }}
          </span>
        {% endif %}
      </a>
    </li>

  </ul>
</div>

<!-- ================= FILTERS (UNCHANGED) ================= -->
<form method="get" class="box mb-4">
<input type="hidden" name="tab" value="{{ tab }}">
<div class="columns is-multiline">

  <div class="column is-3">
    <input class="input" name="q" placeholder="Search question..."
           value="{{ search }}">
  </div>

  <div class="column is-3">
    <div class="select is-fullwidth">
      <select name="category">
        <option value="">All categories</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}"
            {% if cat.id|stringformat:"s" == selected_category %}selected{% endif %}>
            {{ cat.name }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="column is-2">
    <div class="select is-fullwidth">
      <select name="difficulty">
        <option value="">All</option>
        <option value="easy" {% if selected_difficulty == "easy" %}selected{% endif %}>Easy</option>
        <option value="medium" {% if selected_difficulty == "medium" %}selected{% endif %}>Medium</option>
        <option value="hard" {% if selected_difficulty == "hard" %}selected{% endif %}>Hard</option>
      </select>
    </div>
  </div>

  <div class="column is-2">
    <div class="select is-fullwidth">
      <select name="status">
        <option value="">All Status</option>
        <option value="active" {% if selected_status == "active" %}selected{% endif %}>Active</option>
        <option value="disabled" {% if selected_status == "disabled" %}selected{% endif %}>Disabled</option>
      </select>
    </div>
  </div>

  <div class="column is-2">
    <button class="button is-link is-fullwidth">Filter</button>
  </div>

</div>
</form>

<!-- ================= TABLE ================= -->
<div class="table-container">
<table class="table is-fullwidth is-striped is-hoverable">

<thead>
<tr>
  <th style="width:60px;">ID</th>
  <th style="width:45%">Question</th>
  <th>ğŸ”</th>
  <th>ğŸ’¬</th>
  <th>ğŸš©</th>
  <th>Status</th>
  <th style="width:150px;">Actions</th>
</tr>
</thead>

<tbody id="question-table-body">
{% include "quiz/admin/questions/_question_rows.html" %}
</tbody>

</table>

<div id="scroll-loader"
     class="has-text-centered has-text-grey mt-4"
     style="display:none;">
  â³ Loading more questions...
</div>

<div id="end-of-list"
     class="has-text-centered has-text-grey mt-4"
     style="display:none;">
  ğŸ‰ Youâ€™ve reached the end of the list
</div>

</div>
</div>
</section>

<script>
let currentPage = {{ questions.number }};
let hasNext = {{ questions.has_next|yesno:"true,false" }};
let loading = false;

/* ROW CLICK */
document.addEventListener("click", function (e) {
  const row = e.target.closest(".question-row");
  if (!row) return;

  if (e.target.closest("a") || e.target.closest("button") || e.target.closest("form")) return;

  window.location.href = row.dataset.reviewUrl;
});

/* Infinite Scroll */
function loadMoreQuestions() {
  if (!hasNext || loading) return;

  loading = true;
  document.getElementById("scroll-loader").style.display = "block";

  const url =
    window.location.href.replace(/(&|\?)page=\d+/, '') +
    (window.location.search.includes('?') ? '&' : '?') +
    'page=' + (currentPage + 1);

  fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
    .then(res => res.json())
    .then(data => {
      document.getElementById("question-table-body")
        .insertAdjacentHTML("beforeend", data.html);

      currentPage++;
      hasNext = data.has_next;
      loading = false;

      document.getElementById("scroll-loader").style.display = "none";

      if (!hasNext) {
        document.getElementById("end-of-list").style.display = "block";
      }
    });
}

window.addEventListener("scroll", function () {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
    loadMoreQuestions();
  }
});
</script>

<script>
function confirmDelete(e, id) {
  e.stopPropagation();

  return confirm(
    "âš ï¸ Are you sure you want to delete this question?\n\n" +
    "This action will soft-delete the question and hide it from users."
  );
}
</script>

{% endblock %}