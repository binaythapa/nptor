{% extends "quiz/base.html" %}
{% block content %}

<h2 class="title is-4">üéì Student Dashboard</h2>

{% if active_attempt %}
<div class="notification is-warning is-light">
  <strong>‚è≥ Active Exam:</strong> {{ active_attempt.exam.title }}
  <a class="button is-small is-dark ml-2"
     href="{% url 'quiz:exam_take' active_attempt.id %}">
    Resume
  </a>
</div>
{% endif %}

<!-- ================= STATS ================= -->
<div class="columns is-multiline">
  <div class="column is-4">
    <div class="box has-text-centered">
      <p class="heading">Attempts</p>
      <p class="title">{{ total_attempts }}</p>
    </div>
  </div>
  <div class="column is-4">
    <div class="box has-text-centered has-text-success">
      <p class="heading">Passed</p>
      <p class="title">{{ passed_count }}</p>
    </div>
  </div>
  <div class="column is-4">
    <div class="box has-text-centered has-text-danger">
      <p class="heading">Failed</p>
      <p class="title">{{ failed_count }}</p>
    </div>
  </div>
</div>

<!-- ================= TRACK ACCORDION ================= -->
{% for track, items in track_map.items %}
<div class="track-accordion box">

  <!-- TRACK HEADER -->
  <button class="track-header button is-light is-fullwidth"
          onclick="this.nextElementSibling.classList.toggle('is-hidden')">
    <strong>üìò {{ track.title }}</strong>
    <span class="is-size-7 has-text-grey ml-2">
      {{ items|length }} exams
    </span>
  </button>

  <!-- TRACK BODY -->
  <div class="track-body mt-3 is-hidden">

    <!-- LEVEL LADDER (SAFE ADDITION) -->
    <div class="mb-3">
      {% for item in items %}
        <span class="tag
          {% if item.locked %}
            is-light
          {% else %}
            is-success
          {% endif %}
        ">
          L{{ item.exam.level }}
        </span>
        {% if not forloop.last %}
          <span class="mx-1">‚Üí</span>
        {% endif %}
      {% endfor %}
    </div>

    {% for item in items %}
    <div class="box mb-3">
      <div class="is-flex is-justify-content-space-between is-align-items-center">

        <!-- LEFT INFO -->
        <div>
          <strong>{{ item.exam.title }}</strong><br>
          <small class="has-text-grey">
            Level {{ item.exam.level }} ‚Ä¢
            {{ item.exam.question_count }} Q ‚Ä¢
             {% widthratio item.exam.duration_seconds 60 1 %} min
          </small>

          {% if item.locked %}
            <p class="has-text-warning is-size-7 mt-1">
              üîí Complete previous level
            </p>
          {% endif %}

          {% if item.last_score is not None %}
            <p class="is-size-7 mt-1">
              {% if item.status == "passed" %}
                ‚úÖ Passed ({{ item.last_score }}%)
              {% else %}
                ‚ùå Failed ({{ item.last_score }}%)
              {% endif %}
            </p>
          {% endif %}

          {% if item.retry_count > 0 %}
            <p class="is-size-7 has-text-grey">
              üîÅ Retries: {{ item.retry_count }}
            </p>
          {% endif %}

          {% if item.improvement is not None %}
            <p class="is-size-7">
              {% if item.improvement > 0 %}
                üìà Improved by
                <strong class="has-text-success">
                  +{{ item.improvement }}%
                </strong>
              {% elif item.improvement < 0 %}
                üìâ Dropped by
                <strong class="has-text-danger">
                  {{ item.improvement }}%
                </strong>
              {% else %}
                ‚ûñ No change
              {% endif %}
              <span class="has-text-grey">(vs best attempt)</span>
            </p>
          {% endif %}
        </div>

        <!-- RIGHT ACTIONS -->
        <div class="buttons">

          {% if item.action == "resume" %}
            <a class="button is-warning is-small"
               href="{% url 'quiz:exam_take' item.last_attempt.id %}">
              Resume
            </a>

          {% elif item.action == "cooldown" %}
            <button class="button is-light is-small" disabled>
              ‚è≥ Retake locked
            </button>
            <span class="has-text-grey is-size-7 ml-2"
                  data-countdown="{{ item.cooldown_remaining }}">
              Retake in <strong class="countdown-text"></strong>
            </span>

          {% elif item.action == "retake" and not item.locked %}
            <a class="button is-primary is-small"
               href="{% url 'quiz:exam_start' item.exam.id %}">
              Retake
            </a>

          {% elif not item.locked %}
            <a class="button is-primary is-small"
               href="{% url 'quiz:exam_start' item.exam.id %}">
              Start
            </a>
          {% endif %}
        </div>

      </div>
    </div>
    {% endfor %}

  </div>
</div>
{% empty %}
<p>No subscribed exams.</p>
{% endfor %}

<!-- ================= COUNTDOWN SCRIPT ================= -->
<script>
document.querySelectorAll("[data-countdown]").forEach(el => {
  let seconds = parseInt(el.dataset.countdown);
  const textEl = el.querySelector(".countdown-text");

  function tick() {
    if (seconds <= 0) {
      textEl.innerText = "now";
      return;
    }
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    textEl.innerText = `${m}m ${s}s`;
    seconds--;
    setTimeout(tick, 1000);
  }
  tick();
});
</script>

{% endblock %}
