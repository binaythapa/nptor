{% extends "quiz/base.html" %}
{% block content %}

<h2 class="title is-4">üéì Student Dashboard</h2>

{% if active_attempt %}
<div class="notification is-warning is-light">
  <strong>‚è≥ Active Exam:</strong> {{ active_attempt.exam.title }}
  <a class="button is-small is-dark ml-2"
     href="{% url 'quiz:exam_take' active_attempt.id %}">
    Resume
  </a>
</div>
{% endif %}

{# ================= OVERALL PROGRESS ================= #}
<div class="box mb-5">
  <h3 class="title is-5">üìä Overall Progress</h3>

  <progress id="overallProgress"
            class="progress"
            value="{{ overall_passed }}"
            max="{{ overall_total|default:1 }}">
  </progress>

  <p class="is-size-7 has-text-grey">
    {{ overall_passed }} / {{ overall_total }} exams completed
    (<span id="overallPercent">0</span>%)
  </p>
</div>

{# ================= STATS ================= #}
<div class="columns is-multiline">
  <div class="column is-4">
    <div class="box has-text-centered">
      <p class="heading">Total Attempts</p>
      <p class="title is-4">{{ total_attempts }}</p>
    </div>
  </div>
  <div class="column is-4">
    <div class="box has-text-centered has-text-success">
      <p class="heading">Passed</p>
      <p class="title is-4">{{ passed_count }}</p>
    </div>
  </div>
  <div class="column is-4">
    <div class="box has-text-centered has-text-danger">
      <p class="heading">Failed</p>
      <p class="title is-4">{{ failed_count }}</p>
    </div>
  </div>
</div>

{# ================= TRACKS ================= #}
{% for track, data in track_map.items %}
<div class="box mb-4">

  <!-- TRACK HEADER -->
  <div class="is-flex is-justify-content-space-between is-align-items-center">
    <h3 class="title is-6 mb-0">
      üìò {{ track.title }}

      {% if data.is_completed %}
        <span class="tag is-success is-light ml-2"
              title="Completed on {{ data.completed_at|date:'d M Y' }}">
          üèÜ Completed
        </span>
      {% endif %}

      {% if data.avg_score is not None %}
        <span class="tag is-info is-light ml-2">
          üìà Avg {{ data.avg_score }}%
        </span>
      {% endif %}
    </h3>

    <button class="button is-small is-light"
            onclick="toggleTrack('{{ track.id }}')">
      <span id="arrow-{{ track.id }}">‚ñº</span>
    </button>
  </div>

  <!-- TRACK BODY -->
  <div id="track-body-{{ track.id }}" style="display:none; margin-top:1rem">

    {% for item in data.items %}
    <div class="box mb-2">
      <div class="is-flex is-justify-content-space-between is-align-items-center">

        <div>
          <strong>{{ item.exam.title }}</strong><br>
          <small class="has-text-grey">
            Level {{ item.exam.level }} ‚Ä¢
            {{ item.exam.question_count }} Q ‚Ä¢
            {{ item.exam.duration_seconds }} sec
          </small>

          {% if item.locked %}
            <p class="has-text-danger is-size-7 mt-1">
              üîí {{ item.lock_reason }}
            </p>
          {% endif %}
        </div>

        <div class="buttons">

          {# ===== PASSED ===== #}
          {% if item.status == "passed" %}
            <span class="tag is-success">
              ‚úî Passed
              {% if item.best_score is not None %}
                ({{ item.best_score }}%)
              {% endif %}
            </span>

            <a class="button is-light is-small ml-2"
               href="{% url 'quiz:exam_start' item.exam.id %}">
              Retake
            </a>

          {# ===== FAILED ===== #}
          {% elif item.status == "failed" %}
            <span class="tag is-danger">
              ‚úñ Failed
              {% if item.last_score is not None %}
                ({{ item.last_score }}%)
              {% endif %}
            </span>

            {% if item.action == "cooldown" %}
              <button class="button is-light is-small ml-2" disabled>
                ‚è≥ Retry in
                <span class="retry-timer"
                      data-seconds="{{ item.cooldown_remaining }}">
                  --:--
                </span>
              </button>
            {% else %}
              <a class="button is-primary is-small ml-2"
                 href="{% url 'quiz:exam_start' item.exam.id %}">
                Retry
              </a>
            {% endif %}

          {# ===== RESUME ===== #}
          {% elif item.action == "resume" %}
            <a class="button is-warning is-small"
               href="{% url 'quiz:exam_take' item.last_attempt.id %}">
              Resume
            </a>

          {# ===== START ===== #}
          {% else %}
            <a class="button is-primary is-small"
               href="{% url 'quiz:exam_start' item.exam.id %}">
              Start
            </a>
          {% endif %}

        </div>
      </div>
    </div>
    {% endfor %}

  </div>
</div>
{% endfor %}

{# ================= JS ================= #}
<script>
function toggleTrack(id) {
  const body = document.getElementById("track-body-" + id);
  const arrow = document.getElementById("arrow-" + id);
  if (!body) return;

  const open = body.style.display === "block";
  body.style.display = open ? "none" : "block";
  arrow.innerText = open ? "‚ñº" : "‚ñ≤";
}

// Overall progress color
(function () {
  const bar = document.getElementById("overallProgress");
  if (!bar) return;

  const value = Number(bar.value || 0);
  const max = Number(bar.max || 1);
  const percent = Math.round((value / max) * 100);

  document.getElementById("overallPercent").innerText = percent;

  bar.classList.remove("is-danger", "is-warning", "is-success");
  if (percent < 40) bar.classList.add("is-danger");
  else if (percent < 70) bar.classList.add("is-warning");
  else bar.classList.add("is-success");
})();

// Retry countdown timers
(function () {
  function format(sec) {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
  }

  document.querySelectorAll(".retry-timer").forEach(el => {
    let seconds = parseInt(el.dataset.seconds || "0");
    const btn = el.closest("button");

    function tick() {
      if (seconds <= 0) {
        el.innerText = "00:00";
        if (btn) {
          btn.disabled = false;
          btn.classList.remove("is-light");
          btn.classList.add("is-primary");
          btn.innerHTML = "Retry";
        }
        return;
      }
      el.innerText = format(seconds);
      seconds--;
      setTimeout(tick, 1000);
    }
    tick();
  });
})();
</script>

{% endblock %}
