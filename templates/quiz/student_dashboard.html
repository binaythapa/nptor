{% extends "quiz/base.html" %}
{% block content %}

<h2 class="title is-4">üéì Student Dashboard</h2>

{% if active_attempt %}
<div class="notification is-warning is-light">
  <strong>‚è≥ Active Exam:</strong> {{ active_attempt.exam.title }}
  <a class="button is-small is-dark ml-2"
     href="{% url 'quiz:exam_take' active_attempt.id %}">
    Resume
  </a>
</div>
{% endif %}

{# ================= OVERALL PROGRESS ================= #}
<div class="box mb-5">
  <h3 class="title is-5">üìä Overall Progress</h3>

  <progress id="overallProgress"
            class="progress"
            value="{{ overall_passed }}"
            max="{{ overall_total|default:1 }}">
  </progress>

  <p class="is-size-7 has-text-grey">
    {{ overall_passed }} / {{ overall_total }} exams completed
    (<span id="overallPercent">0</span>%)
  </p>
</div>

{# ================= TRACKS ================= #}
{% for track, data in track_map.items %}
<div class="box mb-4">

  <!-- TRACK HEADER -->
  <div class="is-flex is-justify-content-space-between is-align-items-center">
    <h3 class="title is-6 mb-0">
      üìò {{ track.title }}

      {% if data.is_completed %}
        <span class="tag is-success is-light ml-2">
          üèÜ Completed
        </span>
      {% endif %}

      {% if data.avg_score %}
        <span class="tag is-info is-light ml-2"
              title="Calculated using your best score from each exam in this track">
          üìà Avg {{ data.avg_score }}% (best score per exam)
        </span>
      {% endif %}
    </h3>

    <button class="button is-small is-light"
            onclick="toggleTrack('{{ track.id }}')">
      <span id="arrow-{{ track.id }}">‚ñº</span>
    </button>
  </div>

  <!-- TRACK BODY -->
  <div id="track-body-{{ track.id }}" style="display:none; margin-top:1rem">

    {% for item in data.items %}
    <div class="box mb-2">
      <div class="is-flex is-justify-content-space-between is-align-items-center">

        <div>
          <strong>{{ item.exam.title }}</strong><br>
          <small class="has-text-grey">
            Level {{ item.exam.level }} ‚Ä¢
            {{ item.exam.question_count }} Q ‚Ä¢
            {{ item.exam.duration_seconds }} sec
          </small>
        </div>

        <div class="buttons">

          {# ===== PASSED ===== #}
          {% if item.status == "passed" %}
            <span class="tag is-success">
              ‚úî Passed ({{ item.best_score }}%)
            </span>

            {% if item.retake_count > 0 %}
              <span class="tag is-light ml-1">
                üîÅ {{ item.retake_count }} retake{{ item.retake_count|pluralize }}
              </span>
            {% endif %}

            {% if item.retake_message %}
              <span class="tag ml-1">
                {{ item.retake_message }}
              </span>
            {% endif %}

            <a class="button is-light is-small ml-2"
               href="{% url 'quiz:exam_start' item.exam.id %}">
              Retake
            </a>

          {# ===== FAILED ===== #}
          {% elif item.status == "failed" %}
            <span class="tag is-danger">
              ‚úñ Failed ({{ item.last_score }}%)
            </span>

            {% if item.action == "cooldown" %}
              <button class="button is-light is-small ml-2" disabled>
                ‚è≥ Retry in
                <span class="retry-timer"
                      data-seconds="{{ item.cooldown_remaining }}">
                  --:--
                </span>
              </button>
            {% else %}
              <a class="button is-primary is-small ml-2"
                 href="{% url 'quiz:exam_start' item.exam.id %}">
                Retry
              </a>
            {% endif %}

          {# ===== RESUME ===== #}
          {% elif item.action == "resume" %}
            <a class="button is-warning is-small"
               href="{% url 'quiz:exam_take' item.last_attempt.id %}">
              Resume
            </a>

          {# ===== START ===== #}
          {% else %}
            <a class="button is-primary is-small"
               href="{% url 'quiz:exam_start' item.exam.id %}">
              Start
            </a>
          {% endif %}

        </div>
      </div>
    </div>
    {% endfor %}

  </div>
</div>
{% endfor %}

{# ================= STYLES ================= #}
<style>
@keyframes pulseDanger {
  0%   { transform: scale(1); background-color: #ffecec; }
  50%  { transform: scale(1.05); background-color: #ffb3b3; }
  100% { transform: scale(1); background-color: #ffecec; }
}

.retry-pulse {
  animation: pulseDanger 1s infinite;
  color: #b00020;
  font-weight: 600;
  padding: 0 4px;
  border-radius: 4px;
}
</style>

{# ================= JS ================= #}
<script>
document.addEventListener("DOMContentLoaded", function () {

  // Accordion toggle
  window.toggleTrack = function (id) {
    const body = document.getElementById("track-body-" + id);
    const arrow = document.getElementById("arrow-" + id);
    const open = body.style.display === "block";
    body.style.display = open ? "none" : "block";
    arrow.innerText = open ? "‚ñº" : "‚ñ≤";
  };

  // Overall progress coloring
  const bar = document.getElementById("overallProgress");
  if (bar) {
    const percent = Math.round((bar.value / (bar.max || 1)) * 100);
    document.getElementById("overallPercent").innerText = percent;

    bar.classList.add(
      percent < 40 ? "is-danger" :
      percent < 70 ? "is-warning" : "is-success"
    );
  }

  // Retry countdown + pulse animation
  function format(sec) {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  document.querySelectorAll(".retry-timer").forEach(el => {
    let seconds = parseInt(el.dataset.seconds || "0", 10);
    const button = el.closest("button");

    function tick() {
      if (seconds <= 0) {
        el.innerText = "00:00";
        el.classList.remove("retry-pulse");

        if (button) {
          button.disabled = false;
          button.classList.remove("is-light");
          button.classList.add("is-primary");
          button.innerHTML = "Retry";
        }
        return;
      }

      el.innerText = format(seconds);

      if (seconds <= 10) {
        el.classList.add("retry-pulse");
      }

      seconds--;
      setTimeout(tick, 1000);
    }

    tick();
  });

});
</script>

{% endblock %}
