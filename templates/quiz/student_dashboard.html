{% extends 'quiz/base.html' %}
{% block title %}Student Dashboard - Objective Exam{% endblock %}

{% block head_extra %}
<style>
  /* Small, attractive Start button */
  .start-btn {
    padding: 4px 14px;
    background: linear-gradient(135deg, #4a90e2, #007bff);
    color: #fff !important;
    border-radius: 999px;
    font-size: 0.8rem;
    text-decoration: none;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: 0.22s ease;
  }
  .start-btn:hover {
    background: linear-gradient(135deg, #007bff, #0056c1);
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.28);
  }

  .locked-chip {
    padding: 4px 12px;
    font-size: 0.75rem;
    border-radius: 999px;
    background: #f1f3f5;
    color: #a0a0a0;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .category-heading {
    margin: 0.75rem 0 0.35rem;
    font-weight: 600;
    font-size: 0.95rem;
    color: #444;
    border-left: 3px solid #3273dc;
    padding-left: 6px;
  }
</style>
{% endblock %}

{% block content %}
<section class="page-top">
  <div class="level">
    <div class="level-left">
      <div>
        <h1 class="title is-3">Welcome , {{ user.first_name|default:user.username }} ðŸ‘‹</h1>
        <p class="small-muted">Choose an exam to practice or continue your active attempt.</p>
      </div>
    </div>

    <div class="level-right">
      <div class="buttons">
        <a class="button is-white" href="{% url 'quiz:exam_list' %}">
          <i class="fa fa-search"></i>&nbsp; Browse all Exams
        </a>
        <a class="button is-primary" href="{% url 'quiz:profile' %}">
          <i class="fa fa-user"></i>&nbsp; Edit profile
        </a>
      </div>
    </div>
  </div>
</section>

<!-- dashboard grid -->
<div class="grid-dashboard">
  <!-- left column: exams list -->
  <div class="left-col">
    <div class="card card-surface">
      <div class="card-header">
        <div>
          <h3 class="title is-5">Available Exams</h3>
          <p class="small-muted">Exams are grouped by category. Locked exams show the requirement.</p>
        </div>
      </div>

      <div class="card-body">
        <div class="exams-grid">
          {% if exam_items %}
            {# Group dashboard items by exam.category #}
            {% regroup exam_items by exam.category as category_groups %}

            {% for group in category_groups %}
              <h4 class="category-heading">
                {% if group.grouper %}
                  {{ group.grouper }}   {# Category __str__() #}
                {% else %}
                  General
                {% endif %}
              </h4>

              {% for item in group.list %}
                {% with e=item.exam %}
                <article class="exam-card {% if item.locked %}locked{% endif %}">
                  <div class="exam-meta">
                    <div class="exam-title">
                      <strong>{{ e.title }}</strong>
                      <span class="tag is-light is-small">Level {{ e.level|default:"-" }}</span>
                    </div>

                    <div class="exam-sub">
                         {{ item.category_label }}
                            </div>

                  </div>

                  <div class="exam-body">
                    <div class="exam-info">
                      <div class="muted">â€¢ {{ e.question_count }} Q â€¢ {{ e.duration_seconds }}s</div>
                      <div class="muted" style="margin-top:6px;">
                        {{ e.description|default:"No description" }}
                      </div>
                    </div>

                    <div class="exam-actions">
                      {% if item.locked %}
                        <span class="locked-chip">
                          <i class="fa fa-lock"></i> Locked
                        </span>
                        {% if item.reason %}
                          <div class="muted small-muted" style="margin-top:6px;">
                            {{ item.reason }}
                          </div>
                        {% endif %}
                      {% else %}
                        <a class="start-btn" href="{% url 'quiz:exam_start' e.id %}">
                          <i class="fa fa-play"></i> Start
                        </a>
                      {% endif %}

                      {% if e.passing_score %}
                        <div class="passing" style="margin-top:6px;">
                          Passing: <strong>{{ e.passing_score }}%</strong>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </article>
                {% endwith %}
              {% endfor %}
            {% endfor %}
          {% else %}
            <div class="small-muted">No exams available.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- recent attempts summary -->
    <div class="card card-surface" style="margin-top:18px;">
      <div class="card-header">
        <h3 class="title is-5">Your Recent Results</h3>
      </div>
      <div class="card-body">
        <table class="table is-fullwidth is-striped">
          <thead>
            <tr>
              <th>Exam</th>
              <th>Date</th>
              <th>Score</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for r in recent_attempts %}
              <tr>
                <td>{{ r.exam.title }}</td>
                <td>{{ r.submitted_at|date:"SHORT_DATETIME_FORMAT" }}</td>
                <td>{% if r.submitted_at %}{{ r.score }}%{% else %}-{% endif %}</td>
                <td>
                  {% if r.submitted_at %}
                    Completed
                  {% else %}
                    <em>In progress</em>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="small-muted">No attempts yet</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- right column: stats & quick actions -->
  <aside class="right-col">
    <div class="card card-surface stats-overview">
      <h4 class="title is-5">Quick Stats</h4>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value">{{ attempted_count }}</div>
          <div class="stat-label">Completed Attempts</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ best_score }}%</div>
          <div class="stat-label">Best score</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ exams|length }}</div>
          <div class="stat-label">Available Exams</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{% if active_attempt %}1{% else %}0{% endif %}</div>
          <div class="stat-label">Active Attempt</div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <a class="button is-primary is-fullwidth" href="{% url 'quiz:exam_list' %}">Browse Exams</a>
        <a class="button is-light is-fullwidth" href="{% url 'quiz:profile' %}" style="margin-top:8px;">Edit profile</a>
      </div>
    </div>

    <!-- help / hints -->
    <div class="card card-surface" style="margin-top:14px;">
      <h4 class="title is-6">Hints</h4>
      <ul class="small-muted">
        <li>Locked exams require passing earlier levels or prerequisites.</li>
        <li>Your active exam will appear at the top when you resume.</li>
      </ul>
    </div>
  </aside>
</div>

{% endblock %}
