{% extends "quiz/base.html" %}
{% block content %}

<h2 class="title is-4">ğŸ“ Student Dashboard</h2>

{% if active_attempt %}
<div class="notification is-warning is-light">
  <strong>â³ Active Exam:</strong> {{ active_attempt.exam.title }}
  <a class="button is-small is-dark ml-2"
     href="{% url 'quiz:exam_take' active_attempt.id %}">
    Resume
  </a>
</div>
{% endif %}

<!-- ================= STATS ================= -->
<div class="columns is-mobile">
  <div class="column is-4">
    <div class="box has-text-centered">
      <p class="heading">Attempts</p>
      <p class="title">{{ total_attempts }}</p>
    </div>
  </div>
  <div class="column is-4">
    <div class="box has-text-centered has-text-success">
      <p class="heading">Passed</p>
      <p class="title">{{ passed_count }}</p>
    </div>
  </div>
  <div class="column is-4">
    <div class="box has-text-centered has-text-danger">
      <p class="heading">Failed</p>
      <p class="title">{{ failed_count }}</p>
    </div>
  </div>
</div>

{% for track, data in track_map.items %}
<div class="box">

  <!-- ===== TRACK HEADER (UPDATED) ===== -->
  <button class="button is-light is-fullwidth"
          onclick="this.nextElementSibling.classList.toggle('is-hidden')">
    <strong>ğŸ“˜ {{ track.title }}</strong>

    <span class="tag is-info is-light ml-2">
      {{ data.items|length }} exams
    </span>

    {% if data.attempted %}
      {% if data.passed %}
        <span class="tag is-success is-light ml-1">
          âœ… {{ data.passed }} passed
        </span>
      {% endif %}
      {% if data.failed %}
        <span class="tag is-danger is-light ml-1">
          âŒ {{ data.failed }} failed
        </span>
      {% endif %}
    {% endif %}
  </button>

  <div class="mt-3 is-hidden">

    {% for item in data.items %}
    <div class="box mb-3">

      <strong>{{ item.exam.title }}</strong><br>
      <small class="has-text-grey">
        Level {{ item.exam.level }} â€¢ {{ item.exam.question_count }} Q
      </small>

      {% if item.last_score is not None %}
        <p class="is-size-7 mt-1">
          {% if item.status == "passed" %}
            âœ… Passed ({{ item.last_score }}%)
          {% elif item.status == "failed" %}
            âŒ Failed ({{ item.last_score }}%)
          {% endif %}
        </p>
      {% endif %}

      <!-- ACTIONS -->
      <div class="buttons mt-3 is-flex-direction-column">

        {% if item.is_passed %}
          <span class="tag is-success is-light">
            âœ” Exam completed
          </span>

        {% elif item.action == "resume" %}
          <a class="button is-warning is-small"
             href="{% url 'quiz:exam_take' item.last_attempt.id %}">
            Resume
          </a>

        {% elif item.action == "cooldown" %}
          <span class="tag is-warning is-light">
            â³ Retake locked
          </span>
          <span class="tag is-warning mt-1"
                data-countdown="{{ item.cooldown_remaining }}">
            Retake in <strong class="countdown-text"></strong>
          </span>

        {% elif item.action == "retake" %}
          <a class="button is-primary is-small"
             href="{% url 'quiz:exam_start' item.exam.id %}">
            ğŸ” Retake (Real Exam)
          </a>

        {% elif item.action == "start" %}
          <a class="button is-primary is-small"
             href="{% url 'quiz:exam_start' item.exam.id %}">
            â–¶ Start Exam
          </a>
        {% endif %}

        {% if not item.is_passed and item.status == "failed" %}
          {% if item.mock_used < item.mock_allowed %}
            <a class="button is-info is-small is-fullwidth-mobile mb-2"
               href="{% url 'quiz:mock_exam_start' item.exam.id %}">
              â­ Recommended: Take Mock Exam
            </a>
          {% else %}
            <span class="tag is-light">
              ğŸ§ª Mock limit reached. Contact admin to reset.
            </span>
          {% endif %}
        {% endif %}

      </div>

      {% if not item.is_passed and item.mock_attempts %}
      <div class="mt-2">
        <p class="is-size-7 has-text-grey">
          ğŸ§ª Mock Attempts ({{ item.mock_used }}/{{ item.mock_allowed }})
        </p>
        <ul class="is-size-7">
          {% for m in item.mock_attempts %}
            <li>â€¢ {{ m.score }}%</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

    </div>
    {% endfor %}
  </div>
</div>
{% endfor %}

<script>
document.querySelectorAll("[data-countdown]").forEach(el => {
  let seconds = parseInt(el.dataset.countdown);
  const t = el.querySelector(".countdown-text");
  function tick() {
    if (seconds <= 0) { location.reload(); return; }
    t.innerText = `${Math.floor(seconds/60)}m ${seconds%60}s`;
    seconds--; setTimeout(tick, 1000);
  }
  tick();
});
</script>

{% endblock %}
