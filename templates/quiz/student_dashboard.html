{% extends 'quiz/base.html' %}
{% load static %}
{% block title %}Student Dashboard (No-JS){% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
/* ===========================
   CSS-only, mobile-first template
   =========================== */

/* Variables */
:root{
  --muted:#6f6f6f;
  --accent:#2f6ef8;
  --card-bg:#ffffff;
  --surface:#fbfbfd;
  --success:#16a34a;
  --danger:#ef4444;
  --radius:12px;
  --gap:12px;
  --tiny:0.78rem;
  --sm:0.88rem;
  --md:0.96rem;
}

/* Base */
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; color:#111827; }
.container { padding:16px; }
.header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
.small-muted { color:var(--muted); font-size:var(--sm); }

/* Details/summary appearance */
details.category {
  border:1px solid #eef2f7;
  border-radius:10px;
  background:var(--card-bg);
  margin-bottom:12px;
  box-shadow: 0 6px 18px rgba(15,23,42,0.04);
  overflow:hidden;
}
details.category > summary {
  list-style:none;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  gap:10px;
}
details.category > summary::-webkit-details-marker { display:none; } /* hide default marker */
.summary-left { display:flex; gap:12px; align-items:center; }
.cat-title { font-weight:600; font-size:var(--md); }
.cat-meta { color:var(--muted); font-size:var(--sm); }

/* exam tile inside details */
.exam-tile {
  padding:12px;
  border-top:1px solid #f6f7fa;
  display:flex;
  flex-direction:column;
  gap:8px;
}
@media(min-width:720px){
  .exam-tile { flex-direction:row; align-items:center; justify-content:space-between; }
}

/* title + meta */
.exam-left { min-width:0; }
.exam-title { font-weight:600; font-size:0.98rem; display:flex; gap:8px; align-items:center; }
.exam-meta { font-size:0.86rem; color:var(--muted); margin-top:4px; display:flex; gap:10px; flex-wrap:wrap; }

/* score and actions */
.right-block { display:flex; gap:12px; align-items:center; margin-top:6px; }
@media(min-width:720px){ .right-block { margin-top:0; } }

.score-num { font-size:0.92rem; font-weight:400; }
.score-bar { height:8px; width:120px; background:#f1f3f5; border-radius:999px; overflow:hidden; display:inline-block; vertical-align:middle; }
.score-fill { height:100%; width:0%; display:block; }

/* badges */
.badge { display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border-radius:999px; font-size:0.78rem; }
.badge.best { background:#fff7ed; color:#a45a00; border:1px solid rgba(164,90,0,0.06); }
.badge.passed { background:#ecfdf5; color:var(--success); border:1px solid rgba(22,163,74,0.08); }
.badge.failed { background:#fff5f5; color:var(--danger); border:1px solid rgba(239,68,68,0.06); }
.locked { padding:6px 10px; border-radius:999px; background:#f4f5f7; color:#666; font-size:0.86rem; }

/* summary chevron using CSS */
summary .chev {
  width:24px; height:24px; display:inline-flex; align-items:center; justify-content:center;
  border-radius:6px; color:var(--accent); background:rgba(47,110,248,0.06); font-size:0.9rem;
}
details[open] > summary .chev { transform:rotate(180deg); }

/* attempts panel inside details (use nested details) */
details.attempts { border-top:1px dashed #f1f5f9; padding:10px 12px; background:#fff; }
.attempts-table { width:100%; border-collapse:collapse; font-size:0.88rem; }
.attempts-table th, .attempts-table td { padding:8px 6px; border-bottom:1px solid #f3f4f6; text-align:left; }

/* buttons (links styled) */
.link-btn { display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px; text-decoration:none; font-size:0.90rem; color:#fff; }
.link-btn.start { background:linear-gradient(135deg,#3c8dff,#2066ff); }
.link-btn.resume { background:linear-gradient(135deg,#f3b54a,#f07b1a); }
.link-btn.retake { background:linear-gradient(135deg,#ff8a00,#e74c3c); }
.ghost { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid rgba(47,110,248,0.08); color:var(--accent); text-decoration:none; }

/* small helpers */
.meta-small { color:var(--muted); font-size:0.82rem; }

/* responsive adjustments */
@media(min-width:720px){
  .container { padding:20px; }
  .cat-title { font-size:1.05rem; }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="header">
    <div>
      <h1 style="margin:0;">Welcome, {{ user.first_name|default:user.username }}</h1>
      <div class="small-muted">Tap to expand a category — works without JavaScript.</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="ghost" href="{% url 'quiz:exam_list' %}">Browse</a>
      <a class="ghost" href="{% url 'quiz:profile' %}">Profile</a>
    </div>
  </div>

  {% regroup exam_items by category_label as category_groups %}

  {% for group in category_groups %}
    <details class="category" {% if forloop.first %}open{% endif %}>
      <summary>
        <div class="summary-left">
          <div class="cat-title">
            <i class="fa fa-layer-group" style="color:var(--accent)"></i>
            {% if group.grouper %}{{ group.grouper }}{% else %}General{% endif %}
          </div>
          <div class="cat-meta">({{ group.list|length }} exams)</div>
        </div>
        <div class="chev" aria-hidden="true"><i class="fa fa-chevron-down"></i></div>
      </summary>

      {% for item in group.list %}
        {% with e=item.exam %}
        <div class="exam-tile">
          <div class="exam-left">
            <div class="exam-title">
              <span>{{ e.title }}</span>
              {% if item.best_score %}
                <span class="badge best">{{ item.best_score|floatformat:2 }}%</span>
              {% endif %}
            </div>

            <div class="exam-meta">
              <div class="meta-small"><i class="fa fa-pen-to-square"></i>&nbsp; Q: {{ e.question_count }}</div>
              <div class="meta-small"><i class="fa fa-stopwatch"></i>&nbsp; {{ e.duration_seconds }}s</div>
              <div class="meta-small"><i class="fa fa-bullseye"></i>&nbsp; Pass: {% if e.passing_score %}{{ e.passing_score|floatformat:2 }}%{% else %}-{% endif %}</div>
              {% if item.category_label %}
                <div class="meta-small"><i class="fa fa-folder"></i>&nbsp; {{ item.category_label }}</div>
              {% endif %}
            </div>
          </div>

          <div class="right-block">
            <div>
              {% if item.recent_status == 'completed' %}
                <div class="score-num">{{ item.recent_score|floatformat:2 }}%</div>
                <div class="score-bar" title="Score {{ item.recent_score|floatformat:2 }}%">
                  {# inline width set directly so CSS-only displays correct fill #}
                  {% if e.passing_score %}
                    {% if item.recent_score >= e.passing_score %}
                      <span class="score-fill" style="width:{{ item.recent_score }}%; background:linear-gradient(90deg,#34d399,#10b981)"></span>
                    {% elif item.pass_threshold and item.recent_score >= item.pass_threshold %}
                      <span class="score-fill" style="width:{{ item.recent_score }}%; background:linear-gradient(90deg,#ffb86b,#ff8a00)"></span>
                    {% else %}
                      <span class="score-fill" style="width:{{ item.recent_score }}%; background:linear-gradient(90deg,#ff7b7b,#f43f5e)"></span>
                    {% endif %}
                  {% else %}
                    <span class="score-fill" style="width:{{ item.recent_score }}%; background:#7dd3a6"></span>
                  {% endif %}
                </div>
                <div class="meta-small" style="text-align:right; margin-top:6px;">{{ item.last_attempt.submitted_at|date:"SHORT_DATETIME_FORMAT" }}</div>
              {% elif item.recent_status == 'in_progress' %}
                <div class="meta-small">In progress</div>
              {% else %}
                <div class="meta-small">Not attempted</div>
              {% endif %}
            </div>

            <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
              {% if item.locked %}
                <div class="locked"><i class="fa fa-lock"></i>&nbsp;Locked</div>
              {% else %}
                {% if item.action_label == 'Start' %}
                  <a class="link-btn start" href="{% url 'quiz:exam_start' e.id %}"><i class="fa fa-play"></i> Start</a>
                {% elif item.action_label == 'Resume' %}
                  <a class="link-btn resume" href="{% url 'quiz:exam_take' item.last_attempt.id %}"><i class="fa fa-play"></i> Resume</a>
                {% elif item.action_label == 'Retake' %}
                  <a class="link-btn retake" href="{% url 'quiz:exam_start' e.id %}"><i class="fa fa-redo"></i> Retake</a>
                {% endif %}
              {% endif %}

              {% if item.attempts %}
                {# nested details for attempts (CSS-only toggle) #}
                <details class="attempts" aria-label="Attempts for {{ e.title }}">
                  <summary class="meta-small" style="cursor:pointer; list-style:none; padding:6px 0;">
                    <i class="fa fa-history" style="color:var(--accent)"></i> {{ item.attempts|length }} attempts — click to view
                  </summary>
                  <div style="padding-top:8px;">
                    <table class="attempts-table">
                      <thead>
                        <tr><th>Date</th><th>Score</th><th>Status</th></tr>
                      </thead>
                      <tbody>
                        {% for r in item.attempts %}
                          <tr>
                            <td>{{ r.submitted_at|date:"SHORT_DATETIME_FORMAT" }}</td>
                            <td>{{ r.score|floatformat:2 }}%</td>
                            <td>
                              {% if r.passed %}
                                <span class="badge passed">Passed</span>
                              {% else %}
                                <span class="badge failed">Failed</span>
                              {% endif %}
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    <div style="margin-top:8px; text-align:right;">
                      <a class="ghost" href="{% url 'quiz:exam_result' user_exam_id=item.last_attempt.id %}">View latest</a>
                    </div>
                  </div>
                </details>
              {% endif %}
            </div>
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    </details>
  {% endfor %}

  <!-- stats block -->
  <div style="margin-top:12px; border:1px solid #f0f2f7; border-radius:10px; padding:12px; background:var(--card-bg);">
    <h4 style="margin:0 0 8px 0; font-size:0.95rem">Quick Stats</h4>
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <div><strong>{{ attempted_count }}</strong> Completed</div>
      <div><strong>{{ best_score|floatformat:2 }}%</strong> Best</div>
      {% if active_attempt %}
        <div><a class="ghost" href="{% url 'quiz:exam_take' user_exam_id=active_attempt.id %}">Resume active</a></div>
      {% endif %}
      <div><a class="ghost" href="{% url 'quiz:exam_list' %}">Browse</a></div>
    </div>
  </div>
</div>
{% endblock %}
