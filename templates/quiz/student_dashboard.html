{% extends "quiz/base.html" %}{% block content %}

<h2 class="title is-4">üéì Student Dashboard</h2>

{# ================= ACTIVE EXAM ================= #}
{% if active_attempt %}
<div class="notification is-warning is-light">
  <strong>‚è≥ Active Exam:</strong>
  {{ active_attempt.exam.title }}
  <a class="button is-small is-dark ml-2"
     href="{% url 'quiz:exam_take' active_attempt.id %}">
    Resume
  </a>
</div>
{% endif %}

{# ================= STATS ================= #}
<div class="columns is-multiline">
  <div class="column is-4">
    <div class="box has-text-centered">
      <p class="heading">Total Attempts</p>
      <p class="title is-4">{{ total_attempts }}</p>
    </div>
  </div>

  <div class="column is-4">
    <div class="box has-text-centered has-text-success">
      <p class="heading">Passed</p>
      <p class="title is-4">{{ passed_count }}</p>
    </div>
  </div>

  <div class="column is-4">
    <div class="box has-text-centered has-text-danger">
      <p class="heading">Failed</p>
      <p class="title is-4">{{ failed_count }}</p>
    </div>
  </div>
</div>

{# ================= EXAMS BY TRACK (ACCORDION) ================= #}
{% if track_map %}
  {% for track, items in track_map.items %}

  <div class="track-accordion">

    <!-- TRACK HEADER -->
    <button class="track-header" type="button">
      <div class="track-left">
        <span class="track-title">üìò {{ track }}</span>
        <span class="track-count">
          {{ items|length }} Exams
        </span>
      </div>
      <i class="fa fa-chevron-down track-arrow"></i>
    </button>

    <!-- TRACK BODY -->
    <div class="track-body">

      {% for item in items %}
      <div class="box mb-3">
        <div class="is-flex is-justify-content-space-between is-align-items-center">

          <div>
            <strong>{{ item.exam.title }}</strong><br>
            <small class="has-text-grey">
              Level {{ item.exam.level }} ‚Ä¢
              {{ item.exam.question_count }} Questions ‚Ä¢
              {{ item.exam.duration_seconds }} sec
            </small>

            {% if item.locked %}
              <p class="has-text-danger is-size-7 mt-1">
                üîí {{ item.lock_reason }}
              </p>
            {% endif %}
          </div>

          <div class="buttons">

            {% if item.status == "passed" %}
              <div class="passed-row">
                <span class="tag is-success is-medium">‚úî Passed</span>
                <a class="button is-light is-small ml-2"
                   href="{% url 'quiz:exam_start' item.exam.id %}">
                  Retake
                </a>
              </div>

            {% elif item.action == "resume" %}
              <a class="button is-warning is-small"
                 href="{% url 'quiz:exam_take' item.last_attempt.id %}">
                Resume
              </a>

            {% elif item.action == "cooldown" %}
              <button class="button is-light is-small" disabled>
                ‚è≥ Retake locked
              </button>
              <span class="has-text-grey is-size-7 ml-2"
                    data-countdown="{{ item.cooldown_remaining }}">
                Retake in <strong class="countdown-text"></strong>
              </span>

            {% elif item.action == "start" or item.action == "retake" %}
              <a class="button is-primary is-small"
                 href="{% url 'quiz:exam_start' item.exam.id %}">
                {% if item.action == "retake" %}Retake{% else %}Start{% endif %}
              </a>

            {% else %}
              <button class="button is-light is-small" disabled>
                üîí Locked
              </button>
            {% endif %}

            <button class="button is-info is-light is-small ml-1" disabled>
              Mock (Coming Soon)
            </button>

          </div>
        </div>
      </div>
      {% endfor %}

    </div>
  </div>

  {% endfor %}
{% else %}
  <p>No exams available.</p>
{% endif %}

{# ================= COUNTDOWN SCRIPT ================= #}
<script>
document.querySelectorAll("[data-countdown]").forEach(el => {
  let seconds = parseInt(el.dataset.countdown);
  const textEl = el.querySelector(".countdown-text");

  function tick() {
    if (seconds <= 0) {
      textEl.innerText = "now";
      return;
    }
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    textEl.innerText = `${m}m ${s}s`;
    seconds--;
    setTimeout(tick, 1000);
  }
  tick();
});
</script>

{% endblock %}
