{% extends "quiz/base.html" %}
{% block content %}

<style>
  /* ---------- Dashboard Enhancements ---------- */
  .stat-card {
    border-radius: 12px;
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,.08);
  }

  .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
  }

  .muted {
    color: #7a7a7a;
    font-size: .8rem;
  }

  .badge {
    padding: 4px 10px;
    border-radius: 999px;
    font-size: .75rem;
    font-weight: 600;
  }

  .badge-green { background: #e6f7ef; color: #157347; }
  .badge-yellow { background: #fff3cd; color: #856404; }
  .badge-red { background: #fdecea; color: #842029; }

  @media (max-width: 768px) {
    .stat-value {
      font-size: 1.4rem;
    }
  }
</style>

<!-- ================================================= -->
<!-- HEADER -->
<!-- ================================================= -->
<div class="mb-5 is-flex is-justify-content-space-between is-align-items-center">

  <div>
    <h2 class="title is-4 mb-1">ğŸ›  Admin Dashboard</h2>
    <p class="muted">
      Platform health, learning performance & subscription insights
    </p>
  </div>

  {% if user.is_staff %}
  <div class="buttons">
    <a href="{% url 'quiz:question_dashboard' %}"
       class="button is-link">
      ğŸ“š Manage Questions
    </a>

    <a href="{% url 'quiz:add_question' %}"
       class="button is-primary">
      â• Add Question
    </a>
  </div>
  {% endif %}

</div>



<!-- ================================================= -->
<!-- KPI ROW -->
<!-- ================================================= -->
<div class="columns is-multiline">

  <div class="column is-6-mobile is-3-tablet">
  <div class="box stat-card has-text-centered">
    <p class="heading">â“ Questions</p>
    <p class="stat-value has-text-primary">{{ total_questions }}</p>
    <p class="muted">Active questions</p>
  </div>
</div>


  <div class="column is-6-mobile is-3-tablet">
    <div class="box stat-card has-text-centered">
      <p class="heading">ğŸ‘¥ Users</p>
      <p class="stat-value">{{ total_users }}</p>
      <p class="muted">Registered learners</p>
    </div>
  </div>

  <div class="column is-6-mobile is-3-tablet">
    <div class="box stat-card has-text-centered">
      <p class="heading">ğŸ“ Attempts</p>
      <p class="stat-value">{{ total_attempts }}</p>
      <p class="muted">Submitted exams</p>
    </div>
  </div>

  <div class="column is-6-mobile is-3-tablet">
    <div class="box stat-card has-text-centered">
      <p class="heading">âœ… Pass Rate</p>
      <p class="stat-value has-text-success">{{ pass_rate }}%</p>
      <p class="muted">Success ratio</p>
    </div>
  </div>

  <div class="column is-6-mobile is-3-tablet">
    <div class="box stat-card has-text-centered">
      <p class="heading">ğŸ“Š Avg Score</p>
      <p class="stat-value has-text-info">
        {% if avg_score %}{{ avg_score }}%{% else %}â€”{% endif %}
      </p>
      <p class="muted">Across all exams</p>
    </div>
  </div>

</div>

<!-- ================================================= -->
<!-- SUBSCRIPTION SUMMARY -->
<!-- ================================================= -->
<h3 class="title is-5 mt-6 mb-3">ğŸ’³ Subscriptions Overview</h3>

<div class="columns is-multiline">

  <div class="column is-6-mobile is-3-tablet">
    <div class="box stat-card has-text-centered">
      <p class="heading">ğŸ“¦ Total</p>
      <p class="stat-value">{{ total_track_subs }}</p>
      <p class="muted">All subscriptions</p>
    </div>
  </div>

  <div class="column is-6-mobile is-3-tablet">
    <div class="box stat-card has-text-centered">
      <p class="heading">ğŸŸ¢ Active</p>
      <p class="stat-value has-text-success">{{ active_track_subs }}</p>
      <p class="muted">Currently valid</p>
    </div>
  </div>

  <div class="column is-6-mobile is-3-tablet">
    <div class="box stat-card has-text-centered">
      <p class="heading">â³ Expiring</p>
      <p class="stat-value has-text-warning">{{ expiring_soon }}</p>
      <p class="muted">Next 7 days</p>
    </div>
  </div>

  <div class="column is-6-mobile is-3-tablet">
    <div class="box stat-card has-text-centered">
      <p class="heading">ğŸ”´ Expired</p>
      <p class="stat-value has-text-danger">{{ expired_track_subs }}</p>
      <p class="muted">Needs renewal</p>
    </div>
  </div>

</div>

<!-- ================================================= -->
<!-- REVENUE & CONVERSION -->
<!-- ================================================= -->
<h3 class="title is-5 mt-6 mb-3">ğŸ“ˆ Revenue & Conversion</h3>

<div class="columns is-multiline">

  <div class="column is-6-mobile is-3-tablet">
    <div class="box stat-card has-text-centered">
      <p class="heading">ğŸ†“ Trial Users</p>
      <p class="stat-value">{{ trial_subs }}</p>
      <p class="muted">7-day trial</p>
    </div>
  </div>

  <div class="column is-6-mobile is-3-tablet">
    <div class="box stat-card has-text-centered">
      <p class="heading">ğŸ’° Paid Users</p>
      <p class="stat-value has-text-success">{{ paid_subs }}</p>
      <p class="muted">Converted</p>
    </div>
  </div>

  <div class="column is-6-mobile is-3-tablet">
    <div class="box stat-card has-text-centered">
      <p class="heading">ğŸ” Conversion</p>
      <p class="stat-value has-text-primary">{{ conversion_rate }}%</p>
      <p class="muted">Trial â†’ Paid</p>
    </div>
  </div>

  <div class="column is-6-mobile is-3-tablet">
    <div class="box stat-card has-text-centered">
      <p class="heading">ğŸ’¸ Revenue</p>
      <p class="stat-value has-text-success">â‚¹{{ total_revenue }}</p>
      <p class="muted">ARPU â‚¹{{ arpu }}</p>
    </div>
  </div>

</div>

<!-- ================================================= -->
<!-- TRACK ANALYTICS -->
<!-- ================================================= -->
<h3 class="title is-5 mt-6 mb-3">ğŸ“š Track Analytics</h3>

<div class="table-container">
  <table class="table is-fullwidth is-hoverable is-striped">
    <thead>
      <tr>
        <th>Track</th>
        <th>Enrolled</th>
        <th>Completed</th>
        <th>Completion</th>
        <th>Avg Score</th>
        <th>Revenue</th>
        <th>Drop-off</th>
      </tr>
    </thead>
    <tbody>
      {% for row in track_rows %}
      <tr>
        <td><strong>{{ row.track.title }}</strong></td>
        <td>{{ row.enrolled }}</td>
        <td>{{ row.completed }}</td>
        <td>
          <span class="badge badge-green">
            {{ row.completion_rate }}%
          </span>
        </td>
        <td>
          {% if row.avg_score %}
            {{ row.avg_score }}%
          {% else %}
            â€”
          {% endif %}
        </td>
        <td>â‚¹{{ row.revenue }}</td>
        <td>
          {% if row.drop_exam != "â€”" %}
            <span class="badge badge-red">{{ row.drop_exam }}</span>
          {% else %}
            â€”
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


<!-- ================================================= -->
<!-- RESET MOCK ATTEMPTS (ADMIN ONLY) -->
<!-- ================================================= -->
<h3 class="title is-5 mt-6 mb-3">ğŸ§ª Reset Mock Attempts</h3>

<div class="box">
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="reset_mock">

    <div class="columns is-multiline">

      <!-- STUDENT -->
      <div class="column is-4">
        <label class="label">Select Student</label>
        <div class="control">
          <div class="select is-fullwidth">
            <select name="user_id" required>
              <option value="">-- Select Student --</option>
              {% for u in students %}
                <option value="{{ u.id }}">
                  {{ u.username }} ({{ u.email }})
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <!-- EXAM -->
      <div class="column is-4">
        <label class="label">Select Exam</label>
        <div class="control">
          <div class="select is-fullwidth">
            <select name="exam_id" required>
              <option value="">-- Select Exam --</option>
              {% for e in exams %}
                <option value="{{ e.id }}">
                  {{ e.title }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <!-- ACTION -->
      <div class="column is-4 is-flex is-align-items-flex-end">
        <button
          class="button is-danger is-fullwidth"
          onclick="return confirm(
            'This will reset ALL mock attempts for this student and exam. Continue?'
          )">
          â™» Reset Mock Attempts
        </button>
      </div>

    </div>

    <p class="help has-text-grey mt-2">
      âš  This will delete <strong>mock exams only</strong>.  
      Real exam attempts are not affected.
    </p>
  </form>
</div>


{% endblock %}
