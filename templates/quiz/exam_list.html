{% extends 'quiz/base.html' %}

{% block content %}

<h2 class="subtitle">Available Exams</h2>

<div class="box">

    {% regroup exams by category as category_list %}

    {% for cat in category_list %}
        {% with first_exam=cat.list.0 %}
        <div class="box" style="margin-bottom: 1rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem;">

                <div>
                    <h3 class="title is-5" style="margin-bottom: 0;">
                        {{ cat.grouper }}
                    </h3>
                    <p class="is-size-7 has-text-grey">
                        Level-based exams under this category
                    </p>
                </div>

                <div style="display:flex; gap:0.5rem;">

                    {# Subscribe now acts like START â€” open first exam #}
                    <a class="button is-small is-primary"
                       href="{% url 'quiz:exam_start' first_exam.id %}">
                       Subscribe
                    </a>

                    <button type="button"
                            class="button is-small is-link is-light"
                            onclick="toggleLevels('levels-{{ forloop.counter }}', this)">
                        Show levels
                    </button>
                </div>

            </div>

            <div id="levels-{{ forloop.counter }}" style="display:none; margin-top:0.75rem;">
                <ul>
    {% for exam in cat.list %}
        <li style="margin-bottom: 0.5rem;">
            <strong>{{ exam.title }}</strong>
            â€” Level: {{ exam.level }}
            â€” Duration: {{ exam.duration_seconds }}s
            | Questions: {{ exam.question_count }}

            {% if exam.level == 1 %}
                <!-- Only Level 1 is enabled -->
                <a class="button is-small is-link"
                   href="{% url 'quiz:exam_start' exam.id %}">
                    Start
                </a>
            {% else %}
                <!-- Higher levels locked -->
                <button class="button is-small is-light" disabled>
                    ðŸ”’ Locked
                </button>
            {% endif %}
        </li>
    {% endfor %}
</ul>

            </div>
        </div>
        {% endwith %}
    {% empty %}
        <p>No published exams.</p>
    {% endfor %}

</div>

<script>
function toggleLevels(id, btn) {
    const el = document.getElementById(id);
    if (!el) return;

    const isHidden = (el.style.display === 'none' || el.style.display === '');
    el.style.display = isHidden ? 'block' : 'none';

    if (btn) {
        btn.textContent = isHidden ? 'Hide levels' : 'Show levels';
    }
}
</script>

{% endblock %}
