{% extends "quiz/base.html" %}
{% block content %}

<h2 class="title is-4">ðŸ“š Available Exam Tracks</h2>
<p class="has-text-grey mb-4">
  All exams require subscription. Free tracks require â‚¹0 subscription.
</p>

{% for track, items in track_map.items %}
<div class="box">

  <!-- ================= TRACK HEADER ================= -->
  <div class="is-flex is-justify-content-space-between is-align-items-center">
    <div>
      <h3 class="title is-5 mb-1">{{ track.title }}</h3>
      <p class="is-size-7 has-text-grey">
        {{ items|length }} Levels â€¢ Subscription:
        {{ track.subscription_scope|title }}
      </p>
    </div>

    {% if items.0.is_track_subscribed %}
      <span class="tag is-success is-light">âœ” Subscribed</span>
    {% elif track.is_free %}
      <span class="tag is-success is-light">ðŸ†“ Free</span>
    {% else %}
      <span class="tag is-warning is-light">ðŸ”’ Premium</span>
    {% endif %}
  </div>

  <!-- ================= TRACK-LEVEL SUBSCRIPTION ================= -->
  {% if track.subscription_scope == "track" and not items.0.is_track_subscribed %}
  <div class="notification is-light is-info mt-3">
    <strong>{{ track.title }}</strong><br>

    {% if track.is_free %}
      This is a free track. Subscribe to unlock all {{ items|length }} levels.
    {% else %}
      Unlock all {{ items|length }} levels with a subscription.
    {% endif %}

    <div class="buttons mt-3">
      {% if track.is_free %}
        <form method="post" action="{% url 'quiz:subscribe_track' track.id %}">
          {% csrf_token %}
          <button class="button is-success is-small">
            Subscribe Free
          </button>
        </form>
      {% else %}
        <div class="contact-enroll-wrapper">
          <button class="button is-warning is-small"
                  onclick="toggleEnrollMenu(this)">
            ðŸ“ž Contact to Enroll
          </button>

          <div class="contact-enroll-menu">
            <a href="https://wa.me/918754795806?text=Hi%20I%20want%20to%20enroll%20in%20{{ track.title }}"
               target="_blank"
               onclick="logLead('track','{{ track.id }}','whatsapp')"
               class="button is-success is-small is-fullwidth mb-1">
              WhatsApp
            </a>

            <a href="viber://chat?number=918754795806"
               onclick="logLead('track','{{ track.id }}','viber')"
               class="button is-link is-small is-fullwidth">
              Viber
            </a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <hr>

  <!-- ================= EXAMS ================= -->
  {% for item in items %}
  <div class="is-flex is-justify-content-space-between is-align-items-center mb-2">

    <div>
      <strong>Level {{ item.exam.level }}</strong> â€¢
      {{ item.exam.question_count }} questions â€¢
      {{ item.exam.duration_seconds }} sec
    </div>

    <!-- ================= EXAM-LEVEL SUBSCRIPTION ================= -->
    {% if track.subscription_scope == "exam" %}

      {% if item.is_exam_subscribed %}
        <span class="tag is-success is-light">âœ” Subscribed</span>

      {% elif item.locked %}
        <span class="tag is-light">ðŸ”’ {{ item.locked_reason }}</span>

      {% else %}

        {% if item.exam.is_free %}
          <!-- âœ… FREE EXAM -->
          {% if item.exam.is_free %}
  <!-- FREE EXAM -->
  <form method="post" action="{% url 'quiz:subscribe_exam' item.exam.id %}">
    {% csrf_token %}
    <button class="button is-success is-small">
      Subscribe Free
    </button>
  </form>

{% else %}
  <!-- PAID EXAM -->
  <div class="contact-enroll-wrapper">
    <button class="button is-warning is-small"
            onclick="toggleEnrollMenu(this)">
      ðŸ“ž Contact to Enroll
    </button>

    <div class="contact-enroll-menu">
      <a href="https://wa.me/918754795806?text=Hi%20I%20want%20to%20enroll%20in%20{{ item.exam.title }}"
         target="_blank"
         onclick="logLead('exam','{{ item.exam.id }}','whatsapp')"
         class="button is-success is-small is-fullwidth mb-1">
        WhatsApp
      </a>

      <a href="viber://chat?number=918754795806"
         onclick="logLead('exam','{{ item.exam.id }}','viber')"
         class="button is-link is-small is-fullwidth">
        Viber
      </a>
    </div>
  </div>
{% endif %}


        {% else %}
          <!-- âŒ PAID EXAM -->
          <div class="contact-enroll-wrapper">
            <button class="button is-warning is-small"
                    onclick="toggleEnrollMenu(this)">
              ðŸ“ž Contact to Enroll
            </button>

            <div class="contact-enroll-menu">
              <a href="https://wa.me/918754795806?text=Hi%20I%20want%20to%20enroll%20in%20{{ item.exam.title }}"
                 target="_blank"
                 onclick="logLead('exam','{{ item.exam.id }}','whatsapp')"
                 class="button is-success is-small is-fullwidth mb-1">
                WhatsApp
              </a>

              <a href="viber://chat?number=918754795806"
                 onclick="logLead('exam','{{ item.exam.id }}','viber')"
                 class="button is-link is-small is-fullwidth">
                Viber
              </a>
            </div>
          </div>
        {% endif %}

      {% endif %}
    {% endif %}

  </div>
  {% endfor %}
</div>

{% empty %}
<p>No exams available.</p>
{% endfor %}

<!-- ================= CSS ================= -->
<style>
.contact-enroll-wrapper {
  position: relative;
  display: inline-block;
}

.contact-enroll-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 110%;
  background: white;
  border: 1px solid #dbdbdb;
  padding: 8px;
  border-radius: 6px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  min-width: 160px;
  z-index: 20;
}

.contact-enroll-menu.is-active {
  display: block;
}
</style>

<!-- ================= JS ================= -->
<script>
function toggleEnrollMenu(btn) {
  event.stopPropagation();
  document.querySelectorAll('.contact-enroll-menu')
    .forEach(m => m.classList.remove('is-active'));
  btn.nextElementSibling.classList.toggle('is-active');
}

document.addEventListener('click', function () {
  document.querySelectorAll('.contact-enroll-menu')
    .forEach(m => m.classList.remove('is-active'));
});

function logLead(type, id, method) {
  fetch("{% url 'quiz:log_enrollment_lead' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({
      type: type,
      item_id: id,
      method: method
    })
  });
}
</script>

{% endblock %}
