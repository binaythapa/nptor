{% extends "layouts/base.html" %}
{% block title %}Practice{% endblock %}

{% block head_extra %}
<style>
/* Generic disabled state for links & buttons */
.is-disabled {
  pointer-events: none;        /* disable clicks */
  opacity: 0.45;               /* fade */
  filter: grayscale(80%);      /* desaturate color */
  cursor: not-allowed;
}

/* Optional: icons inside disabled links */
.is-disabled i {
  opacity: 0.6;
}

/* Optional: prevent hover styles from firing */
.is-disabled:hover {
  background: inherit;
  color: inherit;
}

/* ================= WRAPPER ================= */
.practice-wrapper {
  width: 100%;
  padding: 16px;
}

/* Card stays INSIDE base container */
.practice-card {
  width: 100%;
  max-width: 520px;
  margin: 0 auto;   /* üëà keeps it centered inside base */
}

/* ================= OPTIONS ================= */

.practice-option {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 10px;
  border: 1px solid #e5e7eb;
  cursor: pointer;
  font-size: 0.95rem;
}

.practice-option input {
  margin-top: 3px;
}

.practice-option:hover { background: #f9fafb; }

.practice-option.correct {
  background: #f0fdf4;        /* very soft green */
  border-color: #86efac;      /* muted green */
  color: #065f46;             /* deep readable green */
}

.practice-option.wrong {
  background: #fef7f7;        /* soft pink, not red */
  border-color: #fca5a5;      /* muted red */
  color: #7f1d1d;             /* calm dark red */
}

/* ================= MOBILE ================= */
@media (max-width: 768px) {
  .practice-wrapper {
    padding: 12px;
  }

  .practice-card {
    max-width: 100%;
  }

  .practice-option {
    padding: 14px;
    font-size: 0.95rem;
  }

  .practice-actions {
    flex-direction: column;
    gap: 10px;
  }

  .practice-actions .button {
    width: 100%;
  }

  .practice-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }
}
</style>

{% endblock %}

{% block content %}
<div class="box">


<!-- ================= HEADER ================= -->
<div class="practice-header is-flex is-align-items-center is-justify-content-space-between mb-3">
<h1 class="title is-5 mb-0 has-text-weight-semibold">
  Practice Basics
</h1>

 <div class="links">
  <a href="{% if not is_from_course %}{% url 'quiz:practice_express' %}{% else %}javascript:void(0);{% endif %}"
     class="{% if is_from_course %}is-disabled{% endif %}"
     {% if is_from_course %}title="Disabled during course practice"{% endif %}>
    Express
  </a>
  <span class="mx-1">|</span>
  <a href="{% if not is_from_course %}{% url 'quiz:exam_list' %}{% else %}javascript:void(0);{% endif %}"
     class="{% if is_from_course %}is-disabled{% endif %}"
     {% if is_from_course %}title="Disabled during course practice"{% endif %}>
    Pro
  </a>
</div>
</div>


<!-- Limited Access Message -->
{% if not user.is_authenticated %}
  <div class="notification is-light is-warning py-2 px-3 mt-2"
       style="font-size: 0.75rem; line-height: 1.3;">

    <span class="has-text-weight-semibold">
      Limited access.
    </span>

    <a href="{% url 'accounts:request-login-otp' %}"
       class="has-text-link has-text-weight-semibold ml-1">
      Log in
    </a>
    to unlock full features.

  </div>
{% endif %}


<!-- ================= FILTERS (COLLAPSIBLE) ================= -->
<div class="box mb-3 p-3">

  <!-- TOGGLE HEADER -->
  <div class="is-flex is-justify-content-space-between is-align-items-center mb-2"
       style="cursor:pointer;"
       onclick="toggleFilters()">

    <p class="has-text-weight-semibold is-size-7 mb-0">
      Filters
      <span id="filterHint"
            class="has-text-grey is-size-7 ml-1">
        (Expand)
      </span>
    </p>

    <span id="filterToggleIcon" class="has-text-grey is-size-7">‚ñæ</span>
  </div>

  <!-- FILTER BODY -->
  <div id="filterBody"
       style="
         overflow:hidden;
         transition:max-height 0.25s ease;
       ">

<form method="get">
  <div class="columns is-mobile is-multiline is-variable is-1">

    <!-- ================= DOMAIN ================= -->
    <div class="column is-12-mobile is-4-tablet">
      <div class="select is-small is-fullwidth">
        <select name="domain"
                onchange="this.form.submit()"
                {% if is_from_course %}disabled{% endif %}>
          <option value="">All Domains</option>
          {% for d in domains %}
            <option value="{{ d.id }}"
              {% if is_from_course %}
                {% if d.id == locked_filters.domain %}selected{% endif %}
              {% else %}
                {% if d.id|stringformat:"s" == domain_id %}selected{% endif %}
              {% endif %}>
              {{ d.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      {% if is_from_course %}
        <input type="hidden" name="domain" value="{{ locked_filters.domain }}">
      {% endif %}
    </div>

    <!-- ================= CATEGORY ================= -->
    <div class="column is-12-mobile is-4-tablet">
      <div class="select is-small is-fullwidth">
        <select name="category"
                onchange="this.form.submit()"
                {% if is_from_course or not domain_id %}disabled{% endif %}>
          <option value="">All Categories</option>

          {% for cat in categories %}
            {% if not cat.parent %}
              <option value="{{ cat.id }}"
                {% if is_from_course %}
                  {% if cat.id == locked_filters.category %}selected{% endif %}
                {% else %}
                  {% if cat.id|stringformat:"s" == category_id %}selected{% endif %}
                {% endif %}>
                {{ cat.name }}
              </option>

              {% for child in cat.children.all %}
                <option value="{{ child.id }}"
                  {% if is_from_course %}
                    {% if child.id == locked_filters.category %}selected{% endif %}
                  {% else %}
                    {% if child.id|stringformat:"s" == category_id %}selected{% endif %}
                  {% endif %}>
                  ‚Ü≥ {{ child.name }}
                </option>
              {% endfor %}
            {% endif %}
          {% endfor %}
        </select>
      </div>

      {% if is_from_course %}
        <input type="hidden" name="category" value="{{ locked_filters.category }}">
      {% endif %}
    </div>

    <!-- ================= DIFFICULTY ================= -->
    <div class="column is-12-mobile is-4-tablet">
      <div class="select is-small is-fullwidth">
        <select name="difficulty"
                onchange="this.form.submit()"
                {% if is_from_course %}disabled{% endif %}>
          <option value="">All Difficulty</option>
          {% for value, label in difficulty_choices %}
            <option value="{{ value }}"
              {% if is_from_course %}
                {% if value == locked_filters.difficulty %}selected{% endif %}
              {% else %}
                {% if value == difficulty %}selected{% endif %}
              {% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>

      {% if is_from_course %}
        <input type="hidden" name="difficulty" value="{{ locked_filters.difficulty }}">
      {% endif %}
    </div>

  </div>

  {% if is_from_course %}
    <p class="help is-info is-size-7 mt-2">
      üîí Filters locked ‚Äî part of course lesson.
    </p>
  {% endif %}

</form>
  </div>
</div>






<!-- ================= PROGRESS ================= -->
<div class="mb-3">
<p class="has-text-grey is-size-7">
    Progress: {{ progress_done }} / {{ progress_total }}
  </p>

  <progress class="progress is-small is-primary"
            value="{{ progress_done }}"
            max="{{ progress_total }}"></progress>
  
</div>





<!-- ================= FREE LIMIT ================= -->
{% if anon_limit_reached %}
<div class="notification is-warning is-light p-4 mb-4">

  <h3 class="title is-6 mb-2">
    Free Practice Limit Reached
  </h3>

  <p class="is-size-7 mb-3" style="line-height:1.4;">
    üöÄ Great progress! You've completed 
    <strong>{{ anon_limit }}</strong> questions.
    Log in to continue practicing without limits.
  </p>

  <a href="{% url 'accounts:request-login-otp' %}?next={{ request.path }}"
     class="button is-warning is-small is-fullwidth-mobile">
    Login to Continue
  </a>

  <a href="{% if not is_from_course %}{% url 'quiz:practice' %}?reset=1{% if domain_id %}&domain={{ domain_id }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}{% if difficulty %}&difficulty={{ difficulty }}{% endif %}{% else %}javascript:void(0);{% endif %}"
   class="button is-light {% if is_from_course %}is-disabled{% endif %}"
   {% if is_from_course %}title="Disabled during course practice"{% endif %}>
  üîÑ Reset
</a>


</div>
{% endif %}


{% if completed %}
<div id="endMessage">
  <div class="notification is-info is-light p-4">
    <p class="has-text-weight-semibold mb-2">
      üöÄ Great Progress!
    </p>

    <p class="is-size-7 mb-3">
      Amazing work! You've completed {{ progress_done }} questions ‚Äî keep pushing forward and conquer more courses & exams!
    </p>

    <div class="buttons is-centered">
      <a href="{% url 'quiz:exam_list' %}"
         class="button is-link is-small">
         Explore Courses & Exams
      </a>

      <a href="{% url 'quiz:practice' %}?reset=1"
         class="button is-small is-light">
         üîÑReset
      </a>
    </div>
  </div>
</div>
{% endif %}






<!-- ================= QUESTION ================= -->
{% if question %}
<form method="post">
{% csrf_token %}

{% if domain_id %}<input type="hidden" name="domain" value="{{ domain_id }}">{% endif %}
{% if category_id %}<input type="hidden" name="category" value="{{ category_id }}">{% endif %}
{% if difficulty %}<input type="hidden" name="difficulty" value="{{ difficulty }}">{% endif %}

<p class="mb-2 has-text-weight-semibold">{{ question.text|safe }}</p>

{% if user.is_staff %}
  <div class="mb-3">
    <a href="{% url 'admin:quiz_question_change' question.id %}"
       target="_blank"
       class="button is-small is-warning is-light">
      ‚úèÔ∏è Edit Question (Admin)
    </a>
    <span class="tag is-light ml-2">
      ID: {{ question.id }}
    </span>
  </div>
{% endif %}


{% if question.question_type != "multi" %}
  {% for c in choices %}
  <label class="practice-option
    {% if result and c.is_correct %}correct{% endif %}
    {% if result == 'wrong' and c.id|stringformat:'s' == selected_choice_id %}wrong{% endif %}">
    <input type="radio" name="choice" value="{{ c.id }}"
           {% if c.id|stringformat:'s' == selected_choice_id %}checked{% endif %}
           {% if show_next %}disabled{% endif %} required>
    <span>{{ c.text }}</span>
  </label>
  {% endfor %}
{% endif %}

{% if question.question_type == "multi" %}
  {% for c in choices %}
  <label class="practice-option
    {% if result and c.is_correct %}correct{% endif %}
    {% if result == 'wrong' and c.id in selected_multi_ids %}wrong{% endif %}">
    <input type="checkbox" name="choice_multi" value="{{ c.id }}"
           {% if c.id in selected_multi_ids %}checked{% endif %}
           {% if show_next %}disabled{% endif %}>
    <span>{{ c.text }}</span>
  </label>
  {% endfor %}
{% endif %}



{% if result == "correct" %}
<div class="notification is-success mt-3">‚úÖ Correct!</div>
{% elif result == "wrong" %}
<div class="notification mt-3"
     style="background:#fff7f7; border-left:4px solid #fca5a5;">

  <p style="color:#7f1d1d; font-weight:600;">
    ‚ùå Incorrect
  </p>

  <p class="mt-2" style="color:#374151; font-weight:500;">
    Correct answer:
  </p>

  <ul class="mt-2 ml-3">
    {% for c in choices %}
      {% if c.is_correct %}
        <li style="color:#065f46;">
          ‚úî {{ c.text }}
        </li>
      {% endif %}
    {% endfor %}
  </ul>
</div>



{% if explanation %}
<button type="button" class="button is-small is-info mt-2"
        onclick="toggleExplanation()" id="explanationToggleBtn">
  üìò Show Explanation
</button>

<div id="explanationBox" class="notification is-info mt-3"
     style="display:none;">
  {{ explanation|linebreaks }}
</div>
{% endif %}
{% endif %}

<div class="practice-actions mt-4 is-flex is-justify-content-space-between">

  <div class="is-flex" style="gap:8px;">
    {% if show_next %}
      <button class="button is-link" name="next" value="1">
        Next ‚Üí
      </button>
    {% else %}
      <button class="button is-primary">
        Submit
      </button>
    {% endif %}

<!-- üÜï SKIP BUTTON -->
<button class="button is-warning is-light"
        type="submit"
        name="skip"
        value="1"
        {% if is_from_course %}disabled{% endif %}>
  ‚è≠ Skip
</button>

<!-- üîÑ RESET BUTTON -->
<a href="{% if not is_from_course %}{% url 'quiz:practice' %}?reset=1{% if domain_id %}&domain={{ domain_id }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}{% if difficulty %}&difficulty={{ difficulty }}{% endif %}{% else %}javascript:void(0);{% endif %}"
   class="button is-light {% if is_from_course %}is-disabled{% endif %}"
   {% if is_from_course %}title="Disabled during course practice"{% endif %}>
  üîÑ Reset
</a>


                  

</div>
  </div>

</form>

<!-- ================= FEEDBACK ================= -->
{% if user.is_authenticated %}
<hr class="my-4">

<div id="feedbackBox" class="box is-light">
{% if feedback_submitted %}
  <div class="notification is-success is-light">
    ‚úÖ Feedback already submitted. Thanks!
  </div>
{% else %}
  <p class="has-text-weight-semibold mb-2">üó£Ô∏è Feedback</p>

  <button type="button" id="flagBtn"
          class="button is-small"
          onclick="toggleFlag()">‚ö†Ô∏è Incorrect / Confusing</button>

  <input type="hidden" id="answerIncorrect">

 <div class="field mt-2">
  <textarea id="studentComment"
            class="textarea is-small"
            rows="2"
            placeholder="Optional comment..."
            oninput="autoResize(this)"></textarea>
</div>


  <button class="button is-small is-link mt-2"
          onclick="submitFeedback()">Submit Feedback</button>
{% endif %}
</div>
{% endif %}



{% endif %}

<!-- ================= PREVIOUS FEEDBACKS ================= -->
{% if previous_feedbacks %}
  <hr class="my-3">

  <p class="is-size-7 has-text-grey mb-2">
    üßæ Comments
  </p>

  <div class="feedback-list">
    {% for fb in previous_feedbacks %}
      <div class="mb-2 pl-3"
           style="border-left:2px solid #e5e7eb;">

        <p class="is-size-7 has-text-grey-light">
          {{ fb.user }} ¬∑ {{ fb.created_at|date:"M d, Y" }}
        </p>

        {% if fb.content %}
          <p class="is-size-7 mt-1 has-text-grey"
             style="word-break: break-word; overflow-wrap:anywhere;">
            {{ fb.content }}
          </p>
        {% else %}
          <p class="is-size-7 has-text-grey-light">
            (No comment)
          </p>
        {% endif %}

      </div>
    {% endfor %}
  </div>
{% endif %}



</div>


<script>
function toggleExplanation() {
  const box = document.getElementById("explanationBox");
  const btn = document.getElementById("explanationToggleBtn");
  if (!box || !btn) return;
  box.style.display = box.style.display === "none" ? "block" : "none";
  btn.innerText = box.style.display === "block"
    ? "üìò Hide Explanation"
    : "üìò Show Explanation";
}

let flagged = false;
function toggleFlag() {
  flagged = !flagged;
  document.getElementById("flagBtn")
    .classList.toggle("is-warning", flagged);
  document.getElementById("answerIncorrect").value = flagged ? "1" : "";
}

function submitFeedback() {
  const data = new FormData();
  data.append("feedback_submit", "1");
  data.append("student_comment",
              document.getElementById("studentComment").value);
  if (flagged) data.append("answer_incorrect", "1");
  data.append("csrfmiddlewaretoken", "{{ csrf_token }}");

  fetch(window.location.href, { method: "POST", body: data })
    .then(() => {
      document.getElementById("feedbackBox").innerHTML =
        `<div class="notification is-success is-light">
          ‚úÖ Feedback already submitted. Thanks!
        </div>`;
    });
}
</script>

<script>
  function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
  }
</script>


<script>
function updateFilterUI(expanded) {
  const hint = document.getElementById("filterHint");
  const icon = document.getElementById("filterToggleIcon");

  if (expanded) {
    hint.innerText = "(Click to collapse)";
    icon.innerText = "‚ñ¥";
  } else {
    hint.innerText = "(Click to expand)";
    icon.innerText = "‚ñæ";
  }
}

function toggleFilters() {
  const body = document.getElementById("filterBody");
  const isExpanded =
    body.style.maxHeight && body.style.maxHeight !== "0px";

  if (isExpanded) {
    body.style.maxHeight = "0px";
    updateFilterUI(false);
    localStorage.setItem("filterExpanded", "0");
  } else {
    body.style.maxHeight = body.scrollHeight + "px";
    updateFilterUI(true);
    localStorage.setItem("filterExpanded", "1");
  }
}

document.addEventListener("DOMContentLoaded", function () {
  const body = document.getElementById("filterBody");
  const expanded = localStorage.getItem("filterExpanded") === "1";

  if (expanded) {
    body.style.maxHeight = body.scrollHeight + "px";
    updateFilterUI(true);
  } else {
    body.style.maxHeight = "0px";
    updateFilterUI(false);
  }
});
</script>



{% endblock %}
