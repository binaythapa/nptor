{% extends "quiz/base.html" %}
{% load dict_extras %}
{% block content %}


 
{# ================= MOCK BANNER ================= #}
{% if is_mock %}
  <div class="notification is-info is-light mb-4">
    <strong>üß™ Mock Attempt</strong><br>
    This was a practice attempt.
    <strong>Your score does NOT affect pass/fail or progression.</strong>
  </div>
{% endif %}

<h2 class="title is-4">üéØ Exam Result ‚Äî {{ user_exam.exam.title }}   </h2>

{% if course and lesson %}
<nav class="breadcrumb mb-4" aria-label="breadcrumbs">
  <ul>
    <li>
      <a href="{% url 'courses:course_detail' course.slug %}">
        {{ course.title }}
      </a>
    </li>
    <li>
      <a href="{% url 'courses:course_learn' course.slug %}">
        {{ lesson.title }}
      </a>
    </li>
    <li class="is-active">
      <a aria-current="page">
        Quiz Result
      </a>
    </li>
  </ul>
</nav>
{% endif %}


<!-- ================= SUMMARY ================= -->
<div class="box columns is-multiline has-text-centered">

  <div class="column is-3">
    <p class="heading">Score</p>
    <p class="title is-4">{{ user_exam.score }}%</p>
  </div>

  <div class="column is-3">
    <p class="heading">Best</p>
    <p class="title is-4">{{ best_score }}%</p>
  </div>

  <div class="column is-3">
    <p class="heading">Accuracy</p>
    <p class="title is-4">{{ accuracy }}%</p>
  </div>

  <div class="column is-3">
    <p class="heading">Status</p>

    {% if is_mock %}
      <span class="tag is-info is-medium">Mock</span>
    {% elif user_exam.passed %}
      <span class="tag is-success is-medium">Passed</span>
    {% else %}
      <span class="tag is-danger is-medium">Failed</span>
    {% endif %}

  </div>

</div>

<!-- ================= ANSWER REVIEW ================= -->
<h3 class="subtitle mt-5">üìã Answer Review</h3>

{% for ans in answers %}
<div class="box">

  <strong>{{ forloop.counter }}. {{ ans.question.text }}</strong>

  <p class="mt-2">
    {% if ans.is_correct %}
      <span class="has-text-success">‚úî Correct</span>
    {% elif ans.is_correct is False %}
      <span class="has-text-danger">‚úò Incorrect</span>
    {% else %}
      <span class="has-text-warning">‚óê Partial</span>
    {% endif %}
  </p>

  {% if ans.user_answers_display %}
    <p class="mt-2">
      <strong>Your Answer{{ ans.user_answers_display|length|pluralize }}:</strong>
      <ul>
        {% for a in ans.user_answers_display %}
          <li>‚úì {{ a }}</li>
        {% endfor %}
      </ul>
    </p>
  {% else %}
    <p class="mt-2 has-text-grey">
      <em>No answer submitted</em>
    </p>
  {% endif %}

  {% if ans.correct_answers_display %}
    <p class="mt-2">
      <strong>Correct Answer{{ ans.correct_answers_display|length|pluralize }}:</strong>
      <ul>
        {% for c in ans.correct_answers_display %}
          <li>‚úì {{ c }}</li>
        {% endfor %}
      </ul>
    </p>
  {% endif %}

  {% if not feedback_map|get_item:ans.question.id %}
  <form method="post" class="mt-3">
    {% csrf_token %}
    <input type="hidden" name="question_id" value="{{ ans.question.id }}">

    <div class="field">
      <label class="label">Report issue / Comment</label>
      <div class="control">
        <textarea class="textarea is-small"
                  name="comment"
                  placeholder="Optional feedback..."></textarea>
      </div>
    </div>

    <label class="checkbox">
      <input type="checkbox" name="is_answer_incorrect">
      Answer seems incorrect
    </label>

    <div class="mt-2">
      <button class="button is-small is-link">Submit Feedback</button>
    </div>
  </form>
  {% else %}
    <p class="has-text-success mt-3">
      ‚úî Feedback submitted
    </p>
  {% endif %}

</div>
{% endfor %}

<!-- ================= ACTIONS ================= -->
<div class="box mt-5 buttons">

  {# ================= COURSE INTEGRATION ================= #}
  {% with lesson=user_exam.exam.lesson_set.first %}
    {% if lesson %}
      <a href="{% url 'courses:course_learn' lesson.section.course.slug %}"
         class="button is-primary">
        ‚¨Ö Continue Course
      </a>
    {% endif %}
  {% endwith %}

 {# ================= RETAKE / COURSE NAVIGATION ================= #}
<div class="box mt-5">

  {% if course_context %}
    <!-- üü¢ Course-launched exam -->

    <!-- Back to course -->
    <a
    href="{% url 'courses:course_learn_lesson' course_context.course_slug course_context.lesson_id %}"
    class="button is-success">
      ‚¨Ö Back to Course
    </a>

    <!-- Continue to next lesson -->
    {% if next_lesson %}
      <a
        href="{% url 'courses:course_learn_lesson'
                  course_context.course_slug
                  next_lesson.id %}"
        class="button is-link ml-2">
        ‚ñ∂ Continue to Next Lesson
      </a>
    {% endif %}

    <!-- Retake (course-aware) -->
    {% if can_retake and not is_mock %}
      <a
        href="{% url 'quiz:exam_start' user_exam.exam.id %}
              ?course={{ course_context.course_slug }}
              &lesson={{ course_context.lesson_id }}"
        class="button is-light ml-2">
        üîÅ Retake Exam
      </a>
    {% endif %}

  {% else %}
    <!-- üü£ Normal quiz behavior -->

    {% if not is_mock and can_retake %}
      <a
        href="{% url 'quiz:exam_start' user_exam.exam.id %}"
        class="button is-link is-light">
        üîÅ Retake Exam
      </a>
    {% endif %}

    <a
      href="{% url 'quiz:student_dashboard' %}"
      class="button is-light ml-2">
      ‚Üê Dashboard
    </a>

  {% endif %}

</div>



<!-- ================= COUNTDOWN SCRIPT ================= -->
{% if not can_retake and not is_mock %}
<script>
let seconds = {{ cooldown_seconds }};
const el = document.getElementById("retake-countdown");

function tick() {
  if (!el) return;
  if (seconds <= 0) {
    el.innerText = "now";
    return;
  }
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  el.innerText = `${m}m ${s}s`;
  seconds--;
  setTimeout(tick, 1000);
}
tick();
</script>
{% endif %}


{% if course and not is_mock %}
<script>
setTimeout(function () {
  window.location.href = "{% url 'courses:course_learn' course.slug %}";
}, 5000);
</script>

<p class="has-text-grey mt-2">
  You‚Äôll be redirected back to the course in 5 seconds‚Ä¶
</p>
{% endif %}


{% endblock %}
