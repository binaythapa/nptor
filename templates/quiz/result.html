{% extends "quiz/base.html" %}
{% load dict_extras %}
{% block content %}

{# ================= MOCK BANNER ================= #}
{% if is_mock %}
  <div class="notification is-info is-light mb-4">
    <strong>ğŸ§ª Mock Attempt</strong><br>
    This was a practice attempt.
    <strong>Your score does NOT affect pass/fail or progression.</strong>
  </div>
{% endif %}

<h2 class="title is-4">ğŸ¯ Exam Result â€” {{ user_exam.exam.title }}</h2>

<!-- ================= SUMMARY ================= -->
<div class="box columns is-multiline has-text-centered">

  <div class="column is-3">
    <p class="heading">Score</p>
    <p class="title is-4">{{ user_exam.score }}%</p>
  </div>

  <div class="column is-3">
    <p class="heading">Best</p>
    <p class="title is-4">{{ best_score }}%</p>
  </div>

  <div class="column is-3">
    <p class="heading">Accuracy</p>
    <p class="title is-4">{{ accuracy }}%</p>
  </div>

  <div class="column is-3">
    <p class="heading">Status</p>

    {% if is_mock %}
      <span class="tag is-info is-medium">Mock</span>
    {% elif user_exam.passed %}
      <span class="tag is-success is-medium">Passed</span>
    {% else %}
      <span class="tag is-danger is-medium">Failed</span>
    {% endif %}

  </div>

</div>

<!-- ================= ANSWER REVIEW ================= -->
<h3 class="subtitle mt-5">ğŸ“‹ Answer Review</h3>

{% for ans in answers %}
<div class="box">

  <strong>{{ forloop.counter }}. {{ ans.question.text }}</strong>

  <!-- ===== STATUS ===== -->
  <p class="mt-2">
    {% if ans.is_correct %}
      <span class="has-text-success">âœ” Correct</span>
    {% elif ans.is_correct is False %}
      <span class="has-text-danger">âœ˜ Incorrect</span>
    {% else %}
      <span class="has-text-warning">â— Partial</span>
    {% endif %}
  </p>

  <!-- ===== USER ANSWERS ===== -->
  {% if ans.user_answers_display %}
    <p class="mt-2">
      <strong>Your Answer{{ ans.user_answers_display|length|pluralize }}:</strong>
      <ul>
        {% for a in ans.user_answers_display %}
          <li>âœ“ {{ a }}</li>
        {% endfor %}
      </ul>
    </p>
  {% else %}
    <p class="mt-2 has-text-grey">
      <em>No answer submitted</em>
    </p>
  {% endif %}

  <!-- ===== CORRECT ANSWERS ===== -->
  {% if ans.correct_answers_display %}
    <p class="mt-2">
      <strong>Correct Answer{{ ans.correct_answers_display|length|pluralize }}:</strong>
      <ul>
        {% for c in ans.correct_answers_display %}
          <li>âœ“ {{ c }}</li>
        {% endfor %}
      </ul>
    </p>
  {% endif %}

  <!-- ===== FEEDBACK FORM ===== -->
  {% if not feedback_map|get_item:ans.question.id %}
  <form method="post" class="mt-3">
    {% csrf_token %}
    <input type="hidden" name="question_id" value="{{ ans.question.id }}">

    <div class="field">
      <label class="label">Report issue / Comment</label>
      <div class="control">
        <textarea class="textarea is-small"
                  name="comment"
                  placeholder="Optional feedback..."></textarea>
      </div>
    </div>

    <label class="checkbox">
      <input type="checkbox" name="is_answer_incorrect">
      Answer seems incorrect
    </label>

    <div class="mt-2">
      <button class="button is-small is-link">Submit Feedback</button>
    </div>
  </form>
  {% else %}
    <p class="has-text-success mt-3">
      âœ” Feedback submitted
    </p>
  {% endif %}

</div>
{% endfor %}

<!-- ================= ACTIONS ================= -->
<div class="box mt-5">

  {# Retake ONLY for real exams #}
  {% if not is_mock %}
    {% if can_retake %}
      <a href="{% url 'quiz:exam_start' user_exam.exam.id %}"
         class="button is-link is-light">
        ğŸ” Retake Exam
      </a>
    {% else %}
      <button class="button is-light" disabled>
        â³ Retake locked
      </button>

      <p class="help mt-2">
        Retake available in
        <strong><span id="retake-countdown"></span></strong>
      </p>
    {% endif %}
  {% endif %}

  <a href="{% url 'quiz:student_dashboard' %}"
     class="button is-light ml-2">
    â† Dashboard
  </a>

</div>

<!-- ================= COUNTDOWN SCRIPT ================= -->
{% if not can_retake and not is_mock %}
<script>
let seconds = {{ cooldown_seconds }};
const el = document.getElementById("retake-countdown");

function tick() {
  if (!el) return;
  if (seconds <= 0) {
    el.innerText = "now";
    return;
  }
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  el.innerText = `${m}m ${s}s`;
  seconds--;
  setTimeout(tick, 1000);
}
tick();
</script>
{% endif %}

{% endblock %}
