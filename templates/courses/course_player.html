<!DOCTYPE html>
<html>
<head>
  <title>{{ course.title }}</title>

  <style>
    body { margin: 0; font-family: Arial; }
    .layout { display: flex; height: 100vh; }

    .sidebar {
      width: 300px;
      background: #f8f9fa;
      overflow-y: auto;
      border-right: 1px solid #ddd;
      padding: 12px;
    }

    .content {
      flex: 1;
      padding: 20px;
    }

    .lesson-link {
      display: block;
      padding: 6px 8px;
      text-decoration: none;
      color: #333;
      border-radius: 4px;
      margin-bottom: 4px;
    }

    .lesson-link.active {
      background: #e9ecef;
      font-weight: bold;
    }

    .lesson-link.completed {
      color: #2e7d32;
      font-weight: bold;
    }

    .progress-box {
      margin: 10px 0 20px;
    }

    .celebration-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .celebration-card {
      background: white;
      padding: 40px;
      width: 420px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .btn-primary {
      padding: 10px 18px;
      background: #2e7d32;
      color: white;
      border-radius: 5px;
      text-decoration: none;
    }

    .btn-secondary {
      padding: 10px 18px;
      background: #e0e0e0;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>

<body>

<div class="layout">

  <!-- LEFT: CURRICULUM -->
  <div class="sidebar">
    <h3>{{ course.title }}</h3>

    <div class="progress-box">
      <strong>Progress: {{ progress }}%</strong>
      <div style="background:#ddd; border-radius:6px; height:10px;">
        <div style="width: {{ progress }}%; background:#4caf50; height:10px; border-radius:6px;"></div>
      </div>
    </div>

    {% for section in sections %}
      <h4>{{ section.title }}</h4>

      {% for l in section.lessons.all %}
        <a href="{% url 'courses:course_learn_lesson' course.slug l.id %}"
           class="lesson-link
           {% if lesson.id == l.id %} active{% endif %}
           {% if l.id in completed_lesson_ids %} completed{% endif %}">
          {% if l.id in completed_lesson_ids %}‚úî {% endif %}
          {{ l.title }}
        </a>
      {% endfor %}
    {% endfor %}
  </div>

  <!-- RIGHT: CONTENT -->
  <div class="content">
    <h2>{{ lesson.title }}</h2>

    <!-- ================= VIDEO ================= -->
 {% if lesson.lesson_type == lesson.TYPE_VIDEO %}
  <iframe
    width="100%"
    height="420"
    src="{{ video_embed_url }}"
    frameborder="0"
    allowfullscreen
    referrerpolicy="strict-origin-when-cross-origin">
  </iframe>


<p id="video-status" style="margin-top:10px;color:#666;">
  {% if lesson_progress.completed %}
    ‚úî Lesson completed
  {% else %}
    ‚ñ∂ Keep watching to complete this lesson
  {% endif %}
</p>

{% if lesson_progress.completed and next_lesson %}
  <div style="margin-top:30px;">
    <a
      href="{% url 'courses:course_learn_lesson' course.slug next_lesson.id %}"
      style="
        padding:12px 20px;
        background:#2e7d32;
        color:white;
        border-radius:6px;
        text-decoration:none;
        font-weight:bold;
        display:inline-block;
      ">
      ‚ñ∂ Continue to Next Lesson
    </a>
  </div>
{% endif %}


    <!-- ================= ARTICLE ================= -->
    {% elif lesson.lesson_type == "article" %}
      <div>{{ lesson.article_content|safe }}</div>

     {% if not lesson_progress.completed %}
  <form
    method="post"
    action="{% url 'courses:mark_lesson_completed' course.slug lesson.id %}"
    style="margin-top:20px;">
    {% csrf_token %}
    <button
      type="submit"
      style="
        padding:10px 18px;
        background:#4caf50;
        color:white;
        border:none;
        border-radius:4px;
        cursor:pointer;
      ">
      ‚úÖ Mark as completed
    </button>
  </form>
{% else %}
  <p style="margin-top:20px;color:#2e7d32;font-weight:bold;">
    ‚úî Lesson completed
  </p>

  {% if next_lesson %}
    <div style="margin-top:30px;">
      <a
        href="{% url 'courses:course_learn_lesson' course.slug next_lesson.id %}"
        style="
          padding:12px 20px;
          background:#2e7d32;
          color:white;
          border-radius:6px;
          text-decoration:none;
          font-weight:bold;
          display:inline-block;
        ">
        ‚ñ∂ Continue to Next Lesson
      </a>
    </div>
  {% endif %}
{% endif %}


    <!-- ================= QUIZ ================= -->
    <!-- ================= QUIZ ================= -->
{% elif lesson.lesson_type == lesson.TYPE_QUIZ %}

  <!-- QUIZ ACTION (ALWAYS ALLOWED) -->
  <a
    href="{% url 'quiz:exam_start' lesson.exam.id %}?course={{ course.slug }}&lesson={{ lesson.id }}"
    style="
      padding:12px 20px;
      background:{% if lesson_progress.completed %}#455a64{% else %}#7b1fa2{% endif %};
      color:white;
      border-radius:6px;
      text-decoration:none;
      font-weight:bold;
      display:inline-block;
    ">
    {% if lesson_progress.completed %}
      üîÅ Re-attempt Quiz
    {% else %}
      üëâ Start Quiz
    {% endif %}
  </a>

  <!-- COMPLETION STATUS -->
  {% if lesson_progress.completed %}
    <p style="margin-top:10px;color:#2e7d32;font-weight:bold;">
      ‚úî Quiz completed
    </p>
  {% endif %}

  <!-- NEXT LESSON -->
  {% if lesson_progress.completed and next_lesson %}
    <div style="margin-top:30px;">
      <a
        href="{% url 'courses:course_learn_lesson' course.slug next_lesson.id %}"
        style="
          padding:12px 20px;
          background:#2e7d32;
          color:white;
          border-radius:6px;
          text-decoration:none;
          font-weight:bold;
          display:inline-block;
        ">
        ‚ñ∂ Continue to Next Lesson
      </a>
    </div>
  {% endif %}



  <!-- ================= PRACTICE ================= -->
{% elif lesson.lesson_type == lesson.TYPE_PRACTICE %}

  <!-- PRACTICE ACTION (ALWAYS ALLOWED) -->
  <a
    href="{% url 'quiz:practice' %}?category={{ lesson.practice_category.id }}&course={{ course.slug }}&lesson={{ lesson.id }}"
    style="
      padding:12px 20px;
      background:{% if lesson_progress.completed %}#455a64{% else %}#1976d2{% endif %};
      color:white;
      border-radius:6px;
      text-decoration:none;
      font-weight:bold;
      display:inline-block;
    ">
    {% if lesson_progress.completed %}
      üîÅ Re-practice
    {% else %}
      üëâ Start Practice
    {% endif %}
  </a>

  <!-- COMPLETION STATUS -->
  {% if lesson_progress.completed %}
    <p style="margin-top:10px;color:#2e7d32;font-weight:bold;">
      ‚úî Practice completed
    </p>
  {% endif %}

  <!-- NEXT LESSON -->
  {% if lesson_progress.completed and next_lesson %}
    <div style="margin-top:30px;">
      <a
        href="{% url 'courses:course_learn_lesson' course.slug next_lesson.id %}"
        style="
          padding:12px 20px;
          background:#2e7d32;
          color:white;
          border-radius:6px;
          text-decoration:none;
          font-weight:bold;
          display:inline-block;
        ">
        ‚ñ∂ Continue to Next Lesson
      </a>
    </div>
  {% endif %}

{% endif %}

<!-- ================= CELEBRATION (ONE-TIME) ================= -->
{% if show_celebration %}
<div id="celebration-modal" class="celebration-overlay">
  <div class="celebration-card">
    <h1>üéâ Congratulations!</h1>
    <p>You‚Äôve completed <strong>{{ course.title }}</strong></p>

    <a
      href="{% url 'courses:course_certificate_pdf' course.slug %}"
      class="btn-primary">
      üìú Download Certificate
    </a>

    <br><br>

    <button
      type="button"
      onclick="document.getElementById('celebration-modal').style.display='none'"
      class="btn-secondary">
      Continue
    </button>
  </div>
</div>
{% endif %}


<!-- ================= CERTIFICATE (ALWAYS AVAILABLE) ================= -->
{% if certificate %}
  <div style="margin-top:40px; text-align:center;">
    <a
      href="{% url 'courses:course_certificate_pdf' course.slug %}"
      style="
        padding:12px 20px;
        background:#1565c0;
        color:white;
        border-radius:6px;
        text-decoration:none;
        font-weight:bold;
        display:inline-block;
      ">
      üìú Download Certificate
    </a>
  </div>
{% endif %}




<!-- ================= VIDEO AUTO-COMPLETE (ROBUST) ================= -->
{% if lesson.lesson_type == lesson.TYPE_VIDEO and not lesson_progress.completed %}
<script>
console.log("‚úÖ VIDEO TRACKING JS RUNNING");

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

let watchedSeconds = 0;
let duration = 390; // fallback
let completed = false;

setInterval(() => {
  watchedSeconds += 5;

  fetch("{% url 'courses:track_video_progress' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": getCookie("csrftoken"),
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({
      lesson_id: "{{ lesson.id }}",
      watched: watchedSeconds,
      duration: duration
    })
  })
  .then(r => r.json())
  .then(data => {
    if (data.completed && !completed) {
      completed = true;
      document.getElementById("video-status").innerText =
        "‚úî Video watched. Lesson completed";
    }
  });
}, 5000);
</script>
{% endif %}






</body>
</html>
