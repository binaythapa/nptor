{% extends "quiz/base.html" %}
{% block title %}Question Dashboard{% endblock %}

{% block content %}
<style>
/* ================= QUESTION CELL ================= */

.question-cell {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.question-text {
  font-size: 0.95rem;
  line-height: 1.4;
}

.question-text.collapsed {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.expand-toggle {
  color: #2563eb;
  cursor: pointer;
  font-size: 0.75rem;
}

.question-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
}

.question-row {
  cursor: pointer;
}

.question-row:hover {
  background: #f9fafb;
}

.icon-btn {
  background: none;
  border: none;
  padding: 4px;
  cursor: pointer;
  font-size: 1rem;
}
</style>

<section class="section">
<div class="container">

<!-- ================= HEADER ================= -->
<div class="is-flex is-justify-content-space-between is-align-items-center mb-4">
  <div>
    <h1 class="title is-4">üß† Question Dashboard</h1>
    <p class="has-text-grey is-size-7">
      Review question quality, flags & discussions
    </p>
  </div>

  <a href="/admin/quiz/question/add/" class="button is-primary">
    ‚ûï Add Question
  </a>
</div>

<!-- ================= KPI ================= -->
<div class="columns is-multiline mb-4">
  <div class="column is-3">
    <div class="box has-text-centered">
      <p class="heading">üìò Total</p>
      <p class="title">{{ total_questions }}</p>
    </div>
  </div>

  <div class="column is-3">
    <div class="box has-text-centered has-text-success">
      <p class="heading">‚úÖ Active</p>
      <p class="title">{{ active_questions }}</p>
    </div>
  </div>

  <div class="column is-3">
    <div class="box has-text-centered has-text-warning">
      <p class="heading">üö© Flagged</p>
      <p class="title">{{ flagged_questions }}</p>
    </div>
  </div>

  <div class="column is-3">
    <div class="box has-text-centered has-text-danger">
      <p class="heading">üö´ Disabled</p>
      <p class="title">{{ disabled_questions }}</p>
    </div>
  </div>
</div>

<!-- ================= TABS ================= -->
<div class="tabs is-toggle is-small mb-4">
  <ul>
    <li class="{% if tab == 'all' %}is-active{% endif %}">
      <a href="?tab=all">üìò All Questions</a>
    </li>
    <li class="{% if tab == 'review' %}is-active{% endif %}">
      <a href="?tab=review">
        üö© Needs Review
        {% if needs_review_count %}
          <span class="tag is-danger ml-1">{{ needs_review_count }}</span>
        {% endif %}
      </a>
    </li>
  </ul>
</div>

<!-- ================= FILTERS ================= -->
<form method="get" class="box mb-4">
<input type="hidden" name="tab" value="{{ tab }}">

<div class="columns is-multiline">

  <div class="column is-3">
    <input class="input" name="q" placeholder="Search question..."
           value="{{ search }}">
  </div>

  <div class="column is-3">
    <div class="select is-fullwidth">


      <select name="category">
  <option value="">All categories</option>
  {% for cat in categories %}
    <option value="{{ cat.id }}"
      {% if cat.id|stringformat:"s" == selected_category %}selected{% endif %}>
      {{ cat.name }}
    </option>
  {% endfor %}
</select>



    </div>
  </div>

  <div class="column is-2">
    <div class="select is-fullwidth">
      <select name="difficulty">
        <option value="">All</option>
        <option value="easy" {% if selected_difficulty == "easy" %}selected{% endif %}>Easy</option>
        <option value="medium" {% if selected_difficulty == "medium" %}selected{% endif %}>Medium</option>
        <option value="hard" {% if selected_difficulty == "hard" %}selected{% endif %}>Hard</option>
      </select>
    </div>
  </div>

  <div class="column is-2">
    <div class="select is-fullwidth">
      <select name="status">
        <option value="">All Status</option>
        <option value="active" {% if selected_status == "active" %}selected{% endif %}>Active</option>
        <option value="disabled" {% if selected_status == "disabled" %}selected{% endif %}>Disabled</option>
      </select>
    </div>
  </div>

  <div class="column is-2">
    <button class="button is-link is-fullwidth">Filter</button>
  </div>

</div>
</form>

<!-- ================= TABLE ================= -->
<div class="table-container">
<table class="table is-fullwidth is-striped is-hoverable">

<thead>
<tr>
  <th>ID</th>
  <th style="width:55%">Question</th>
  <th>üí¨</th>
  <th>üö©</th>
  <th>Status</th>
  <th>Admin</th>
</tr>
</thead>

<tbody id="question-table-body">
{% include "questions/_question_rows.html" %}
</tbody>

</table>

<!-- Loader -->
<div id="scroll-loader"
     class="has-text-centered has-text-grey mt-4"
     style="display:none;">
  ‚è≥ Loading more questions...
</div>

<!-- End of list -->
<div id="end-of-list"
     class="has-text-centered has-text-grey mt-4"
     style="display:none;">
  üéâ You‚Äôve reached the end of the list
</div>

</div>
</div>
</section>

<script>
let currentPage = {{ questions.number }};
let hasNext = {{ questions.has_next|yesno:"true,false" }};
let loading = false;

function loadMoreQuestions() {
  if (!hasNext || loading) return;

  loading = true;
  document.getElementById("scroll-loader").style.display = "block";
  document.getElementById("end-of-list").style.display = "none";

  const url =
    window.location.href.replace(/(&|\?)page=\d+/, '') +
    (window.location.search.includes('?') ? '&' : '?') +
    'page=' + (currentPage + 1);

  fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
    .then(res => res.json())
    .then(data => {
      document.getElementById("question-table-body")
        .insertAdjacentHTML("beforeend", data.html);

      currentPage++;
      hasNext = data.has_next;
      loading = false;

      document.getElementById("scroll-loader").style.display = "none";

      if (!hasNext) {
        document.getElementById("end-of-list").style.display = "block";
      }
    });
}

// Infinite scroll trigger
window.addEventListener("scroll", function () {
  if (
    window.innerHeight + window.scrollY >=
    document.body.offsetHeight - 200
  ) {
    loadMoreQuestions();
  }
});

// Expand / collapse question text
function toggleQuestionText(e, el) {
  e.stopPropagation();
  const text = el.previousElementSibling;

  if (text.classList.contains("collapsed")) {
    text.textContent = text.dataset.full;
    text.classList.remove("collapsed");
    el.textContent = "Show less";
  } else {
    text.textContent = text.dataset.full.substring(0, 140) + "...";
    text.classList.add("collapsed");
    el.textContent = "Show more";
  }
}

// Row click ‚Üí open review page
document.addEventListener("click", function (e) {
  const row = e.target.closest(".question-row");
  if (!row) return;
  if (e.target.closest("a") || e.target.closest("button")) return;
  window.open(row.dataset.reviewUrl, "_blank", "noopener");
});
</script>

{% endblock %}
