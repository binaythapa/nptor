{% extends "quiz/base.html" %}
{% block title %}Question Dashboard{% endblock %}

{% block content %}
<section class="section">
<div class="container">

<!-- ================= HEADER ================= -->
<div class="is-flex is-justify-content-space-between is-align-items-center mb-4">
  <div>
    <h1 class="title is-4">ğŸ§  Question Dashboard</h1>
    <p class="has-text-grey is-size-7">
      Review question quality, flags & discussions
    </p>
  </div>

  <a href="/admin/quiz/question/add/"
     class="button is-primary">
    â• Add Question
  </a>
</div>

<!-- ================= KPI ================= -->
<div class="columns is-multiline mb-4">
  <div class="column is-3">
    <div class="box has-text-centered">
      <p class="heading">ğŸ“˜ Total</p>
      <p class="title">{{ total_questions }}</p>
    </div>
  </div>

  <div class="column is-3">
    <div class="box has-text-centered has-text-success">
      <p class="heading">âœ… Active</p>
      <p class="title">{{ active_questions }}</p>
    </div>
  </div>

  <div class="column is-3">
    <div class="box has-text-centered has-text-warning">
      <p class="heading">ğŸš© Flagged</p>
      <p class="title">{{ flagged_questions }}</p>
    </div>
  </div>

  <div class="column is-3">
    <div class="box has-text-centered has-text-danger">
      <p class="heading">ğŸš« Disabled</p>
      <p class="title">{{ disabled_questions }}</p>
    </div>
  </div>
</div>

<!-- ================= FILTERS ================= -->
 <div class="mb-3">
  <a href="?needs_review=1"
     class="button is-small is-warning">
    ğŸš© Needs Review
  </a>

  {% if needs_review_count %}
  <span class="tag is-danger ml-1">
    {{ needs_review_count }}
  </span>
  {% endif %}
</div>

<form method="get" class="box mb-4">
<div class="columns is-multiline">

  <!-- Search -->
  <div class="column is-3">
    <input class="input" name="q" placeholder="Search question..."
           value="{{ search }}">
  </div>

  <!-- Category -->
  <div class="column is-3">
    <div class="select is-fullwidth">
      <select name="category">
        <option value="">All categories</option>
        {% for cat in categories %}
          <option value="{{ cat }}"
            {% if cat == selected_category %}selected{% endif %}>
            {{ cat }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- Difficulty -->
  <div class="column is-2">
    <div class="select is-fullwidth">
      <select name="difficulty">
        <option value="">All</option>
        <option value="easy" {% if selected_difficulty == "easy" %}selected{% endif %}>Easy</option>
        <option value="medium" {% if selected_difficulty == "medium" %}selected{% endif %}>Medium</option>
        <option value="hard" {% if selected_difficulty == "hard" %}selected{% endif %}>Hard</option>
      </select>
    </div>
  </div>

  <!-- âœ… Status (is_active) -->
  <div class="column is-2">
    <div class="select is-fullwidth">
      <select name="status">
        <option value="">All Status</option>
        <option value="active"
          {% if selected_status == "active" %}selected{% endif %}>
          Active
        </option>
        <option value="disabled"
          {% if selected_status == "disabled" %}selected{% endif %}>
          Disabled
        </option>
      </select>
    </div>
  </div>

  <!-- Flagged -->
  <div class="column is-2">
    <label class="checkbox mt-2">
      <input type="checkbox" name="flagged" value="1"
             {% if only_flagged %}checked{% endif %}>
      ğŸš© Only flagged
    </label>
  </div>

  <!-- Submit -->
  <div class="column is-2">
    <button class="button is-link is-fullwidth">Filter</button>
  </div>

</div>
</form>

<!-- ================= TABLE ================= -->
<div class="table-container">
<table class="table is-fullwidth is-striped is-hoverable">

<thead>
<tr>
  <th>ID</th>
  <th>Question</th>
  <th>ğŸ’¬</th>
  <th>ğŸš©</th>
  <th>Status</th>
  <th>Admin</th>
</tr>
</thead>

<tbody>
{% for q in questions %}
<tr>

<td>{{ q.id }}</td>

<td title="Last activity: {{ q.latest_comment }}">
  {{ q.text|truncatechars:70 }}
</td>

<td>{{ q.discussion_count|default:"â€”" }}</td>

<td>
  {% if q.flag_count > 0 %}
    <span class="tag is-danger">{{ q.flag_count }}</span>
  {% else %}â€”{% endif %}
</td>

<td>
  {% if not q.is_active %}
    <span class="tag is-danger">Disabled</span>
  {% elif q.flag_count > 0 %}
    <span class="tag is-warning">Under Review</span>
  {% else %}
    <span class="tag is-success">OK</span>
  {% endif %}
</td>

<td class="is-nowrap">

  <!-- Review -->
  <a href="{% url 'quiz:question_review' q.id %}"
   class="icon-btn icon-review"
   title="Review question"
   target="_blank"
   rel="noopener noreferrer">
  ğŸ§ 
</a>



  <!-- Deactivate / Activate -->
  {% if q.is_active %}
  <form method="post" style="display:inline;">
    {% csrf_token %}
    <input type="hidden" name="disable_question" value="{{ q.id }}">
    <button type="submit"
            class="icon-btn icon-deactivate"
            title="Deactivate question"
            onclick="return confirmDeactivate();">
      ğŸš«
    </button>
  </form>
  {% else %}
  <form method="post" style="display:inline;">
    {% csrf_token %}
    <input type="hidden" name="enable_question" value="{{ q.id }}">
    <button type="submit"
            class="icon-btn icon-activate"
            title="Activate question">
      âœ…
    </button>
  </form>
  {% endif %}

  <!-- Delete -->
  <form method="post" style="display:inline;">
    {% csrf_token %}
    <input type="hidden" name="delete_question" value="{{ q.id }}">
    <button type="submit"
            class="icon-btn icon-delete"
            title="Delete permanently"
            onclick="return confirmDelete();">
      ğŸ—‘ï¸
    </button>
  </form>

</td>



</tr>
{% empty %}
<tr>
  <td colspan="6" class="has-text-centered has-text-grey">
    No questions found
  </td>
</tr>
{% endfor %}
</tbody>

</table>
</div>

</div>
</section>

<script>
function confirmDeactivate() {
  return confirm(
    "Are you sure you want to deactivate this question?\n\n" +
    "Users will no longer see it, but it can be re-enabled later."
  );
}

function confirmDelete() {
  return confirm(
    "âš ï¸ PERMANENT DELETE âš ï¸\n\n" +
    "This action cannot be undone.\n\n" +
    "Are you absolutely sure?"
  );
}
</script>

{% endblock %}
