{% extends "quiz/base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}
<div class="container py-5">
  <!-- HEADER -->
  <div class="mb-6">
    <nav class="breadcrumb" aria-label="breadcrumbs">
      <ul>
        <li><a href="{% url 'quiz:question_dashboard' %}">Dashboard</a></li>
        <li class="is-active"><a href="#" aria-current="page">Add Question</a></li>
      </ul>
    </nav>
    
    <div class="is-flex is-justify-content-space-between is-align-items-center mb-4">
      <h1 class="title is-3 has-text-weight-semibold">‚ûï Add New Question</h1>
      <span class="tag is-info is-light">Multiple Choice</span>
    </div>
    <p class="subtitle is-6 has-text-grey">Create a new question with detailed explanations</p>
  </div>

  <form method="post" id="question-form">
    {% csrf_token %}

    <!-- QUESTION CARD -->
    <div class="card mb-5">
      <header class="card-header">
        <p class="card-header-title">
          <span class="icon-text">
            <span class="icon">
              <i class="fas fa-question-circle"></i>
            </span>
            <span>Question Details</span>
          </span>
        </p>
      </header>
      <div class="card-content">
        <!-- Loop through all form fields except explanation -->
        {% for field in form %}
          {% if field.name != 'explanation' %}
          <div class="field mb-4">
            <label class="label" for="{{ field.id_for_label }}">
              {{ field.label }}
              {% if field.field.required %}
              <span class="has-text-danger">*</span>
              {% endif %}
            </label>
            <div class="control">
              {% if field.errors %}
                {% render_field field class+="input is-danger" placeholder=field.help_text %}
              {% else %}
                {% render_field field class+="input" placeholder=field.help_text %}
              {% endif %}
            </div>
            {% if field.help_text %}
            <p class="help">{{ field.help_text }}</p>
            {% endif %}
            {% if field.errors %}
            <p class="help is-danger">{{ field.errors.0 }}</p>
            {% endif %}
          </div>
          {% endif %}
        {% endfor %}

        <!-- EXPLANATION FIELD WITH RICH TEXT EDITOR -->
        {% with field=form.explanation %}
        <div class="field mb-4">
          <label class="label" for="{{ field.id_for_label }}">
            {{ field.label }}
            <span class="tag is-light is-small ml-2">Supports formatting</span>
          </label>
          
          <!-- Formatting Toolbar -->
          <div class="field">
            <div class="buttons are-small mb-2" id="formatting-toolbar">
              <button type="button" class="button is-light" data-command="bold" title="Bold">
                <span class="icon">
                  <i class="fas fa-bold"></i>
                </span>
              </button>
              <button type="button" class="button is-light" data-command="italic" title="Italic">
                <span class="icon">
                  <i class="fas fa-italic"></i>
                </span>
              </button>
              <button type="button" class="button is-light" data-command="underline" title="Underline">
                <span class="icon">
                  <i class="fas fa-underline"></i>
                </span>
              </button>
              <div class="dropdown is-hoverable">
                <div class="dropdown-trigger">
                  <button type="button" class="button is-light" aria-haspopup="true" aria-controls="heading-menu">
                    <span class="icon">
                      <i class="fas fa-heading"></i>
                    </span>
                    <span>Heading</span>
                    <span class="icon is-small">
                      <i class="fas fa-angle-down" aria-hidden="true"></i>
                    </span>
                  </button>
                </div>
                <div class="dropdown-menu" id="heading-menu" role="menu">
                  <div class="dropdown-content">
                    <a href="#" class="dropdown-item" data-command="h2">Heading 2</a>
                    <a href="#" class="dropdown-item" data-command="h3">Heading 3</a>
                    <a href="#" class="dropdown-item" data-command="h4">Heading 4</a>
                  </div>
                </div>
              </div>
              <button type="button" class="button is-light" data-command="insertUnorderedList" title="Bullet List">
                <span class="icon">
                  <i class="fas fa-list-ul"></i>
                </span>
              </button>
              <button type="button" class="button is-light" data-command="insertOrderedList" title="Numbered List">
                <span class="icon">
                  <i class="fas fa-list-ol"></i>
                </span>
              </button>
              <button type="button" class="button is-light" data-command="createLink" title="Insert Link">
                <span class="icon">
                  <i class="fas fa-link"></i>
                </span>
              </button>
              <button type="button" class="button is-light" data-command="insertHorizontalRule" title="Horizontal Line">
                <span class="icon">
                  <i class="fas fa-minus"></i>
                </span>
              </button>
              <button type="button" class="button is-light" data-command="removeFormat" title="Clear Formatting">
                <span class="icon">
                  <i class="fas fa-eraser"></i>
                </span>
              </button>
            </div>
          </div>
          
          <!-- Rich Text Editor -->
          <div class="control">
            <div class="rich-text-editor box p-0" style="min-height: 200px;">
              {% if field.errors %}
                {% render_field field class+="textarea is-danger" placeholder="Enter detailed explanation with formatting..." rows="8" %}
              {% else %}
                {% render_field field class+="textarea" placeholder="Enter detailed explanation with formatting..." rows="8" %}
              {% endif %}
            </div>
          </div>
          
          <!-- Preview Area -->
          <div class="box mt-3 is-hidden" id="preview-area">
            <div class="is-flex is-justify-content-space-between is-align-items-center mb-2">
              <p class="has-text-weight-semibold">Preview:</p>
              <button type="button" class="delete" id="close-preview"></button>
            </div>
            <div class="content" id="preview-content">
              <!-- Preview will be inserted here -->
            </div>
          </div>
          
          <!-- Editor Actions -->
          <div class="field is-grouped is-grouped-multiline mt-3">
            <div class="control">
              <button type="button" class="button is-small is-info is-light" id="preview-btn">
                <span class="icon is-small">
                  <i class="fas fa-eye"></i>
                </span>
                <span>Preview</span>
              </button>
            </div>
            <div class="control">
              <button type="button" class="button is-small is-light" id="clear-btn">
                <span class="icon is-small">
                  <i class="fas fa-broom"></i>
                </span>
                <span>Clear</span>
              </button>
            </div>
          </div>
          
          <!-- Help Text -->
          <div class="notification is-light mt-3">
            <div class="content is-small">
              <p class="has-text-weight-semibold mb-1">Formatting Tips:</p>
              <ul>
                <li>Use headings to structure your explanation</li>
                <li>Add bullet or numbered lists for steps or key points</li>
                <li>Use <strong>bold</strong> or <em>italic</em> for emphasis</li>
                <li>Insert links to reference materials</li>
                <li>Add horizontal lines to separate sections</li>
              </ul>
            </div>
          </div>
          
          {% if field.help_text %}
          <p class="help">{{ field.help_text }}</p>
          {% endif %}
          {% if field.errors %}
          <p class="help is-danger">{{ field.errors.0 }}</p>
          {% endif %}
        </div>
        {% endwith %}
      </div>
    </div>

    <!-- CHOICES CARD -->
    <div class="card mb-5">
      <header class="card-header">
        <p class="card-header-title">
          <span class="icon-text">
            <span class="icon">
              <i class="fas fa-list-check"></i>
            </span>
            <span>Answer Choices</span>
          </span>
        </p>
        <button class="card-header-icon" type="button" id="add-choice-btn">
          <span class="icon has-text-info">
            <i class="fas fa-plus-circle"></i>
          </span>
        </button>
      </header>
      <div class="card-content">
        <div class="notification is-info is-light mb-4">
          <div class="content is-small">
            <p class="has-text-weight-semibold mb-1">Instructions:</p>
            <ul>
              <li>‚úÖ Check all correct answers (multiple allowed)</li>
              <li>üìä Set display order (lower numbers show first)</li>
              <li>üóëÔ∏è Mark for deletion if needed</li>
              <li>‚ûï Fill empty rows to add more choices</li>
            </ul>
          </div>
        </div>

        {{ choice_formset.management_form }}
        
        <div class="table-container">
          <table class="table is-fullwidth is-hoverable" id="choices-table">
            <thead>
              <tr class="has-background-light">
                <th class="has-text-weight-semibold">Choice Text <span class="has-text-danger">*</span></th>
                <th class="has-text-weight-semibold has-text-centered" width="120">Correct?</th>
                <th class="has-text-weight-semibold has-text-centered" width="100">Order</th>
                <th class="has-text-weight-semibold has-text-centered" width="100">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for cform in choice_formset %}
              <tr class="choice-row {% if forloop.counter0|divisibleby:2 %}has-background-white-bis{% endif %}" 
                  data-index="{{ forloop.counter0 }}">
                <td>
                  <div class="field">
                    <div class="control">
                      {% if cform.text.errors %}
                        {% render_field cform.text class+="input is-small is-danger" placeholder="Enter choice text" %}
                      {% else %}
                        {% render_field cform.text class+="input is-small" placeholder="Enter choice text" %}
                      {% endif %}
                      {{ cform.id }}
                    </div>
                    {% if cform.text.errors %}
                    <p class="help is-danger">{{ cform.text.errors.0 }}</p>
                    {% endif %}
                  </div>
                </td>
                <td class="has-text-centered is-vcentered">
                  <div class="field">
                    <div class="control">
                      <label class="checkbox" style="display: block; margin: 0 auto; width: fit-content;">
                        {% render_field cform.is_correct %}
                        <span class="checkmark"></span>
                      </label>
                    </div>
                  </div>
                </td>
                <td class="has-text-centered is-vcentered">
                  <div class="field">
                    <div class="control">
                      {% render_field cform.order class+="input is-small has-text-centered" style="width: 70px;" %}
                    </div>
                  </div>
                </td>
                <td class="has-text-centered is-vcentered">
                  <div class="field">
                    <div class="control">
                      <label class="checkbox" style="display: block; margin: 0 auto; width: fit-content;">
                        {% render_field cform.DELETE class="delete-checkbox" %}
                        <span class="checkmark delete"></span>
                      </label>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="notification is-warning is-light mt-4 is-hidden" id="no-correct-warning">
          <div class="icon-text">
            <span class="icon">
              <i class="fas fa-exclamation-triangle"></i>
            </span>
            <span>No correct answers selected. At least one choice must be marked as correct.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- FORM VALIDATION SUMMARY -->
    {% if form.errors or choice_formset.errors %}
    <div class="notification is-danger is-light mb-5">
      <div class="content">
        <p class="has-text-weight-semibold">Please fix the following errors:</p>
        <ul>
          {% for field, errors in form.errors.items %}
            {% for error in errors %}
              <li>{{ field|title }}: {{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for form in choice_formset %}
            {% for field, errors in form.errors.items %}
              {% for error in errors %}
                <li>Choice {{ forloop.parentloop.counter }}: {{ field|title }} - {{ error }}</li>
              {% endfor %}
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

    <!-- ACTION BUTTONS -->
    <div class="field is-grouped is-grouped-centered mt-6 pt-5 border-top">
      <div class="control">
        <a href="{% url 'quiz:question_dashboard' %}" class="button is-light is-medium">
          <span class="icon">
            <i class="fas fa-arrow-left"></i>
          </span>
          <span>Cancel</span>
        </a>
      </div>
      <div class="control">
        <button type="submit" class="button is-primary is-medium">
          <span class="icon">
            <i class="fas fa-save"></i>
          </span>
          <span>Save Question</span>
        </button>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
.border-top {
  border-top: 1px solid #dbdbdb;
}

.table td.is-vcentered {
  vertical-align: middle;
}

.choice-row:hover {
  background-color: #f9f9f9 !important;
}

/* Custom checkbox styling */
.checkbox {
  position: relative;
  cursor: pointer;
}

.checkbox input[type="checkbox"] {
  opacity: 0;
  position: absolute;
  width: 100%;
  height: 100%;
  z-index: 2;
  cursor: pointer;
  margin: 0;
}

.checkmark {
  position: relative;
  display: inline-block;
  width: 20px;
  height: 20px;
  background-color: #fff;
  border: 2px solid #dbdbdb;
  border-radius: 3px;
  transition: all 0.2s;
}

.checkmark.delete {
  background-color: #f5f5f5;
}

.checkbox input[type="checkbox"]:checked + .checkmark {
  background-color: #3273dc;
  border-color: #3273dc;
}

.checkbox input[type="checkbox"]:checked + .checkmark.delete {
  background-color: #f14668;
  border-color: #f14668;
}

.checkbox input[type="checkbox"]:checked + .checkmark::after {
  content: "‚úì";
  position: absolute;
  color: white;
  font-size: 14px;
  font-weight: bold;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}

.checkbox:hover .checkmark {
  border-color: #b5b5b5;
}

.checkbox input[type="checkbox"]:focus + .checkmark {
  box-shadow: 0 0 0 0.125em rgba(50, 115, 220, 0.25);
}

/* Deleted row styling */
.choice-row.deleted {
  opacity: 0.6;
  background-color: #f5f5f5 !important;
}

.choice-row.deleted td {
  text-decoration: line-through;
  color: #7a7a7a;
}

/* Rich Text Editor Styles */
.rich-text-editor .textarea {
  min-height: 200px;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 14px;
  border: none;
  resize: vertical;
}

#formatting-toolbar {
  border-bottom: 1px solid #dbdbdb;
  padding-bottom: 0.5rem;
  margin-bottom: 0.5rem;
}

#formatting-toolbar .button.is-light:hover {
  background-color: #e8e8e8;
}

#formatting-toolbar .button.is-light.active {
  background-color: #3273dc;
  color: white;
}

/* Preview styles */
#preview-content h2 {
  font-size: 1.5em;
  font-weight: 600;
  margin: 1.5em 0 0.5em 0;
  padding-bottom: 0.3em;
  border-bottom: 1px solid #eaecef;
}

#preview-content h3 {
  font-size: 1.25em;
  font-weight: 600;
  margin: 1.25em 0 0.5em 0;
}

#preview-content h4 {
  font-size: 1.1em;
  font-weight: 600;
  margin: 1em 0 0.5em 0;
}

#preview-content ul, #preview-content ol {
  margin-left: 1.5em;
  margin-bottom: 1em;
}

#preview-content li {
  margin-bottom: 0.25em;
}

#preview-content a {
  color: #3273dc;
  text-decoration: underline;
}

#preview-content hr {
  height: 1px;
  background-color: #dbdbdb;
  border: none;
  margin: 1.5em 0;
}

.card-header-icon:hover {
  background-color: transparent !important;
}

/* Ensure table is responsive on mobile */
@media screen and (max-width: 768px) {
  .table-container {
    overflow-x: auto;
  }
  
  #choices-table {
    min-width: 600px;
  }
  
  .field.is-grouped {
    flex-direction: column;
    gap: 1rem;
  }
  
  .field.is-grouped .control {
    width: 100%;
  }
  
  .field.is-grouped .button {
    width: 100%;
  }
  
  #formatting-toolbar .button .icon-text span:not(.icon) {
    display: none;
  }
  
  #formatting-toolbar .button {
    padding: 0.25em 0.5em;
  }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ============= RICH TEXT EDITOR FUNCTIONALITY =============
  const explanationField = document.getElementById('{{ form.explanation.id_for_label }}');
  const formattingToolbar = document.getElementById('formatting-toolbar');
  const previewBtn = document.getElementById('preview-btn');
  const clearBtn = document.getElementById('clear-btn');
  const previewArea = document.getElementById('preview-area');
  const previewContent = document.getElementById('preview-content');
  const closePreview = document.getElementById('close-preview');
  
  // Formatting button handler
  if (formattingToolbar && explanationField) {
    formattingToolbar.addEventListener('click', function(e) {
      const button = e.target.closest('button[data-command], .dropdown-item');
      if (!button) return;
      
      e.preventDefault();
      
      const command = button.dataset.command;
      if (!command) return;
      
      // Focus on the textarea first
      explanationField.focus();
      
      // Handle special commands
      if (command === 'createLink') {
        const url = prompt('Enter URL:', 'https://');
        if (url) {
          document.execCommand('createLink', false, url);
        }
      } else if (command === 'h2' || command === 'h3' || command === 'h4') {
        // For headings, we need to wrap selection
        const selection = window.getSelection().toString();
        if (selection) {
          // Save current selection
          const start = explanationField.selectionStart;
          const end = explanationField.selectionEnd;
          
          // Get current text
          const text = explanationField.value;
          
          // Wrap selection with heading
          const before = text.substring(0, start);
          const selected = text.substring(start, end);
          const after = text.substring(end);
          
          const tag = command; // h2, h3, h4
          const wrapped = `<${tag}>${selected}</${tag}>`;
          
          explanationField.value = before + wrapped + after;
          
          // Restore cursor position
          explanationField.selectionStart = start + wrapped.length;
          explanationField.selectionEnd = start + wrapped.length;
        }
      } else {
        // Execute standard command
        document.execCommand(command, false, null);
        
        // For textarea, we need to handle formatting differently
        if (command === 'bold' || command === 'italic' || command === 'underline') {
          const start = explanationField.selectionStart;
          const end = explanationField.selectionEnd;
          
          if (start === end) return; // No selection
          
          const text = explanationField.value;
          const before = text.substring(0, start);
          const selected = text.substring(start, end);
          const after = text.substring(end);
          
          let wrapped;
          if (command === 'bold') {
            wrapped = `<strong>${selected}</strong>`;
          } else if (command === 'italic') {
            wrapped = `<em>${selected}</em>`;
          } else if (command === 'underline') {
            wrapped = `<u>${selected}</u>`;
          }
          
          explanationField.value = before + wrapped + after;
          
          // Restore cursor position
          explanationField.selectionStart = start + wrapped.length;
          explanationField.selectionEnd = start + wrapped.length;
        }
      }
      
      // Update button active state
      if (button.classList.contains('button')) {
        formattingToolbar.querySelectorAll('.button').forEach(btn => {
          btn.classList.remove('active');
        });
        button.classList.add('active');
        
        // Remove active class after a moment
        setTimeout(() => {
          button.classList.remove('active');
        }, 300);
      }
      
      // Trigger input event for any listeners
      explanationField.dispatchEvent(new Event('input', { bubbles: true }));
    });
  }
  
  // Preview functionality
  if (previewBtn && previewContent) {
    previewBtn.addEventListener('click', function() {
      const content = explanationField.value;
      
      // Convert basic HTML tags for preview
      let preview = content
        .replace(/<strong>(.*?)<\/strong>/g, '<strong>$1</strong>')
        .replace(/<em>(.*?)<\/em>/g, '<em>$1</em>')
        .replace(/<u>(.*?)<\/u>/g, '<u>$1</u>')
        .replace(/<h2>(.*?)<\/h2>/g, '<h2>$1</h2>')
        .replace(/<h3>(.*?)<\/h3>/g, '<h3>$1</h3>')
        .replace(/<h4>(.*?)<\/h4>/g, '<h4>$1</h4>')
        .replace(/<ul>(.*?)<\/ul>/gs, '<ul>$1</ul>')
        .replace(/<ol>(.*?)<\/ol>/gs, '<ol>$1</ol>')
        .replace(/<li>(.*?)<\/li>/g, '<li>$1</li>')
        .replace(/<a href="(.*?)">(.*?)<\/a>/g, '<a href="$1">$2</a>')
        .replace(/<hr>/g, '<hr>')
        .replace(/\n/g, '<br>');
      
      // Handle nested lists
      preview = preview.replace(/<ul>[\s\S]*?<\/ul>/g, function(match) {
        return match.replace(/<br>/g, '');
      });
      
      previewContent.innerHTML = preview || '<p class="has-text-grey">No content to preview</p>';
      previewArea.classList.remove('is-hidden');
      
      // Scroll to preview
      previewArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });
  }
  
  // Clear editor
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      if (confirm('Clear all content in the explanation editor?')) {
        explanationField.value = '';
        explanationField.focus();
      }
    });
  }
  
  // Close preview
  if (closePreview) {
    closePreview.addEventListener('click', function() {
      previewArea.classList.add('is-hidden');
    });
  }
  
  // ============= CHOICE FORM SET FUNCTIONALITY =============
  const addButton = document.getElementById('add-choice-btn');
  const tableBody = document.querySelector('#choices-table tbody');
  const totalForms = document.getElementById('id_choices-TOTAL_FORMS');
  const warningDiv = document.getElementById('no-correct-warning');
  
  // Get the next available index
  function getNextIndex() {
    let maxIndex = -1;
    document.querySelectorAll('.choice-row').forEach(row => {
      const index = parseInt(row.dataset.index);
      if (index > maxIndex) maxIndex = index;
    });
    return maxIndex + 1;
  }
  
  // Clone the last row template
  function getEmptyRowTemplate(index) {
    return `
      <tr class="choice-row ${index % 2 === 0 ? 'has-background-white-bis' : ''}" data-index="${index}">
        <td>
          <div class="field">
            <div class="control">
              <input type="text" name="choices-${index}-text" 
                     class="input is-small" placeholder="Enter choice text" 
                     maxlength="200" id="id_choices-${index}-text">
              <input type="hidden" name="choices-${index}-id" id="id_choices-${index}-id">
            </div>
          </div>
        </td>
        <td class="has-text-centered is-vcentered">
          <div class="field">
            <div class="control">
              <label class="checkbox" style="display: block; margin: 0 auto; width: fit-content;">
                <input type="checkbox" name="choices-${index}-is_correct" 
                       id="id_choices-${index}-is_correct">
                <span class="checkmark"></span>
              </label>
            </div>
          </div>
        </td>
        <td class="has-text-centered is-vcentered">
          <div class="field">
            <div class="control">
              <input type="number" name="choices-${index}-order" 
                     value="${index + 1}" class="input is-small has-text-centered" 
                     style="width: 70px;" id="id_choices-${index}-order">
            </div>
          </div>
        </td>
        <td class="has-text-centered is-vcentered">
          <div class="field">
            <div class="control">
              <label class="checkbox" style="display: block; margin: 0 auto; width: fit-content;">
                <input type="checkbox" name="choices-${index}-DELETE" 
                       class="delete-checkbox" id="id_choices-${index}-DELETE">
                <span class="checkmark delete"></span>
              </label>
            </div>
          </div>
        </td>
      </tr>
    `;
  }
  
  // Add new choice row
  if (addButton) {
    addButton.addEventListener('click', function() {
      const index = getNextIndex();
      tableBody.insertAdjacentHTML('beforeend', getEmptyRowTemplate(index));
      totalForms.value = index + 1;
      attachDeleteListeners();
      attachCheckboxListeners();
      validateCorrectAnswers();
    });
  }
  
  // Update checkbox state based on hidden input
  function updateCheckboxState() {
    document.querySelectorAll('.choice-row').forEach(row => {
      const index = row.dataset.index;
      const isCorrectCheckbox = row.querySelector(`input[name="choices-${index}-is_correct"]`);
      const deleteCheckbox = row.querySelector(`input[name="choices-${index}-DELETE"]`);
      
      // Check if there's a hidden input with the value
      const isCorrectHidden = document.querySelector(`input[name="choices-${index}-is_correct"][type="hidden"]`);
      if (isCorrectHidden && isCorrectCheckbox) {
        isCorrectCheckbox.checked = isCorrectHidden.value === 'True' || isCorrectHidden.value === 'on';
      }
      
      const deleteHidden = document.querySelector(`input[name="choices-${index}-DELETE"][type="hidden"]`);
      if (deleteHidden && deleteCheckbox) {
        deleteCheckbox.checked = deleteHidden.value === 'True' || deleteHidden.value === 'on';
        if (deleteCheckbox.checked) {
          row.classList.add('deleted');
        }
      }
    });
  }
  
  // Attach delete listeners
  function attachDeleteListeners() {
    document.querySelectorAll('.delete-checkbox').forEach(checkbox => {
      checkbox.removeEventListener('change', handleDeleteChange);
      checkbox.addEventListener('change', handleDeleteChange);
    });
  }
  
  function handleDeleteChange() {
    const row = this.closest('tr');
    if (this.checked) {
      row.classList.add('deleted');
    } else {
      row.classList.remove('deleted');
    }
    validateCorrectAnswers();
  }
  
  // Attach checkbox listeners for is_correct
  function attachCheckboxListeners() {
    document.querySelectorAll('input[name$="-is_correct"]').forEach(checkbox => {
      checkbox.removeEventListener('change', validateCorrectAnswers);
      checkbox.addEventListener('change', validateCorrectAnswers);
    });
  }
  
  // Validate at least one correct answer
  function validateCorrectAnswers() {
    const checkboxes = document.querySelectorAll('input[name$="-is_correct"]');
    const deleteCheckboxes = document.querySelectorAll('input[name$="-DELETE"]');
    let hasCorrect = false;
    
    checkboxes.forEach((cb, index) => {
      const row = cb.closest('tr');
      const deleteCb = row ? row.querySelector('input[name$="-DELETE"]') : null;
      if (cb.checked && (!deleteCb || !deleteCb.checked)) {
        hasCorrect = true;
      }
    });
    
    if (warningDiv) {
      warningDiv.classList.toggle('is-hidden', hasCorrect);
    }
    
    return hasCorrect;
  }
  
  // Form submission validation
  const form = document.getElementById('question-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      if (!validateCorrectAnswers()) {
        e.preventDefault();
        warningDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        warningDiv.classList.remove('is-hidden');
        return false;
      }
    });
  }
  
  // ============= INITIALIZATION =============
  updateCheckboxState();
  attachDeleteListeners();
  attachCheckboxListeners();
  validateCorrectAnswers();
});
</script>
{% endblock %}