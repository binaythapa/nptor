{% extends "layouts/base.html" %}
{% block title %}Question Review{% endblock %}

{% block content %}
<section class="section">
<div class="container" style="max-width: 900px;">

<h1 class="title is-4">ğŸ§  Question Review</h1>

<!-- ================= QUESTION ================= -->
<div class="box">
  <p class="has-text-weight-semibold">{{ question.text }}</p>

  <p class="is-size-7 has-text-grey mt-1">
    {{ question.category }} Â· {{ question.difficulty }} Â· {{ question.question_type }}
  </p>

  <button class="button is-small is-link mt-2"
          onclick="openEditModal()">
    âœï¸ Edit Question
  </button>

  {% if question.explanation %}
    <hr>
    <p class="is-size-7 has-text-grey">Explanation</p>
    <div class="content is-small">
      {{ question.explanation|linebreaks }}
    </div>
  {% endif %}
</div>

<!-- ================= CHOICES ================= -->
<div class="box">
  <p class="has-text-weight-semibold mb-2">Choices</p>
  {% for c in question.choices.all %}
    <p>
      {% if c.is_correct %}
        <span class="has-text-success">âœ”</span>
      {% else %}
        <span class="has-text-grey">âœ–</span>
      {% endif %}
      {{ c.text }}
    </p>
  {% endfor %}
</div>

<!-- ================= QUESTION ACTIONS ================= -->
<div class="box">
  <div class="buttons">
    <button class="button is-small is-warning"
            onclick="toggleQuestion({{ question.id }})">
      {% if question.is_active %}Deactivate{% else %}Activate{% endif %}
    </button>

    {% if request.user.is_superuser %}
      <button class="button is-small is-danger is-light"
              onclick="deleteQuestion({{ question.id }})">
        Delete
      </button>
    {% endif %}
  </div>
</div>

<!-- ================= DISCUSSIONS ================= -->
<div class="box">
  <p class="has-text-weight-semibold mb-2">
    ğŸš© User Feedback & Issues ({{ discussions.count }})
  </p>

  {% for d in discussions %}
    <div id="discussion-{{ d.id }}"
         class="mb-3 p-2 {% if d.is_resolved %}has-background-success-light{% endif %}"
         style="border-left:4px solid
           {% if d.is_pinned %}#3b82f6
           {% elif d.is_answer_incorrect %}#f97316
           {% else %}#e5e7eb{% endif %};">

      <p class="is-size-7 has-text-grey">
        {{ d.user }} Â· {{ d.created_at|date:"M d, Y" }}
        Â· {{ d.discussion_type }}
        {% if d.severity %}Â· {{ d.severity }}{% endif %}
      </p>

      <p class="mt-1">{{ d.content }}</p>

      <div class="buttons mt-2">

        {% if not d.is_resolved %}
          <button class="button is-small is-success"
                  onclick="resolveDiscussion({{ d.id }})">
            âœ… Resolve
          </button>
        {% else %}
          <span class="tag is-success is-light">Resolved</span>
        {% endif %}

        <button class="button is-small is-success is-light"
                onclick="verifyDiscussion({{ d.id }})">
          âœ” Verify
        </button>

        <button class="button is-small is-info is-light"
                onclick="pinDiscussion({{ d.id }})">
          ğŸ“Œ Pin
        </button>

        <button class="button is-small is-danger is-light"
                onclick="deleteDiscussion({{ d.id }})">
          ğŸ—‘ Remove
        </button>

      </div>
    </div>
  {% empty %}
    <p class="has-text-grey is-size-7">No feedback yet</p>
  {% endfor %}
</div>

</div>
</section>

<!-- ================= EDIT MODAL ================= -->
<div class="modal" id="editModal">
  <div class="modal-background" onclick="closeEditModal()"></div>

  <div class="modal-card" style="width:95%; max-width:900px;">
    <header class="modal-card-head">
      <p class="modal-card-title">Edit Question</p>
      <button class="delete" onclick="closeEditModal()"></button>
    </header>

    <section class="modal-card-body" id="editModalBody">
      <!-- edit_question.html loads here -->
    </section>
  </div>
</div>

{% include "questions/review_ajax.html" %}
{% endblock %}
